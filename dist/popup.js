(()=>{document.getElementById("kills"),document.getElementById("deaths"),document.getElementById("matches"),document.getElementById("matches-list");const e=document.getElementById("statsBtn"),t=document.getElementById("hudBtn"),n=document.getElementById("statsSection"),a=document.getElementById("hudSection");n.classList.add("active"),e.addEventListener("click",(()=>{e.classList.add("selected"),t.classList.remove("selected"),n.style.display="block",a.style.display="none"})),t.addEventListener("click",(()=>{t.classList.add("selected"),e.classList.remove("selected"),n.style.display="none",a.style.display="block"}));const o=document.getElementById("toggleDeathsHud"),s=document.getElementById("toggleKillStreakHud");function l(e){return e?new Date(e).toLocaleString(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit",year:"2-digit",month:"2-digit",day:"2-digit"}):"-"}function i(e,t){return 0===t?e>0?e.toFixed(2):"0.00":(e/t).toFixed(2)}function c(e){const t=Math.floor(e/1e3),n=Math.floor(t/3600),a=Math.floor(t%3600/60),o=t%60;return n>0?`${n}h ${a}m ${o}s`:a>0?`${a}m ${o}s`:`${o}s`}o.addEventListener("change",(function(){const e=this.checked;chrome.storage.sync.set({deathsHudEnabled:e}),chrome.tabs.query({active:!0,currentWindow:!0},(t=>{chrome.tabs.sendMessage(t[0].id,{type:"toggle-deaths-hud",enabled:e})}))})),s.addEventListener("change",(function(){const e=this.checked;chrome.storage.sync.set({killStreakHudEnabled:e}),chrome.tabs.query({active:!0,currentWindow:!0},(t=>{chrome.tabs.sendMessage(t[0].id,{type:"toggle-killstreak-hud",enabled:e})}))})),chrome.storage.sync.get(["deathsHudEnabled","killStreakHudEnabled"],(e=>{o.checked=!1!==e.deathsHudEnabled,s.checked=!1!==e.killStreakHudEnabled,chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{type:"toggle-deaths-hud",enabled:o.checked}),chrome.tabs.sendMessage(e[0].id,{type:"toggle-killstreak-hud",enabled:s.checked})}))}));let d="Default",m="normal",r="all",u={primaryStats:!1,secondaryStats:!1,averageStats:!1,streaks:!1,quickKills:!1};function h(e,t,n){const a=n||m;return"all"===a?null:`${e}_${t}_${a}`}function g(){document.getElementById("normalModeBtn").classList.toggle("selected","normal"===m),document.getElementById("specialModeBtn").classList.toggle("selected","special"===m),document.getElementById("customModeBtn").classList.toggle("selected","custom"===m),document.getElementById("allStatsBtn").classList.toggle("selected","all"===m),document.getElementById("primaryStatsHeader").textContent="all"===m?"All Modes Primary Stats":"Primary Stats",document.getElementById("secondaryStatsHeader").textContent="all"===m?"All Modes Secondary Stats":"Secondary Stats"}function p(e,t){let n=[],a=new Map;"all"===t?["normal","special","custom"].forEach((t=>{const o=e[h("matchHistory",d,t)]||[];n=n.concat(o),o.forEach((e=>{if(e.map){const t=a.get(e.map)||0;a.set(e.map,t+1)}}))})):(n=e[h("matchHistory",d,t)]||[],n.forEach((e=>{if(e.map){const t=a.get(e.map)||0;a.set(e.map,t+1)}})));const o=document.getElementById("mapFilter"),s=o.value||"all";o.innerHTML='<option value="all">All Maps</option>',Array.from(a.entries()).sort(((e,t)=>t[1]-e[1])).forEach((([e,t])=>{const n=document.createElement("option");n.value=e,n.textContent=e,o.appendChild(n)})),[...o.options].some((e=>e.value===s))?(o.value=s,r=s):(o.value="all",r="all");const l="all"===r?n:n.filter((e=>e.map===r));let m=0,u=0,g=0;l.forEach((e=>{m+=e.kills||0,u+=e.deaths||0,g+=e.duration||(e.matchEndTime&&e.matchStartTime?e.matchEndTime-e.matchStartTime:0)}));let p=0;"all"===t?["normal","special","custom"].forEach((t=>{p+=e[h("gamesQuit",d,t)]||0})):p=e[h("gamesQuit",d,t)]||0,console.log("[SKMT][DISPLAY] Current gamesQuit value:",p,"Mode:",t),document.getElementById("gamesQuit").textContent=p;const y=document.getElementById("mapsList");y.innerHTML="";const E=Array.from(a.entries()).sort(((e,t)=>t[1]-e[1]));if(E.forEach((([e,t])=>{const n=document.createElement("div");n.className="stat-card",n.innerHTML=`\n            <span class="stat-label">${e}</span>\n            <span class="stat-value">${t}</span>\n        `,y.appendChild(n)})),0===E.length){const e=document.createElement("div");e.className="no-maps",e.textContent="No maps played yet in this mode",y.appendChild(e)}let S=0,f=0,k=0,v=0,M=0,I=0,T=0,b=0,x=0,w=0,L=0,$=0,H=0,D=0,K=0,A=0,F=0,P=0,R=0,q=0,U=0,z=0;l.forEach((e=>{e.kills>v&&(v=e.kills),e.deaths>M&&(M=e.deaths);const t=e.deaths>0?e.kills/e.deaths:e.kills;t>T&&(T=t);const n=e.duration||(e.matchEndTime&&e.matchStartTime?e.matchEndTime-e.matchStartTime:0);if(n>b&&(b=n),e.killTimestamps&&e.killTimestamps.length>0){let t=0,n=0;const a=[];e.killTimestamps&&e.killTimestamps.forEach((e=>a.push({type:"kill",time:e}))),e.deathTimestamps&&e.deathTimestamps.forEach((e=>a.push({type:"death",time:e}))),a.sort(((e,t)=>e.time-t.time)),a.forEach((e=>{"death"===e.type?(t>n&&(n=t),t=0):"kill"===e.type&&(t++,t>n&&(n=t))})),n>I&&(I=n)}let a=0,o=null,s=0,l={};const i=[];e.killTimestamps&&e.killTimestamps.forEach((e=>i.push({type:"kill",time:e}))),e.deathTimestamps&&e.deathTimestamps.forEach((e=>i.push({type:"death",time:e}))),i.sort(((e,t)=>e.time-t.time)),i.forEach((e=>{"death"===e.type?(a=0,l={},s=0):"kill"===e.type&&(a++,a>=3&&!l[3]&&(x++,l[3]=!0),a>=5&&!l[5]&&(w++,l[5]=!0),a>=7&&!l[7]&&(L++,l[7]=!0),a>=10&&!l[10]&&($++,l[10]=!0),a>=15&&!l[15]&&(H++,l[15]=!0),a>=20&&!l[20]&&(D++,l[20]=!0),a>=25&&!l[25]&&(K++,l[25]=!0),a>=30&&!l[30]&&(A++,l[30]=!0),o&&e.time-o<=4e3?(s++,2===s&&F++,3===s&&P++,4===s&&R++,5===s&&q++,6===s&&U++,7===s&&z++):s=1,o=e.time)})),e.joined&&S++,e.started&&f++,e.quit&&p++,e.quit||k++})),document.getElementById("highestKillsRecord").textContent=v,document.getElementById("highestDeathsRecord").textContent=M,document.getElementById("highestKillStreakRecord").textContent=I,document.getElementById("highestKDRRecord").textContent=T.toFixed(2),document.getElementById("longestTimePlayedRecord").textContent=c(b),document.getElementById("smashStreak").textContent=x,document.getElementById("smashtacularStreak").textContent=w,document.getElementById("smashosaurusStreak").textContent=L,document.getElementById("smashlvaniaStreak").textContent=$,document.getElementById("monsterSmashStreak").textContent=H,document.getElementById("potatoStreak").textContent=D,document.getElementById("smashSmashStreak").textContent=K,document.getElementById("potoatachioStreak").textContent=A,document.getElementById("doubleSmash").textContent=F,document.getElementById("multiSmash").textContent=P,document.getElementById("multiMegaSmash").textContent=R,document.getElementById("multiMegaUltraSmash").textContent=q,document.getElementById("gooseySmash").textContent=U,document.getElementById("crazyMultiMegaUltraSmash").textContent=z,document.getElementById("streaksHeader").textContent="all"===t?"All Modes Streaks (Without Dying)":"Streaks (Without Dying)",document.getElementById("quickKillsHeader").textContent="all"===t?"All Modes Streaks (Quick Kills)":"Streaks (Quick Kills)";const N=(k||0)+(p||0);document.getElementById("killsLabel").textContent="all"===t?"Total Kills":"Kills",document.getElementById("deathsLabel").textContent="all"===t?"Total Deaths":"Deaths",document.getElementById("kdrLabel").textContent="all"===t?"Overall KDR":"KDR",document.getElementById("matchesCompletedLabel").textContent="all"===t?"Total Matches Completed":"Matches Completed",document.getElementById("totalTimeSpentLabel").textContent="all"===t?"Total Time Played":"Time Played",document.getElementById("gamesJoinedLabel").textContent="all"===t?"Total Matches Joined":"Matches Joined",document.getElementById("totalMatchesLabel").textContent="Total Matches (Completed + Quit)",console.log("[SKMT][POPUP][DISPLAY] Updating gamesQuit display. Value:",p,"Element:",document.getElementById("gamesQuit")),document.getElementById("kills").textContent=m,document.getElementById("deaths").textContent=u,document.getElementById("kdr").textContent=i(m,u),document.getElementById("totalTimeSpent").textContent=c(g),document.getElementById("gamesJoined").textContent=S,document.getElementById("gamesStarted").textContent=f,document.getElementById("gamesQuit").textContent=p,document.getElementById("matchesCompleted").textContent=k,document.getElementById("totalMatches").textContent=N;const _=N>0?(k||0)/N*100:0,O=N>0?(p||0)/N*100:0;document.getElementById("matchesCompletedRate").textContent=`${_.toFixed(2)}%`,document.getElementById("matchesQuitRate").textContent=`${O.toFixed(2)}%`;const Q=l.filter((e=>!e.quit)).length,J=Q>0?m/Q:0,V=Q>0?u/Q:0,j=Q>0?g/Q:0;document.getElementById("avgKills").textContent=J.toFixed(2),document.getElementById("avgDeaths").textContent=V.toFixed(2),document.getElementById("avgTimeSpent").textContent=c(j),document.getElementById("averageStatsHeader").textContent="all"===t?"All Modes Average Stats":"Average Stats",document.getElementById("matches-list").innerHTML="";let W=[];if("all"===t){const t=[];["normal","special","custom"].forEach((n=>{(e[h("matchHistory",d,n)]||[]).forEach((e=>{t.push({...e,mode:n})}))})),W=t}else W=n.slice().reverse();const Y=document.getElementById("matchSortSelect")?document.getElementById("matchSortSelect").value:"recent";"recent"===Y?W.sort(((e,t)=>(t.matchStartTime||0)-(e.matchStartTime||0))):"oldest"===Y?W.sort(((e,t)=>(e.matchStartTime||0)-(t.matchStartTime||0))):"kills"===Y?W.sort(((e,t)=>(t.kills||0)-(e.kills||0))):"favorites"===Y&&(W=W.filter((e=>B[e.matchStartTime])),W.sort(((e,t)=>(t.matchStartTime||0)-(e.matchStartTime||0)))),C(W,t)}function y(){chrome.storage.sync.get(["currentSkid"],(e=>{d=e.currentSkid||"Default",document.getElementById("skidValue").textContent=d;const t=["currentSkid"];"all"===m?["normal","special","custom"].forEach((e=>{t.push(h("matchHistory",d,e)),t.push(h("gamesJoined",d,e)),t.push(h("gamesStarted",d,e)),t.push(h("gamesQuit",d,e)),t.push(h("matchesCompleted",d,e))})):(t.push(h("matchHistory",d,m)),t.push(h("gamesJoined",d,m)),t.push(h("gamesStarted",d,m)),t.push(h("gamesQuit",d,m)),t.push(h("matchesCompleted",d,m))),console.log("[SKMT][LOAD] Loading stats for SKID:",d,"Mode:",m,"Keys:",t),chrome.storage.sync.get(t,(e=>{console.log("[SKMT][LOAD] Data returned from chrome.storage.sync:",e),document.querySelector(".match-history").style.display="block",p(e,m)}))}))}document.addEventListener("DOMContentLoaded",(()=>{document.getElementById("normalModeBtn").addEventListener("click",(()=>{m="normal",g(),y()})),document.getElementById("specialModeBtn").addEventListener("click",(()=>{m="special",g(),y()})),document.getElementById("customModeBtn").addEventListener("click",(()=>{m="custom",g(),y()})),document.getElementById("allStatsBtn").addEventListener("click",(()=>{m="all",g(),y()})),document.querySelectorAll(".stats-details").forEach((e=>{e.addEventListener("toggle",(()=>{document.querySelectorAll(".stats-details").forEach((e=>{const t=e.querySelector(".stats-section-label").id;u[t]=e.hasAttribute("open")})),chrome.storage.local.set({openSections:u})}))})),document.getElementById("exportStatsBtn").addEventListener("click",k),document.getElementById("importStatsBtn").addEventListener("click",(()=>{document.getElementById("importStatsInput").click()})),document.getElementById("importStatsInput").addEventListener("change",(e=>{e.target.files.length>0&&(async function(e){try{const t=new FileReader;t.onload=async function(e){try{const t=(new TextDecoder).decode(e.target.result),n=await async function(e){try{await f();const t=e.match(/^SKMT_ENCRYPTED_v(\d+\.\d+)_(.+)$/);if(!t)throw new Error("Invalid encrypted data format");if(t[1]!==E)throw new Error("Incompatible encryption version");const n=t[2],a=new Uint8Array(atob(n).split("").map((e=>e.charCodeAt(0)))),o=a.slice(0,12),s=a.slice(12),l=await crypto.subtle.decrypt({name:"AES-GCM",iv:o},S,s),i=new TextDecoder;return JSON.parse(i.decode(l))}catch(e){throw console.error("Decryption error:",e),new Error("Failed to decrypt data")}}(t);if(n.skid!==d)throw new Error("Stats file SKID does not match current SKID");const a=31536e6;if(Date.now()-n.timestamp>a)throw new Error("Stats file is too old");if(!confirm("Are you sure you want to import these stats? This will overwrite your current stats."))return;if(await new Promise((e=>{chrome.storage.sync.set(n.data,e)})),n.data.uiState){const e=n.data.uiState;e.currentMode&&(m=e.currentMode,document.querySelectorAll(".mode-btn").forEach((e=>{e.classList.toggle("active",e.dataset.mode===m)}))),e.openSections&&await new Promise((t=>{chrome.storage.local.set({openSections:e.openSections},t)}))}y(),alert("Stats imported successfully!")}catch(e){console.error("Error processing imported stats:",e),alert(e.message||"Failed to import stats. The file may be corrupted or invalid.")}},t.onerror=function(){alert("Error reading file. Please try again.")},t.readAsArrayBuffer(e)}catch(e){console.error("Error importing stats:",e),alert("Failed to import stats. Please try again.")}}(e.target.files[0]),e.target.value="")})),document.getElementById("visualizeStatsBtn").addEventListener("click",(()=>{console.log("[SKMT] Visualize Stats button clicked");const e=document.getElementById("visualizeStatsBtn");e.disabled=!0;try{chrome.runtime.sendMessage({type:"OPEN_VISUALIZERS"},(t=>(e.disabled=!1,chrome.runtime.lastError?(console.error("[SKMT] Error opening visualizers:",chrome.runtime.lastError),void alert("Failed to open visualizers: "+chrome.runtime.lastError.message)):t?t.success?void console.log("[SKMT] Successfully opened visualizers in tab:",t.tabId):(console.error("[SKMT] Failed to open visualizers:",t.error),void alert("Failed to open visualizers: "+(t.error||"Unknown error"))):(console.error("[SKMT] No response received from background script"),void alert("Failed to open visualizers: No response received")))))}catch(t){e.disabled=!1,console.error("[SKMT] Error sending message:",t),alert("Failed to open visualizers: "+t.message)}})),document.getElementById("resetStatsBtn").addEventListener("click",(function(){if(!d)return;const e=[],t="all"===m?["normal","special","custom"]:[m];if(confirm(`Are you sure you want to reset all stats and match history for ${"all"===m?"all modes":"this mode"} and SKID?`)){t.forEach((t=>{e.push(h("matchHistory",d,t)),e.push(h("gamesJoined",d,t)),e.push(h("gamesStarted",d,t)),e.push(h("gamesQuit",d,t)),e.push(h("matchesCompleted",d,t))}));const n={};e.forEach((e=>n[e]=e.includes("matchHistory")?[]:0)),chrome.storage.sync.set(n,(()=>{console.log("[SKMT][RESET] Stats reset for",t,"mode(s)."),y()}))}})),g(),y(),chrome.storage.local.get(["openSections"],(e=>{e.openSections&&(u=e.openSections,Object.entries(u).forEach((([e,t])=>{const n=document.querySelector(`.stats-details:has(#${e})`);n&&(t?n.setAttribute("open",""):n.removeAttribute("open"))})))}))})),chrome.storage.onChanged.addListener(((e,t)=>{"sync"===t&&d&&Object.keys(e).some((e=>e.includes(`_${d}_`)))&&y()})),chrome.runtime.onMessage.addListener((function(e,t,n){if("SKMT_SKID_UPDATED"===e.type)y();else if("SKMT_MATCH_COMPLETE"===e.type){console.log("[SKMT][POPUP] Received MATCH_COMPLETE message:",e.data);const t=e.data,n=t.isSpecialMode?"special":t.isCustomMode?"custom":"normal",a=d||"Default",o=h("gamesQuit",a,n);if(t.quit)chrome.storage.sync.get([o],(e=>{let a=e[o]||0;a++;const s={};s[o]=a,console.log(`[SKMT][POPUP] Incrementing gamesQuit for ${n} mode. New value:`,a),chrome.storage.sync.set(s,(()=>{console.log(`[SKMT][POPUP] Saved quit counter for ${n} mode:`,{quit:t.quit,isSpecialMode:t.isSpecialMode,isCustomMode:t.isCustomMode,gamesQuit:a}),y()}))}));else{const e=h("matchHistory",a,n),o=h("gamesJoined",a,n),s=h("gamesStarted",a,n),l=h("matchesCompleted",a,n);chrome.storage.sync.get([e,o,s,l],(a=>{let i=a[e]||[],c=a[o]||0,d=a[s]||0,m=a[l]||0;i.push(t),t.joined&&c++,t.started&&d++,m++;const r={};r[e]=i,r[o]=c,r[s]=d,r[l]=m,chrome.storage.sync.set(r,(()=>{console.log(`[SKMT][POPUP] Saved completed match data for ${n} mode:`,{quit:t.quit,isSpecialMode:t.isSpecialMode,isCustomMode:t.isCustomMode,savedToHistory:!0}),y()}))}))}}}));const E="1.4";let S=null;async function f(){return S||(S=await async function(){const e=(new TextEncoder).encode("SKMT_SECURE_SALT_v1.4"),t=await crypto.subtle.digest("SHA-256",e);return await crypto.subtle.importKey("raw",t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}()),S}async function k(){try{const e=["normal","special","custom"],t=["currentSkid"];e.forEach((e=>{t.push(h("matchHistory",d,e)),t.push(h("gamesJoined",d,e)),t.push(h("gamesStarted",d,e)),t.push(h("gamesQuit",d,e)),t.push(h("matchesCompleted",d,e))}));const n=await new Promise((e=>{chrome.storage.sync.get(t,e)})),a=await new Promise((e=>{chrome.storage.local.get(["openSections"],e)})),o={};e.forEach((e=>{const t=n[h("matchHistory",d,e)]||[];let a=0,s=0,l=0,i=0,c=0,m=0,r=0,u=0,g=0,p=0,y=0,E=0,S=0,f=0,k=0,v=0,M=0,I=0;t.forEach((e=>{e.kills>=3&&a++,e.kills>=5&&s++,e.kills>=7&&l++,e.kills>=10&&i++,e.kills>=15&&c++,e.kills>=20&&m++,e.kills>=25&&r++,e.kills>=30&&u++,e.kills>k&&(k=e.kills),e.deaths>v&&(v=e.deaths);const t=e.deaths>0?e.kills/e.deaths:e.kills;if(t>I&&(I=t),e.killTimestamps&&e.killTimestamps.length>0){let t=0,n=0;const a=[];e.killTimestamps&&e.killTimestamps.forEach((e=>a.push({type:"kill",time:e}))),e.deathTimestamps&&e.deathTimestamps.forEach((e=>a.push({type:"death",time:e}))),a.sort(((e,t)=>e.time-t.time)),a.forEach((e=>{"death"===e.type?(t>n&&(n=t),t=0):"kill"===e.type&&(t++,t>n&&(n=t))})),n>M&&(M=n)}if(e.killTimestamps&&e.killTimestamps.length>0){let t=1,n=e.killTimestamps[0];for(let a=1;a<e.killTimestamps.length;a++){const o=e.killTimestamps[a];o-n<=4e3?(t++,2===t&&g++,3===t&&p++,4===t&&y++,5===t&&E++,6===t&&S++,7===t&&f++):t=1,n=o}}})),o[e]={smashStreak:a,smashtacularStreak:s,smashosaurusStreak:l,smashlvaniaStreak:i,monsterSmashStreak:c,potatoStreak:m,smashSmashStreak:r,potoatachioStreak:u,doubleSmash:g,multiSmash:p,multiMegaSmash:y,multiMegaUltraSmash:E,gooseySmash:S,crazyMultiMegaUltraSmash:f,highestKillsRecord:k,highestDeathsRecord:v,highestKillStreakRecord:M,highestKDRRecord:I}})),n.stats=o,n.uiState={currentMode:m,openSections:a.openSections||{},skid:d};const s={version:E,timestamp:Date.now(),skid:d,data:n},l=await async function(e){try{await f();const t=crypto.getRandomValues(new Uint8Array(12)),n=(new TextEncoder).encode(JSON.stringify(e)),a=await crypto.subtle.encrypt({name:"AES-GCM",iv:t},S,n),o=new Uint8Array(t.length+a.byteLength);o.set(t),o.set(new Uint8Array(a),t.length);const s=btoa(String.fromCharCode.apply(null,o));return`SKMT_ENCRYPTED_v${E}_${s}`}catch(e){throw console.error("Encryption error:",e),new Error("Failed to encrypt data")}}(s),i=new Blob([l],{type:"application/octet-stream"}),c=URL.createObjectURL(i),r=document.createElement("a");r.href=c,r.download=`smash_karts_stats_${d}_${(new Date).toISOString().split("T")[0]}.skmt`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(c)}catch(e){console.error("Error exporting stats:",e),alert("Failed to export stats. Please try again.")}}document.getElementById("closeMatchInfoModal")&&(document.getElementById("closeMatchInfoModal").onclick=function(){document.getElementById("matchInfoModal").style.display="none"}),document.getElementById("matchInfoModal")&&(document.getElementById("matchInfoModal").onclick=function(e){e.target===this&&(this.style.display="none")});let v=null;function M(){const e=document.getElementById("hudSettingsModal");document.getElementById("hudSettingsTitle").textContent=("deaths"===v?"Deaths":"Kill Streak")+" HUD Settings";const t=`${v}HudSettings`;chrome.storage.sync.get([t],(e=>{const n=e[t]||{fontSize:32,fontColor:"#ffffff",fontFamily:"Arial, sans-serif"};document.getElementById("hudFontSize").value=n.fontSize,document.getElementById("fontSizeValue").textContent=`${n.fontSize}px`,document.getElementById("hudFontColor").value=n.fontColor,document.getElementById("hudFontFamily").value=n.fontFamily})),e.style.display="flex"}function I(){const e={fontSize:document.getElementById("hudFontSize").value,fontColor:document.getElementById("hudFontColor").value,fontFamily:document.getElementById("hudFontFamily").value},t=`${v}HudSettings`;chrome.storage.sync.set({[t]:e}),chrome.tabs.query({active:!0,currentWindow:!0},(t=>{chrome.tabs.sendMessage(t[0].id,{type:`update-${v}-hud-style`,settings:e})}))}document.getElementById("deathsHudSettings").addEventListener("click",(()=>{v="deaths",M()})),document.getElementById("killStreakHudSettings").addEventListener("click",(()=>{v="killstreak",M()})),document.getElementById("closeHudSettingsModal").addEventListener("click",(()=>{document.getElementById("hudSettingsModal").style.display="none"})),document.getElementById("hudSettingsModal").addEventListener("click",(e=>{e.target===document.getElementById("hudSettingsModal")&&(document.getElementById("hudSettingsModal").style.display="none")})),document.getElementById("hudFontSize").addEventListener("input",(e=>{const t=e.target.value;document.getElementById("fontSizeValue").textContent=`${t}px`,I()})),document.getElementById("hudFontColor").addEventListener("change",I),document.getElementById("hudFontFamily").addEventListener("change",I),document.getElementById("mapFilter").addEventListener("change",(function(e){r=e.target.value,y()}));let B=JSON.parse(localStorage.getItem("favoriteMatches")||"{}");function C(e,t){const n=document.getElementById("matches-list");n.innerHTML="",e.forEach(((a,o)=>{const s=document.createElement("div");s.className="match-card";const d=document.createElement("div");d.className="match-card-content";const r=document.createElement("div");if(r.className="match-meta",r.textContent=`#${e.length-o} | ${l(a.matchStartTime)} - ${l(a.matchEndTime)}`,d.appendChild(r),a.map){const e=document.createElement("div");e.className="match-map",e.textContent=a.map,d.appendChild(e)}const u=document.createElement("div");u.className="match-stats",u.innerHTML="",u.innerHTML+=`<span>Kills:</span><b>${a.kills}</b>`,u.innerHTML+=`<span>Deaths:</span><b>${a.deaths}</b>`,u.innerHTML+=`<span>KDR:</span><b>${i(a.kills,a.deaths)}</b>`;const g=a.duration||(a.matchEndTime&&a.matchStartTime?a.matchEndTime-a.matchStartTime:0),p=Math.floor(g/36e5),E=Math.floor(g%36e5/6e4),S=Math.floor(g%6e4/1e3);let f;f=p>0?`${p}h ${E}m ${S}s`:`${E}m ${S}s`,u.innerHTML+=`<span>Duration:</span><b>${f}</b>`,d.appendChild(u);const k=document.createElement("div");k.className="match-flags";let v=[];a.joined&&v.push("Joined"),a.started&&v.push("Started"),a.quit?v.push("Quit"):v.push("Completed"),a.isSpecialMode&&v.push("Special Mode"),a.isCustomMode&&v.push("Custom Match"),a.mode&&v.push(`${a.mode.charAt(0).toUpperCase()+a.mode.slice(1)} Mode`),v.length>0&&(k.textContent=v.join(" | ")),d.appendChild(k);const M=document.createElement("button");M.className="star-btn",M.title="Favorite this match",M.innerHTML='<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="10,2 12.59,7.36 18.51,8.09 14,12.26 15.18,18.09 10,15.27 4.82,18.09 6,12.26 1.49,8.09 7.41,7.36" stroke="#FFD700" stroke-width="1.5" fill="'+(B[a.matchStartTime]?"#FFD700":"white")+'"/></svg>',M.style.background="none",M.style.border="none",M.style.cursor="pointer",M.style.marginRight="4px",M.onclick=()=>{B[a.matchStartTime]?delete B[a.matchStartTime]:B[a.matchStartTime]=!0,localStorage.setItem("favoriteMatches",JSON.stringify(B)),C(e,t)};const I=document.createElement("button");I.className="info-btn",I.title="View match information",I.innerHTML='<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="9" stroke="#3498db" stroke-width="2" fill="white"/><rect x="9" y="8" width="2" height="6" rx="1" fill="#3498db"/><rect x="9" y="5" width="2" height="2" rx="1" fill="#3498db"/></svg>',I.onclick=()=>function(e){const t=document.getElementById("matchInfoModal"),n=document.getElementById("match-info-modal-body");let a=[];e.joined&&a.push("Joined"),e.started&&a.push("Started"),e.quit?a.push("Quit"):a.push("Completed"),e.isSpecialMode&&a.push("Special Mode"),e.isCustomMode&&a.push("Custom Match"),e.mode&&a.push(`${e.mode.charAt(0).toUpperCase()+e.mode.slice(1)} Mode`);const o=e.duration||(e.matchEndTime&&e.matchStartTime?e.matchEndTime-e.matchStartTime:0);let s=[];Array.isArray(e.players)&&(s=[...new Set(e.players)]),n.innerHTML=`\n        <div class="match-info-title">Match Information</div>\n        ${e.map?`<div class="match-info-section"><span class="match-info-label">Map:</span><span class="match-info-value">${e.map}</span></div>`:""}\n        <div class="match-info-section"><span class="match-info-label">Start:</span><span class="match-info-value">${l(e.matchStartTime)}</span></div>\n        <div class="match-info-section"><span class="match-info-label">End:</span><span class="match-info-value">${l(e.matchEndTime)}</span></div>\n        <div class="match-info-section"><span class="match-info-label">Kills:</span><span class="match-info-value">${e.kills}</span></div>\n        <div class="match-info-section"><span class="match-info-label">Deaths:</span><span class="match-info-value">${e.deaths}</span></div>\n        <div class="match-info-section"><span class="match-info-label">KDR:</span><span class="match-info-value">${i(e.kills,e.deaths)}</span></div>\n        <div class="match-info-section"><span class="match-info-label">Duration:</span><span class="match-info-value">${c(o)}</span></div>\n        <div class="match-info-section">\n            <span class="match-info-label" style="display:block;margin-bottom:6px;">Detected Players In Room:</span>\n            <ul style="margin:0 0 0 12px;padding:0;list-style:disc;">\n                ${s.length>0?s.map((e=>`<li style='font-size:16px;'>${e}</li>`)).join(""):'<li style="color:#aaa;font-size:16px;">No players detected</li>'}\n            </ul>\n        </div>\n        <div class="match-info-indicators">${a.join(" | ")}</div>\n    `,t.style.display="flex"}(a);const T=document.createElement("button");T.className="trash-btn",T.title="Delete this match",T.innerHTML='<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 8V15M10 8V15M14 8V15M3 5H17M8 5V3H12V5M5 5V17C5 17.5523 5.44772 18 6 18H14C14.5523 18 15 17.5523 15 17V5" stroke="#e74c3c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',T.onclick=()=>function(e,t){confirm("Are you sure you want to delete this match? This action cannot be undone.")&&chrome.storage.sync.get(["currentSkid"],(n=>{const a=n.currentSkid||"Default",o=t||m;if("all"===m&&!t)return void console.warn("[SKMT][DELETE] Cannot delete individual match in All Stats mode without mode specified.");const s=h("matchHistory",a,o);chrome.storage.sync.get([s],(t=>{let n=t[s]||[];if(e<0||e>=n.length)return;n.splice(e,1)[0];let l=0,i=0,c=0,d=0,m=0,r=0;n.forEach((e=>{l+=e.kills||0,i+=e.deaths||0,e.joined&&c++,e.started&&d++,e.quit&&m++,"special"===o&&e.isSpecialMode&&!e.quit&&r++,"normal"!==o||e.isSpecialMode||e.isCustomMode||e.quit||r++,"custom"===o&&e.isCustomMode&&!e.quit&&r++}));const u={};u[h("matchHistory",a,o)]=n,u[h("gamesJoined",a,o)]=c,u[h("gamesStarted",a,o)]=d,u[h("gamesQuit",a,o)]=m,u[h("matchesCompleted",a,o)]=r,chrome.storage.sync.set(u,y)}))}))}(e.length-1-o,a.mode),s.appendChild(d),s.appendChild(M),s.appendChild(I),s.appendChild(T),n.appendChild(s)}))}document.getElementById("matchSortSelect")&&document.getElementById("matchSortSelect").addEventListener("change",(function(e){y()}))})();