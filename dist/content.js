(()=>{let e={startTime:null,endTime:null,map:null,playerStats:{kills:0,deaths:0,powerUpsCollected:0,powerUpsUsed:0,smashStreaks:[],timeJoined:null,timeSpent:0},otherPlayers:new Map};function t(){const e=document.querySelector("[data-player-info]");return e?{skid:e.dataset.skid,username:e.dataset.username}:null}(function(){const s=window.WebSocket;window.WebSocket=function(a,o){const n=new s(a,o);return console.log("[SKMT] WebSocket connection established:",a),n.addEventListener("open",(function(){console.log("[SKMT] WebSocket connection opened")})),n.addEventListener("message",(function(s){try{const a=JSON.parse(s.data);console.log("[SKMT] Received WebSocket message:",a),function(s){if(s&&(console.log("[SKMT] Processing game data:",s),s.type))switch(s.type){case"gameStart":case"start_game":!function(s){w=[],e={startTime:Date.now(),endTime:null,map:s.map,playerStats:{kills:0,deaths:0,powerUpsCollected:0,powerUpsUsed:0,smashStreaks:[],timeJoined:Date.now(),timeSpent:0},otherPlayers:new Map};const a=t();a&&(e.playerStats.skid=a.skid,e.playerStats.username=a.username)}(s);break;case"gameEnd":case"game_end":!function(){e.endTime=Date.now(),e.playerStats.timeSpent=e.endTime-e.playerStats.timeJoined;const t={...e,otherPlayers:Array.from(e.otherPlayers.values()),logs:w};chrome.runtime.sendMessage({type:"matchComplete",data:t})}();break;case"playerKill":case"destroyed_human":!function(t){if(t.killerId===e.playerStats.skid&&e.playerStats.kills++,e.otherPlayers.has(t.victimId)){const s=e.otherPlayers.get(t.victimId);s.deaths++,e.otherPlayers.set(t.victimId,s)}}(s);break;case"playerDeath":case"destroyed_by_human":case"destroyed_by_bot":!function(t){t.victimId===e.playerStats.skid&&e.playerStats.deaths++}(s);break;case"powerUpCollected":!function(t){t.playerId===e.playerStats.skid&&e.playerStats.powerUpsCollected++}(s);break;case"powerUpUsed":!function(t){t.playerId===e.playerStats.skid&&e.playerStats.powerUpsUsed++}(s);break;case"smashStreak":!function(t){t.playerId===e.playerStats.skid&&e.playerStats.smashStreaks.push({type:t.streakType,timestamp:Date.now()})}(s)}}(a)}catch(e){"string"==typeof s.data&&console.error("[SKMT] Error processing WebSocket message:",e)}})),n.addEventListener("error",(function(e){console.error("[SKMT] WebSocket error:",e)})),n.addEventListener("close",(function(){console.log("[SKMT] WebSocket connection closed")})),n}})(),new MutationObserver((s=>{s.forEach((s=>{if("childList"===s.type){const s=t();s&&(e.playerStats.skid=s.skid,e.playerStats.username=s.username)}}))})).observe(document.body,{childList:!0,subtree:!0}),console.log("[SKMT] Content script loaded"),function(){const e=document.createElement("script");e.src=chrome.runtime.getURL("injected.js"),e.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(e)}(),window.addEventListener("message",(function(e){if(e.source===window&&e.data&&e.data.type&&e.data.type.startsWith("SKMT_"))if(console.log("[SKMT][CONTENT] Received message from injected script:",e.data.type,e.data),"SKMT_SKID_UPDATED"===e.data.type){const t=e.data.skid;t&&"string"==typeof t&&t.length>5&&window.chrome&&chrome.storage&&chrome.storage.sync&&chrome.storage.sync.set({currentSkid:t},(()=>{console.log("[SKMT][CONTENT] SKID saved to chrome.storage.sync:",t),chrome.runtime.sendMessage(e.data)}))}else if("SKMT_MATCH_COMPLETE"===e.data.type){const t=e.data.data;chrome.storage.sync.get(["currentSkid"],(s=>{const a=s.currentSkid||"default";let o="normal";t.isCustomMode?o="custom":t.isSpecialMode&&(o="special");const n=e=>`${e}_${a}_${o}`;if(t.quit){console.log("[SKMT][CONTENT][SAVE] Match was quit. Only updating gamesQuit stat for mode:",o,"Match:",t);const s=n("gamesQuit");chrome.storage.sync.get([s],(t=>{let a=t[s]||0;a++;const o={};o[s]=a,console.log("[SKMT][CONTENT][SAVE] Setting updated gamesQuit in chrome.storage.sync:",o),chrome.storage.sync.set(o,(()=>{chrome.runtime.sendMessage(e.data)}))}))}else{console.log("[SKMT][CONTENT][SAVE] Saving completed match for SKID:",a,"Mode:",o,"isSpecialMode:",t.isSpecialMode,"isCustomMode:",t.isCustomMode,"Match:",t),t.matchStartTime&&t.matchEndTime?(t.playerStats=t.playerStats||{},t.playerStats.timeSpent=t.matchEndTime-t.matchStartTime):(t.playerStats=t.playerStats||{},t.playerStats.timeSpent=0);const s=[n("matchHistory"),n("gamesJoined"),n("gamesStarted"),n("gamesQuit"),n("matchesCompleted")];chrome.storage.sync.get(s,(s=>{const a=s[n("matchHistory")]||[];a.push(t);let o=s[n("gamesJoined")]||0,i=s[n("gamesStarted")]||0,l=s[n("gamesQuit")]||0,r=s[n("matchesCompleted")]||0;t.joined&&o++,t.started&&i++,t.quit||r++;const d={};d[n("matchHistory")]=a,d[n("gamesJoined")]=o,d[n("gamesStarted")]=i,d[n("gamesQuit")]=l,d[n("matchesCompleted")]=r,console.log("[SKMT][CONTENT][SAVE] Setting completed match data and updated stats in chrome.storage.sync:",d),chrome.storage.sync.set(d,(()=>{chrome.runtime.sendMessage(e.data)}))}))}}))}else"SKMT_DEATHS_UPDATE"===e.data.type?s.textContent=`Deaths: ${e.data.deaths}`:"SKMT_MATCH_COMPLETE"===e.data.type&&(s.textContent="Deaths: 0")}));const s=document.createElement("div");s.id="death-hud-overlay",s.style.position="fixed",s.style.top="100px",s.style.right="40px",s.style.zIndex="999999",s.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',s.style.fontWeight="700",s.style.fontSize="32px",s.style.color="#fff",s.style.textShadow="2px 2px 4px rgba(0, 0, 0, 0.3)",s.style.cursor="move",s.style.userSelect="none",s.style.display="none",s.style.textRendering="optimizeLegibility",s.style.webkitFontSmoothing="antialiased",s.style.mozOsxFontSmoothing="grayscale",s.style.letterSpacing="0.5px",s.textContent="Deaths: 0";let a,o,n,i,l=!1,r=0,d=0;function c(e){"touchstart"===e.type?(n=e.touches[0].clientX-r,i=e.touches[0].clientY-d):(n=e.clientX-r,i=e.clientY-d),e.target===s&&(l=!0,e.preventDefault())}function m(e){l&&(n=a,i=o,l=!1,chrome.storage.sync.set({hudPosition:{x:r,y:d}}))}function p(e){l&&(e.preventDefault(),"touchmove"===e.type?(a=e.touches[0].clientX-n,o=e.touches[0].clientY-i):(a=e.clientX-n,o=e.clientY-i),r=a,d=o,b(a,o,s))}chrome.storage.sync.get(["hudPosition"],(function(e){e.hudPosition&&(r=e.hudPosition.x,d=e.hudPosition.y,b(r,d,s))})),s.addEventListener("touchstart",c,!1),s.addEventListener("touchend",m,!1),s.addEventListener("touchmove",p,!1),s.addEventListener("mousedown",c,!1),s.addEventListener("mouseup",m,!1),s.addEventListener("mousemove",p,!1),document.body.appendChild(s),chrome.storage.sync.get(["deathsHudEnabled","killStreakHudEnabled"],(e=>{!1!==e.deathsHudEnabled&&(s.style.display="block"),!1!==e.killStreakHudEnabled&&(y.style.display="block")})),chrome.runtime.onMessage.addListener((e=>{"toggle-deaths-hud"===e.type?s.style.display=e.enabled?"block":"none":"toggle-killstreak-hud"===e.type&&(y.style.display=e.enabled?"block":"none")}));const y=document.createElement("div");y.id="kill-streak-hud-overlay",y.style.position="fixed",y.style.top="160px",y.style.right="40px",y.style.zIndex="999999",y.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',y.style.fontWeight="700",y.style.fontSize="32px",y.style.color="#fff",y.style.textShadow="2px 2px 4px rgba(0, 0, 0, 0.3)",y.style.cursor="move",y.style.userSelect="none",y.style.display="none",y.style.textRendering="optimizeLegibility",y.style.webkitFontSmoothing="antialiased",y.style.mozOsxFontSmoothing="grayscale",y.style.letterSpacing="0.5px",y.textContent="Kill Streak: 0";let u,h,S,g,k=!1,f=0,T=0;function E(e){"touchstart"===e.type?(S=e.touches[0].clientX-f,g=e.touches[0].clientY-T):(S=e.clientX-f,g=e.clientY-T),e.target===y&&(k=!0,e.preventDefault())}function M(e){k&&(S=u,g=h,k=!1,chrome.storage.sync.set({killStreakHudPosition:{x:f,y:T}}))}function v(e){k&&(e.preventDefault(),"touchmove"===e.type?(u=e.touches[0].clientX-S,h=e.touches[0].clientY-g):(u=e.clientX-S,h=e.clientY-g),f=u,T=h,x(u,h,y))}function b(e,t,s){s.style.transform=`translate3d(${e}px, ${t}px, 0)`}function x(e,t,s){s.style.transform=`translate3d(${e}px, ${t}px, 0)`}chrome.storage.sync.get(["killStreakHudPosition"],(function(e){e.killStreakHudPosition&&(f=e.killStreakHudPosition.x,T=e.killStreakHudPosition.y,x(f,T,y))})),y.addEventListener("touchstart",E,!1),y.addEventListener("touchend",M,!1),y.addEventListener("touchmove",v,!1),y.addEventListener("mousedown",E,!1),y.addEventListener("mouseup",M,!1),y.addEventListener("mousemove",v,!1),document.body.appendChild(y),window.addEventListener("message",(function(e){e.source===window&&e.data&&e.data.type&&e.data.type.startsWith("SKMT_")&&("SKMT_DEATHS_UPDATE"===e.data.type?s.textContent=`Deaths: ${e.data.deaths}`:"SKMT_KILLSTREAK_UPDATE"===e.data.type?y.textContent=`Kill Streak: ${e.data.killStreak}`:"SKMT_MATCH_COMPLETE"===e.data.type&&(s.textContent="Deaths: 0",y.textContent="Kill Streak: 0"))}));let w=[]})();