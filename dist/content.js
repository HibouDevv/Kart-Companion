(()=>{let e={startTime:null,endTime:null,map:null,playerStats:{kills:0,deaths:0,powerUpsCollected:0,powerUpsUsed:0,smashStreaks:[],timeJoined:null,timeSpent:0},otherPlayers:new Map};function t(){const e=document.querySelector("[data-player-info]");return e?{skid:e.dataset.skid,username:e.dataset.username}:null}(function(){const s=window.WebSocket;window.WebSocket=function(a,o){const r=new s(a,o);return r.addEventListener("message",(function(s){try{!function(s){if(s)switch(s.type){case"gameStart":!function(s){e={startTime:Date.now(),endTime:null,map:s.map,playerStats:{kills:0,deaths:0,powerUpsCollected:0,powerUpsUsed:0,smashStreaks:[],timeJoined:Date.now(),timeSpent:0},otherPlayers:new Map};const a=t();a&&(e.playerStats.skid=a.skid,e.playerStats.username=a.username)}(s);break;case"gameEnd":!function(){e.endTime=Date.now(),e.playerStats.timeSpent=e.endTime-e.playerStats.timeJoined;const t={...e,otherPlayers:Array.from(e.otherPlayers.values())};chrome.runtime.sendMessage({type:"matchComplete",data:t})}();break;case"playerKill":!function(t){if(t.killerId===e.playerStats.skid&&e.playerStats.kills++,e.otherPlayers.has(t.victimId)){const s=e.otherPlayers.get(t.victimId);s.deaths++,e.otherPlayers.set(t.victimId,s)}}(s);break;case"playerDeath":!function(t){t.victimId===e.playerStats.skid&&e.playerStats.deaths++}(s);break;case"powerUpCollected":!function(t){t.playerId===e.playerStats.skid&&e.playerStats.powerUpsCollected++}(s);break;case"powerUpUsed":!function(t){t.playerId===e.playerStats.skid&&e.playerStats.powerUpsUsed++}(s);break;case"smashStreak":!function(t){t.playerId===e.playerStats.skid&&e.playerStats.smashStreaks.push({type:t.streakType,timestamp:Date.now()})}(s)}}(JSON.parse(s.data))}catch(e){console.error("Error processing WebSocket message:",e)}})),r}})(),new MutationObserver((s=>{s.forEach((s=>{if("childList"===s.type){const s=t();s&&(e.playerStats.skid=s.skid,e.playerStats.username=s.username)}}))})).observe(document.body,{childList:!0,subtree:!0}),console.log("[SKMT] Content script loaded"),function(){const e=document.createElement("script");e.src=chrome.runtime.getURL("injected.js"),e.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(e)}(),window.addEventListener("message",(function(e){if(e.data&&"SKMT_MATCH_COMPLETE"===e.data.type){const t=e.data.data;chrome.storage.sync.get(["currentSkid"],(e=>{const s=e.currentSkid||"default";let a="normal";t.isCustomMode?a="custom":t.isSpecialMode&&(a="special");const o=e=>`${e}_${s}_${a}`,r=[o("matchHistory"),o("gamesJoined"),o("gamesStarted"),o("gamesQuit"),o("matchesCompleted")];console.log("[SKMT][SAVE] Saving match for SKID:",s,"Mode:",a,"isSpecialMode:",t.isSpecialMode,"isCustomMode:",t.isCustomMode,"Keys:",r,"Match:",t),chrome.storage.sync.get(r,(e=>{const s=e[o("matchHistory")]||[];s.push(t);let r=e[o("gamesJoined")]||0,n=e[o("gamesStarted")]||0,i=e[o("gamesQuit")]||0,d=e[o("matchesCompleted")]||0;t.joined&&r++,t.started&&n++,t.quit&&i++,"special"===a&&t.isSpecialMode&&!t.quit&&d++,"normal"!==a||t.isSpecialMode||t.isCustomMode||t.quit||d++,"custom"===a&&t.isCustomMode&&!t.quit&&d++;const c={};c[o("matchHistory")]=s,c[o("gamesJoined")]=r,c[o("gamesStarted")]=n,c[o("gamesQuit")]=i,c[o("matchesCompleted")]=d,console.log("[SKMT][SAVE] Setting in chrome.storage.sync:",c),chrome.storage.sync.set(c)}))}))}})),window.addEventListener("message",(function(e){e.source===window&&e.data&&"SKMT_SKID_UPDATED"===e.data.type&&e.data.skid&&window.chrome&&chrome.storage&&chrome.storage.sync&&(chrome.storage.sync.set({currentSkid:e.data.skid}),console.log("[SKMT] SKID saved to chrome.storage.sync:",e.data.skid))}))})();