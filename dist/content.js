(()=>{let e={startTime:null,endTime:null,map:null,playerStats:{kills:0,deaths:0,powerUpsCollected:0,powerUpsUsed:0,smashStreaks:[],timeJoined:null,timeSpent:0},otherPlayers:new Map};function t(){const e=document.querySelector("[data-player-info]");return e?{skid:e.dataset.skid,username:e.dataset.username}:null}(function(){const o=window.WebSocket;window.WebSocket=function(s,a){const n=new o(s,a);return console.log("[SKMT] WebSocket connected"),n.addEventListener("open",(function(){console.log("[SKMT] WebSocket ready")})),n.addEventListener("message",(function(o){try{!function(o){if(o&&o.type)switch(o.type){case"gameStart":case"start_game":!function(o){console.log("[SKMT] Game starting"),K=[],e={startTime:Date.now(),endTime:null,map:o.map,playerStats:{kills:0,deaths:0,powerUpsCollected:0,powerUpsUsed:0,smashStreaks:[],timeJoined:Date.now(),timeSpent:0},otherPlayers:new Map};const s=t();s&&(e.playerStats.skid=s.skid,e.playerStats.username=s.username)}(o);break;case"gameEnd":case"game_end":!function(){console.log("[SKMT] Game ending"),e.endTime=Date.now(),e.playerStats.timeSpent=e.endTime-e.playerStats.timeJoined;const t={...e,otherPlayers:Array.from(e.otherPlayers.values()),logs:K},o=(e=0)=>{chrome.runtime.sendMessage({type:"matchComplete",data:t}).catch((s=>{e<3?(console.log(`[SKMT] Retrying match data send (attempt ${e+1})`),setTimeout((()=>o(e+1)),1e3)):(console.log("[SKMT] Content: Message port closed after retries, storing match data locally"),chrome.storage.local.get(["pendingMatches"],(e=>{const o=e.pendingMatches||[];o.push(t),chrome.storage.local.set({pendingMatches:o})})))}))};o()}();break;case"playerKill":case"destroyed_human":!function(t){if(t.killerId===e.playerStats.skid&&e.playerStats.kills++,e.otherPlayers.has(t.victimId)){const o=e.otherPlayers.get(t.victimId);o.deaths++,e.otherPlayers.set(t.victimId,o)}}(o);break;case"playerDeath":case"destroyed_by_human":case"destroyed_by_bot":!function(t){t.victimId===e.playerStats.skid&&e.playerStats.deaths++}(o);break;case"powerUpCollected":!function(t){t.playerId===e.playerStats.skid&&e.playerStats.powerUpsCollected++}(o);break;case"powerUpUsed":!function(t){t.playerId===e.playerStats.skid&&e.playerStats.powerUpsUsed++}(o);break;case"smashStreak":!function(t){t.playerId===e.playerStats.skid&&e.playerStats.smashStreaks.push({type:t.streakType,timestamp:Date.now()})}(o)}}(JSON.parse(o.data))}catch(e){"string"==typeof o.data&&console.error("[SKMT] WebSocket error:",e.message)}})),n.addEventListener("error",(function(e){console.error("[SKMT] WebSocket error:",e.message)})),n.addEventListener("close",(function(){console.log("[SKMT] WebSocket closed")})),n}})(),new MutationObserver((o=>{o.forEach((o=>{if("childList"===o.type){const o=t();o&&(e.playerStats.skid=o.skid,e.playerStats.username=o.username)}}))})).observe(document.body,{childList:!0,subtree:!0}),console.log("[SKMT] Content script loaded"),function(){const e=document.createElement("script");e.src=chrome.runtime.getURL("injected.js"),e.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(e)}(),window.addEventListener("message",(function(e){if(e.source===window&&e.data&&e.data.type&&e.data.type.startsWith("SKMT_"))if("SKMT_SKID_UPDATED"===e.data.type){const t=e.data.skid;t&&"string"==typeof t&&t.length>5&&window.chrome&&chrome.storage&&chrome.storage.local&&chrome.storage.local.set({currentSkid:t},(()=>{console.log("[SKMT] SKID saved:",t),chrome.runtime.sendMessage(e.data)}))}else if("SKMT_MATCH_COMPLETE"===e.data.type){const t=e.data.data;console.log("[SKMT] Saving match data:",{kills:t.kills,deaths:t.deaths,quit:t.quit}),chrome.storage.local.get(["currentSkid"],(e=>{const o=e.currentSkid||"default";let s="normal";t.isCustomMode?(s="custom",console.log("[SKMT] Recording quit in custom mode")):t.isSpecialMode?(s="special",console.log("[SKMT] Recording quit in special mode")):console.log("[SKMT] Recording quit in normal mode");const a=e=>`${e}_${o}_${s}`,n=[];t.quit?n.push(a("gamesQuit")):n.push(a("matchHistory"),a("gamesJoined"),a("gamesStarted"),a("matchesCompleted")),chrome.storage.local.get(n,(e=>{const o={};if(t.quit){const n=t.matchEndTime-t.matchStartTime;if(n>=1e4){let t=e[a("gamesQuit")]||0;t++,o[a("gamesQuit")]=t,console.log("[SKMT] Incrementing gamesQuit for mode:",s,"New value:",t,"Time spent:",n)}else console.log("[SKMT] Not incrementing gamesQuit - time spent less than 10 seconds:",n)}else{let s=e[a("matchHistory")]||[];s.push(t);let n=e[a("gamesJoined")]||0,l=e[a("gamesStarted")]||0,d=e[a("matchesCompleted")]||0;t.joined&&n++,t.started&&l++,d++,o[a("matchHistory")]=s,o[a("gamesJoined")]=n,o[a("gamesStarted")]=l,o[a("matchesCompleted")]=d}chrome.storage.local.set(o,(()=>{console.log("[SKMT] Match data saved:",{mode:s,quit:t.quit,isSpecialMode:t.isSpecialMode,isCustomMode:t.isCustomMode,savedToHistory:!t.quit,statsUpdated:!t.quit,timeSpent:t.matchEndTime-t.matchStartTime}),chrome.runtime.sendMessage({type:"SKMT_MATCH_COMPLETE",data:{...t,mode:s,quit:t.quit}},(()=>{chrome.runtime.lastError?console.error("[SKMT] Error sending message to popup:",chrome.runtime.lastError):console.log("[SKMT] Successfully sent match data to popup:",{mode:s,quit:t.quit,isSpecialMode:t.isSpecialMode,isCustomMode:t.isCustomMode})}))}))}))}))}else"SKMT_DEATHS_UPDATE"===e.data.type?(console.log("[SKMT] Received deaths update:",e.data.deaths),o.textContent=`Deaths: ${e.data.deaths}`,console.log("[SKMT] HUD: Deaths display updated to",e.data.deaths)):"SKMT_KILLSTREAK_UPDATE"===e.data.type?(console.log("[SKMT] Received kill streak update:",e.data.killStreak),m.textContent=`Kill Streak: ${e.data.killStreak}`,console.log("[SKMT] HUD: Kill streak display updated to",e.data.killStreak)):"SKMT_MATCH_COMPLETE"===e.data.type&&(console.log("[SKMT] Match complete, resetting HUD displays"),o.textContent="Deaths: 0",m.textContent="Kill Streak: 0",console.log("[SKMT] HUD: Reset to initial state"))}));const o=document.createElement("div");o.id="death-hud-overlay",o.style.position="fixed",o.style.top="100px",o.style.left="300px",o.style.zIndex="999999",o.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',o.style.fontWeight="700",o.style.fontSize="24px",o.style.color="#fff",o.style.textShadow="2px 2px 4px rgba(0, 0, 0, 0.3)",o.style.cursor="move",o.style.userSelect="none",o.style.display="none",o.style.textRendering="optimizeLegibility",o.style.webkitFontSmoothing="antialiased",o.style.mozOsxFontSmoothing="grayscale",o.style.letterSpacing="0.5px",o.textContent="Deaths: 0",o.style.backgroundColor="rgba(0, 0, 0, 0.5)",o.style.padding="0.5em 1em",o.style.borderRadius="0.5em";let s,a,n,l,d=!1,i=0,r=0;function c(e){"touchstart"===e.type?(n=e.touches[0].clientX-i,l=e.touches[0].clientY-r):(n=e.clientX-i,l=e.clientY-r),e.target===o&&(d=!0,e.preventDefault())}function u(e){d&&(n=s,l=a,d=!1,chrome.storage.local.set({hudPosition:{x:i,y:r}}))}function y(e){d&&(e.preventDefault(),"touchmove"===e.type?(s=e.touches[0].clientX-n,a=e.touches[0].clientY-l):(s=e.clientX-n,a=e.clientY-l),i=s,r=a,M(s,a,o))}chrome.storage.local.get(["hudPosition"],(function(e){e.hudPosition&&(i=e.hudPosition.x,r=e.hudPosition.y,M(i,r,o))})),o.addEventListener("touchstart",c,!1),o.addEventListener("touchend",u,!1),o.addEventListener("touchmove",y,!1),o.addEventListener("mousedown",c,!1),o.addEventListener("mouseup",u,!1),o.addEventListener("mousemove",y,!1),document.body.appendChild(o),chrome.storage.local.get(["deathsHudEnabled","killStreakHudEnabled"],(e=>{o.style.display=!1!==e.deathsHudEnabled?"block":"none",m.style.display=!1!==e.killStreakHudEnabled?"block":"none",console.log("[SKMT] HUD states:",{deathsHud:o.style.display,killStreakHud:m.style.display,deathsHudEnabled:e.deathsHudEnabled,killStreakHudEnabled:e.killStreakHudEnabled})})),chrome.runtime.onMessage.addListener((e=>{"toggle-deaths-hud"===e.type?(o.style.display=e.enabled?"block":"none",console.log("[SKMT] Deaths HUD toggled:",e.enabled)):"toggle-killstreak-hud"===e.type?(m.style.display=e.enabled?"block":"none",console.log("[SKMT] Kill Streak HUD toggled:",e.enabled)):"toggle-kdr-hud"===e.type?(v.style.display=e.enabled?"block":"none",console.log("[SKMT] KDR HUD toggled:",e.enabled)):"toggle-matchcode-hud"===e.type&&(_.style.display=e.enabled?"block":"none",console.log("[SKMT] Match Code HUD toggled:",e.enabled))}));const m=document.createElement("div");m.id="kill-streak-hud-overlay",m.style.position="fixed",m.style.top="160px",m.style.left="300px",m.style.zIndex="999999",m.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',m.style.fontWeight="700",m.style.fontSize="24px",m.style.color="#fff",m.style.textShadow="2px 2px 4px rgba(0, 0, 0, 0.3)",m.style.cursor="move",m.style.userSelect="none",m.style.display="none",m.style.textRendering="optimizeLegibility",m.style.webkitFontSmoothing="antialiased",m.style.mozOsxFontSmoothing="grayscale",m.style.letterSpacing="0.5px",m.textContent="Kill Streak: 0",m.style.backgroundColor="rgba(0, 0, 0, 0.5)",m.style.padding="0.5em 1em",m.style.borderRadius="0.5em";let p,g,h,S,k=!1,f=0,b=0;function H(e){"touchstart"===e.type?(h=e.touches[0].clientX-f,S=e.touches[0].clientY-b):(h=e.clientX-f,S=e.clientY-b),e.target===m&&(k=!0,e.preventDefault())}function E(e){k&&(h=p,S=g,k=!1,chrome.storage.local.set({killStreakHudPosition:{x:f,y:b}}))}function T(e){k&&(e.preventDefault(),"touchmove"===e.type?(p=e.touches[0].clientX-h,g=e.touches[0].clientY-S):(p=e.clientX-h,g=e.clientY-S),f=p,b=g,x(p,g,m))}function M(e,t,o){o.style.transform=`translate3d(${e}px, ${t}px, 0)`}function x(e,t,o){o.style.transform=`translate3d(${e}px, ${t}px, 0)`}chrome.storage.local.get(["killStreakHudPosition"],(function(e){e.killStreakHudPosition&&(f=e.killStreakHudPosition.x,b=e.killStreakHudPosition.y,x(f,b,m))})),m.addEventListener("touchstart",H,!1),m.addEventListener("touchend",E,!1),m.addEventListener("touchmove",T,!1),m.addEventListener("mousedown",H,!1),m.addEventListener("mouseup",E,!1),m.addEventListener("mousemove",T,!1),document.body.appendChild(m),window.addEventListener("message",(function(e){e.source===window&&e.data&&e.data.type&&e.data.type.startsWith("SKMT_")&&("SKMT_DEATHS_UPDATE"===e.data.type?o.textContent=`Deaths: ${e.data.deaths}`:"SKMT_KILLSTREAK_UPDATE"===e.data.type?m.textContent=`Kill Streak: ${e.data.killStreak}`:"SKMT_MATCH_COMPLETE"===e.data.type&&(o.textContent="Deaths: 0",m.textContent="Kill Streak: 0"))}));let K=[];function C(e,t){t&&(e.style.fontSize=`${t.fontSize}px`,e.style.color=t.fontColor,e.style.fontFamily=t.fontFamily,e.style.backgroundColor=t.backgroundColor||"rgba(0, 0, 0, 0.5)")}chrome.storage.local.get(["deathsHudSettings","killStreakHudSettings","kdrHudSettings"],(e=>{if(e.deathsHudSettings)C(o,e.deathsHudSettings);else{const e={fontSize:24,fontColor:"#ffffff",fontFamily:"Arial, sans-serif"};chrome.storage.local.set({deathsHudSettings:e}),C(o,e)}if(e.killStreakHudSettings)C(m,e.killStreakHudSettings);else{const e={fontSize:24,fontColor:"#ffffff",fontFamily:"Arial, sans-serif"};chrome.storage.local.set({killStreakHudSettings:e}),C(m,e)}if(e.kdrHudSettings)C(v,e.kdrHudSettings);else{const e={fontSize:24,fontColor:"#ffffff",fontFamily:"Arial, sans-serif"};chrome.storage.local.set({kdrHudSettings:e}),C(v,e)}})),chrome.runtime.onMessage.addListener((e=>{"update-deaths-hud-style"===e.type?(C(o,e.settings),chrome.storage.local.set({deathsHudSettings:e.settings})):"update-killstreak-hud-style"===e.type?(C(m,e.settings),chrome.storage.local.set({killStreakHudSettings:e.settings})):"update-kdr-hud-style"===e.type&&(C(v,e.settings),chrome.storage.local.set({kdrHudSettings:e.settings}))}));const v=document.createElement("div");v.id="kdr-hud-overlay",v.style.position="fixed",v.style.top="220px",v.style.left="300px",v.style.zIndex="999999",v.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',v.style.fontWeight="700",v.style.fontSize="24px",v.style.color="#fff",v.style.textShadow="2px 2px 4px rgba(0, 0, 0, 0.3)",v.style.cursor="move",v.style.userSelect="none",v.style.display="none",v.style.textRendering="optimizeLegibility",v.style.webkitFontSmoothing="antialiased",v.style.mozOsxFontSmoothing="grayscale",v.style.letterSpacing="0.5px",v.textContent="KDR: 0.00",v.style.backgroundColor="rgba(0, 0, 0, 0.5)",v.style.padding="0.5em 1em",v.style.borderRadius="0.5em";let D=!1,L=0,w=0;function P(e,t,o){o.style.transform=`translate3d(${e}px, ${t}px, 0)`}chrome.storage.local.get(["kdrHudPosition"],(function(e){e.kdrHudPosition&&(L=e.kdrHudPosition.x,w=e.kdrHudPosition.y,P(L,w,v))})),document.body.appendChild(v),v.addEventListener("mousedown",(function(e){n=e.clientX-L,l=e.clientY-w,e.target===v&&(D=!0)})),document.addEventListener("mousemove",(function(e){D&&(e.preventDefault(),s=e.clientX-n,a=e.clientY-l,L=s,w=a,P(s,a,v))})),document.addEventListener("mouseup",(function(e){n=s,l=a,D=!1,chrome.storage.local.set({kdrHudPosition:{x:L,y:w}})})),chrome.storage.local.get(["deathsHudEnabled","killStreakHudEnabled","kdrHudEnabled"],(e=>{o.style.display=!1!==e.deathsHudEnabled?"block":"none",m.style.display=!1!==e.killStreakHudEnabled?"block":"none",v.style.display=!1!==e.kdrHudEnabled?"block":"none",console.log("[SKMT] HUD states:",{deathsHud:o.style.display,killStreakHud:m.style.display,kdrHud:v.style.display,deathsHudEnabled:e.deathsHudEnabled,killStreakHudEnabled:e.killStreakHudEnabled,kdrHudEnabled:e.kdrHudEnabled})})),chrome.runtime.onMessage.addListener((e=>{"toggle-deaths-hud"===e.type?(o.style.display=e.enabled?"block":"none",console.log("[SKMT] Deaths HUD toggled:",e.enabled)):"toggle-killstreak-hud"===e.type?(m.style.display=e.enabled?"block":"none",console.log("[SKMT] Kill Streak HUD toggled:",e.enabled)):"toggle-kdr-hud"===e.type?(v.style.display=e.enabled?"block":"none",console.log("[SKMT] KDR HUD toggled:",e.enabled)):"toggle-matchcode-hud"===e.type&&(_.style.display=e.enabled?"block":"none",console.log("[SKMT] Match Code HUD toggled:",e.enabled))})),window.addEventListener("message",(function(e){e.source===window&&e.data&&e.data.type&&e.data.type.startsWith("SKMT_")&&("SKMT_DEATHS_UPDATE"===e.data.type?o.textContent=`Deaths: ${e.data.deaths}`:"SKMT_KILLSTREAK_UPDATE"===e.data.type?m.textContent=`Kill Streak: ${e.data.killStreak}`:"SKMT_KDR_UPDATE"===e.data.type?v.textContent=`KDR: ${e.data.kdr.toFixed(2)}`:"SKMT_MATCH_COMPLETE"===e.data.type&&(o.textContent="Deaths: 0",m.textContent="Kill Streak: 0",v.textContent="KDR: 0.00"))}));const _=document.createElement("div");_.id="match-code-hud-overlay",_.style.position="fixed",_.style.top="280px",_.style.left="300px",_.style.zIndex="999999",_.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',_.style.fontWeight="700",_.style.fontSize="24px",_.style.color="#fff",_.style.textShadow="2px 2px 4px rgba(0, 0, 0, 0.3)",_.style.cursor="move",_.style.userSelect="none",_.style.display="none",_.style.textRendering="optimizeLegibility",_.style.webkitFontSmoothing="antialiased",_.style.mozOsxFontSmoothing="grayscale",_.style.letterSpacing="0.5px",_.textContent="Code: ",_.style.backgroundColor="rgba(0, 0, 0, 0.5)",_.style.padding="0.5em 1em",_.style.borderRadius="0.5em";let U=!1,A=0,R=0;function F(e){"touchstart"===e.type?(n=e.touches[0].clientX-A,l=e.touches[0].clientY-R):(n=e.clientX-A,l=e.clientY-R),e.target===_&&(U=!0)}function $(e){U&&(e.preventDefault(),"touchmove"===e.type?(s=e.touches[0].clientX-n,a=e.touches[0].clientY-l):(s=e.clientX-n,a=e.clientY-l),A=s,R=a,I(s,a,_))}function I(e,t,o){o.style.transform=`translate3d(${e}px, ${t}px, 0)`}function z(e){n=s,l=a,U=!1,chrome.storage.local.set({matchCodeHudPosition:{x:A,y:R}})}chrome.storage.local.get(["matchCodeHudPosition"],(function(e){e.matchCodeHudPosition&&(A=e.matchCodeHudPosition.x,R=e.matchCodeHudPosition.y,I(A,R,_))})),document.body.appendChild(_),_.addEventListener("touchstart",F,!1),_.addEventListener("touchend",z,!1),_.addEventListener("touchmove",$,!1),_.addEventListener("mousedown",F,!1),_.addEventListener("mouseup",z,!1),_.addEventListener("mousemove",$,!1),chrome.storage.local.get(["deathsHudEnabled","killStreakHudEnabled","kdrHudEnabled","matchCodeHudEnabled"],(e=>{o.style.display=!1!==e.deathsHudEnabled?"block":"none",m.style.display=!1!==e.killStreakHudEnabled?"block":"none",v.style.display=!1!==e.kdrHudEnabled?"block":"none",_.style.display=!1!==e.matchCodeHudEnabled?"block":"none",console.log("[SKMT] HUD states:",{deathsHud:o.style.display,killStreakHud:m.style.display,kdrHud:v.style.display,matchCodeHud:_.style.display,deathsHudEnabled:e.deathsHudEnabled,killStreakHudEnabled:e.killStreakHudEnabled,kdrHudEnabled:e.kdrHudEnabled,matchCodeHudEnabled:e.matchCodeHudEnabled})})),chrome.storage.local.get(["deathsHudSettings","killStreakHudSettings","kdrHudSettings","matchCodeHudSettings"],(e=>{if(e.matchCodeHudSettings)C(_,e.matchCodeHudSettings);else{const e={fontSize:24,fontColor:"#ffffff",fontFamily:"Arial, sans-serif"};chrome.storage.local.set({matchCodeHudSettings:e}),C(_,e)}})),chrome.runtime.onMessage.addListener((e=>{"update-deaths-hud-style"===e.type?(C(o,e.settings),chrome.storage.local.set({deathsHudSettings:e.settings})):"update-killstreak-hud-style"===e.type?(C(m,e.settings),chrome.storage.local.set({killStreakHudSettings:e.settings})):"update-kdr-hud-style"===e.type?(C(v,e.settings),chrome.storage.local.set({kdrHudSettings:e.settings})):"update-matchcode-hud-style"===e.type&&(C(_,e.settings),chrome.storage.local.set({matchCodeHudSettings:e.settings}))})),window.addEventListener("message",(function(e){if(e.data&&"object"==typeof e.data)switch(e.data.type){case"SKMT_KILLSTREAK_UPDATE":m&&(m.textContent=`Kill Streak: ${e.data.killStreak}`);break;case"SKMT_DEATHS_UPDATE":o&&(o.textContent=`Deaths: ${e.data.deaths}`);break;case"SKMT_KDR_UPDATE":v&&(v.textContent=`KDR: ${e.data.kdr.toFixed(2)}`);break;case"SKMT_MATCH_CODE_UPDATE":_&&(_.textContent=e.data.code?`Code: ${e.data.code}`:"Code: ")}})),chrome.runtime.onMessage.addListener(((e,t,s)=>{"resetHudPositions"===e.action&&(i=0,r=0,f=0,b=0,L=0,w=0,A=0,R=0,M(0,0,o),x(0,0,m),P(0,0,v),I(0,0,_),chrome.storage.local.remove(["hudPosition","killStreakHudPosition","kdrHudPosition","matchCodeHudPosition"]))}))})();