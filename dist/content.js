(()=>{let e={startTime:null,endTime:null,map:null,playerStats:{kills:0,deaths:0,powerUpsCollected:0,powerUpsUsed:0,smashStreaks:[],timeJoined:null,timeSpent:0},otherPlayers:new Map};function t(){const e=document.querySelector("[data-player-info]");return e?{skid:e.dataset.skid,username:e.dataset.username}:null}(function(){const s=window.WebSocket;window.WebSocket=function(o,a){const n=new s(o,a);return console.log("[SKMT] WebSocket connected"),n.addEventListener("open",(function(){console.log("[SKMT] WebSocket ready")})),n.addEventListener("message",(function(s){try{!function(s){if(s&&s.type)switch(s.type){case"gameStart":case"start_game":!function(s){console.log("[SKMT] Game starting"),H=[],e={startTime:Date.now(),endTime:null,map:s.map,playerStats:{kills:0,deaths:0,powerUpsCollected:0,powerUpsUsed:0,smashStreaks:[],timeJoined:Date.now(),timeSpent:0},otherPlayers:new Map};const o=t();o&&(e.playerStats.skid=o.skid,e.playerStats.username=o.username)}(s);break;case"gameEnd":case"game_end":!function(){console.log("[SKMT] Game ending"),e.endTime=Date.now(),e.playerStats.timeSpent=e.endTime-e.playerStats.timeJoined;const t={...e,otherPlayers:Array.from(e.otherPlayers.values()),logs:H};chrome.runtime.sendMessage({type:"matchComplete",data:t})}();break;case"playerKill":case"destroyed_human":!function(t){if(t.killerId===e.playerStats.skid&&e.playerStats.kills++,e.otherPlayers.has(t.victimId)){const s=e.otherPlayers.get(t.victimId);s.deaths++,e.otherPlayers.set(t.victimId,s)}}(s);break;case"playerDeath":case"destroyed_by_human":case"destroyed_by_bot":!function(t){t.victimId===e.playerStats.skid&&e.playerStats.deaths++}(s);break;case"powerUpCollected":!function(t){t.playerId===e.playerStats.skid&&e.playerStats.powerUpsCollected++}(s);break;case"powerUpUsed":!function(t){t.playerId===e.playerStats.skid&&e.playerStats.powerUpsUsed++}(s);break;case"smashStreak":!function(t){t.playerId===e.playerStats.skid&&e.playerStats.smashStreaks.push({type:t.streakType,timestamp:Date.now()})}(s)}}(JSON.parse(s.data))}catch(e){"string"==typeof s.data&&console.error("[SKMT] WebSocket error:",e.message)}})),n.addEventListener("error",(function(e){console.error("[SKMT] WebSocket error:",e.message)})),n.addEventListener("close",(function(){console.log("[SKMT] WebSocket closed")})),n}})(),new MutationObserver((s=>{s.forEach((s=>{if("childList"===s.type){const s=t();s&&(e.playerStats.skid=s.skid,e.playerStats.username=s.username)}}))})).observe(document.body,{childList:!0,subtree:!0}),console.log("[SKMT] Content script loaded"),function(){const e=document.createElement("script");e.src=chrome.runtime.getURL("injected.js"),e.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(e)}(),window.addEventListener("message",(function(e){if(e.source===window&&e.data&&e.data.type&&e.data.type.startsWith("SKMT_"))if("SKMT_SKID_UPDATED"===e.data.type){const t=e.data.skid;t&&"string"==typeof t&&t.length>5&&window.chrome&&chrome.storage&&chrome.storage.sync&&chrome.storage.sync.set({currentSkid:t},(()=>{console.log("[SKMT] SKID saved:",t),chrome.runtime.sendMessage(e.data)}))}else if("SKMT_MATCH_COMPLETE"===e.data.type){const t=e.data.data;console.log("[SKMT] Saving match data:",{kills:t.kills,deaths:t.deaths,quit:t.quit}),chrome.storage.sync.get(["currentSkid"],(e=>{const s=e.currentSkid||"default";let o="normal";t.isCustomMode?(o="custom",console.log("[SKMT] Recording quit in custom mode")):t.isSpecialMode?(o="special",console.log("[SKMT] Recording quit in special mode")):console.log("[SKMT] Recording quit in normal mode");const a=e=>`${e}_${s}_${o}`,n=[];t.quit?n.push(a("gamesQuit")):n.push(a("matchHistory"),a("gamesJoined"),a("gamesStarted"),a("matchesCompleted")),chrome.storage.sync.get(n,(e=>{const s={};if(t.quit){let t=e[a("gamesQuit")]||0;t++,s[a("gamesQuit")]=t,console.log("[SKMT] Incrementing gamesQuit for mode:",o,"New value:",t)}else{let o=e[a("matchHistory")]||[];o.push(t);let n=e[a("gamesJoined")]||0,l=e[a("gamesStarted")]||0,i=e[a("matchesCompleted")]||0;t.joined&&n++,t.started&&l++,i++,s[a("matchHistory")]=o,s[a("gamesJoined")]=n,s[a("gamesStarted")]=l,s[a("matchesCompleted")]=i}chrome.storage.sync.set(s,(()=>{console.log("[SKMT] Match data saved:",{mode:o,quit:t.quit,isSpecialMode:t.isSpecialMode,isCustomMode:t.isCustomMode,savedToHistory:!t.quit,statsUpdated:!t.quit}),chrome.runtime.sendMessage({type:"SKMT_MATCH_COMPLETE",data:{...t,mode:o,quit:t.quit}},(()=>{chrome.runtime.lastError?console.error("[SKMT] Error sending message to popup:",chrome.runtime.lastError):console.log("[SKMT] Successfully sent match data to popup:",{mode:o,quit:t.quit,isSpecialMode:t.isSpecialMode,isCustomMode:t.isCustomMode})})),t.quit&&setTimeout((()=>{const e={};t.isCustomMode&&(e.isCustomMode=!1,console.log("[SKMT] Resetting custom mode flag after delay")),t.isSpecialMode&&(e.isSpecialMode=!1,console.log("[SKMT] Resetting special mode flag after delay")),Object.keys(e).length>0&&chrome.storage.sync.set(e,(()=>{console.log("[SKMT] Mode flags reset after delay")}))}),1e3)}))}))}))}else"SKMT_DEATHS_UPDATE"===e.data.type?(console.log("[SKMT] Received deaths update:",e.data.deaths),s.textContent=`Deaths: ${e.data.deaths}`,console.log("[SKMT] HUD: Deaths display updated to",e.data.deaths)):"SKMT_KILLSTREAK_UPDATE"===e.data.type?(console.log("[SKMT] Received kill streak update:",e.data.killStreak),y.textContent=`Kill Streak: ${e.data.killStreak}`,console.log("[SKMT] HUD: Kill streak display updated to",e.data.killStreak)):"SKMT_MATCH_COMPLETE"===e.data.type&&(console.log("[SKMT] Match complete, resetting HUD displays"),s.textContent="Deaths: 0",y.textContent="Kill Streak: 0",console.log("[SKMT] HUD: Reset to initial state"))}));const s=document.createElement("div");s.id="death-hud-overlay",s.style.position="fixed",s.style.top="100px",s.style.right="40px",s.style.zIndex="999999",s.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',s.style.fontWeight="700",s.style.fontSize="32px",s.style.color="#fff",s.style.textShadow="2px 2px 4px rgba(0, 0, 0, 0.3)",s.style.cursor="move",s.style.userSelect="none",s.style.display="none",s.style.textRendering="optimizeLegibility",s.style.webkitFontSmoothing="antialiased",s.style.mozOsxFontSmoothing="grayscale",s.style.letterSpacing="0.5px",s.textContent="Deaths: 0";let o,a,n,l,i=!1,d=0,r=0;function c(e){"touchstart"===e.type?(n=e.touches[0].clientX-d,l=e.touches[0].clientY-r):(n=e.clientX-d,l=e.clientY-r),e.target===s&&(i=!0,e.preventDefault())}function u(e){i&&(n=o,l=a,i=!1,chrome.storage.sync.set({hudPosition:{x:d,y:r}}))}function m(e){i&&(e.preventDefault(),"touchmove"===e.type?(o=e.touches[0].clientX-n,a=e.touches[0].clientY-l):(o=e.clientX-n,a=e.clientY-l),d=o,r=a,v(o,a,s))}chrome.storage.sync.get(["hudPosition"],(function(e){e.hudPosition&&(d=e.hudPosition.x,r=e.hudPosition.y,v(d,r,s))})),s.addEventListener("touchstart",c,!1),s.addEventListener("touchend",u,!1),s.addEventListener("touchmove",m,!1),s.addEventListener("mousedown",c,!1),s.addEventListener("mouseup",u,!1),s.addEventListener("mousemove",m,!1),document.body.appendChild(s),chrome.storage.sync.get(["deathsHudEnabled","killStreakHudEnabled"],(e=>{s.style.display=!1!==e.deathsHudEnabled?"block":"none",y.style.display=!1!==e.killStreakHudEnabled?"block":"none",console.log("[SKMT] HUD states:",{deathsHud:s.style.display,killStreakHud:y.style.display,deathsHudEnabled:e.deathsHudEnabled,killStreakHudEnabled:e.killStreakHudEnabled})})),chrome.runtime.onMessage.addListener((e=>{"toggle-deaths-hud"===e.type?(s.style.display=e.enabled?"block":"none",console.log("[SKMT] Deaths HUD toggled:",e.enabled)):"toggle-killstreak-hud"===e.type&&(y.style.display=e.enabled?"block":"none",console.log("[SKMT] Kill Streak HUD toggled:",e.enabled))}));const y=document.createElement("div");y.id="kill-streak-hud-overlay",y.style.position="fixed",y.style.top="160px",y.style.right="40px",y.style.zIndex="999999",y.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',y.style.fontWeight="700",y.style.fontSize="32px",y.style.color="#fff",y.style.textShadow="2px 2px 4px rgba(0, 0, 0, 0.3)",y.style.cursor="move",y.style.userSelect="none",y.style.display="none",y.style.textRendering="optimizeLegibility",y.style.webkitFontSmoothing="antialiased",y.style.mozOsxFontSmoothing="grayscale",y.style.letterSpacing="0.5px",y.textContent="Kill Streak: 0";let p,S,h,g,k=!1,f=0,M=0;function T(e){"touchstart"===e.type?(h=e.touches[0].clientX-f,g=e.touches[0].clientY-M):(h=e.clientX-f,g=e.clientY-M),e.target===y&&(k=!0,e.preventDefault())}function K(e){k&&(h=p,g=S,k=!1,chrome.storage.sync.set({killStreakHudPosition:{x:f,y:M}}))}function E(e){k&&(e.preventDefault(),"touchmove"===e.type?(p=e.touches[0].clientX-h,S=e.touches[0].clientY-g):(p=e.clientX-h,S=e.clientY-g),f=p,M=S,b(p,S,y))}function v(e,t,s){s.style.transform=`translate3d(${e}px, ${t}px, 0)`}function b(e,t,s){s.style.transform=`translate3d(${e}px, ${t}px, 0)`}chrome.storage.sync.get(["killStreakHudPosition"],(function(e){e.killStreakHudPosition&&(f=e.killStreakHudPosition.x,M=e.killStreakHudPosition.y,b(f,M,y))})),y.addEventListener("touchstart",T,!1),y.addEventListener("touchend",K,!1),y.addEventListener("touchmove",E,!1),y.addEventListener("mousedown",T,!1),y.addEventListener("mouseup",K,!1),y.addEventListener("mousemove",E,!1),document.body.appendChild(y),window.addEventListener("message",(function(e){e.source===window&&e.data&&e.data.type&&e.data.type.startsWith("SKMT_")&&("SKMT_DEATHS_UPDATE"===e.data.type?s.textContent=`Deaths: ${e.data.deaths}`:"SKMT_KILLSTREAK_UPDATE"===e.data.type?y.textContent=`Kill Streak: ${e.data.killStreak}`:"SKMT_MATCH_COMPLETE"===e.data.type&&(s.textContent="Deaths: 0",y.textContent="Kill Streak: 0"))}));let H=[];function x(e,t){t&&(e.style.fontSize=`${t.fontSize}px`,e.style.color=t.fontColor,e.style.fontFamily=t.fontFamily)}chrome.storage.sync.get(["deathsHudSettings","killStreakHudSettings"],(e=>{if(e.deathsHudSettings)x(s,e.deathsHudSettings);else{const e={fontSize:32,fontColor:"#ffffff",fontFamily:"Arial, sans-serif"};chrome.storage.sync.set({deathsHudSettings:e}),x(s,e)}if(e.killStreakHudSettings)x(y,e.killStreakHudSettings);else{const e={fontSize:32,fontColor:"#ffffff",fontFamily:"Arial, sans-serif"};chrome.storage.sync.set({killStreakHudSettings:e}),x(y,e)}})),chrome.runtime.onMessage.addListener((e=>{"update-deaths-hud-style"===e.type?(x(s,e.settings),chrome.storage.sync.set({deathsHudSettings:e.settings})):"update-killstreak-hud-style"===e.type&&(x(y,e.settings),chrome.storage.sync.set({killStreakHudSettings:e.settings}))}))})();