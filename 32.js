/*! For license information please see 32.js.LICENSE.txt */
"use strict";(self.webpackChunksmash_karts_match_tracker=self.webpackChunksmash_karts_match_tracker||[]).push([[32],{32:(e,t,n)=>{n.r(t),n.d(t,{AbstractUserDataWriter:()=>Eh,AggregateField:()=>pl,AggregateQuerySnapshot:()=>yl,Bytes:()=>wl,CACHE_SIZE_UNLIMITED:()=>el,CollectionReference:()=>$c,DocumentReference:()=>Gc,DocumentSnapshot:()=>Fh,FieldPath:()=>vl,FieldValue:()=>Il,Firestore:()=>tl,FirestoreError:()=>E,GeoPoint:()=>bl,LoadBundleTask:()=>Zc,PersistentCacheIndexManager:()=>Dd,Query:()=>Kc,QueryCompositeFilterConstraint:()=>ih,QueryConstraint:()=>th,QueryDocumentSnapshot:()=>Vh,QueryEndAtConstraint:()=>ph,QueryFieldFilterConstraint:()=>rh,QueryLimitConstraint:()=>lh,QueryOrderByConstraint:()=>uh,QuerySnapshot:()=>Mh,QueryStartAtConstraint:()=>fh,SnapshotMetadata:()=>Rh,Timestamp:()=>U,Transaction:()=>pd,VectorValue:()=>Tl,WriteBatch:()=>md,_AutoId:()=>O,_ByteString:()=>mt,_DatabaseId:()=>Tt,_DocumentKey:()=>Q,_EmptyAppCheckTokenProvider:()=>V,_EmptyAuthCredentialsProvider:()=>D,_FieldPath:()=>$,_TestingHooks:()=>Od,_cast:()=>Pc,_debugAssert:()=>I,_internalAggregationQueryToProtoRunAggregationQueryRequest:()=>Md,_internalQueryToProtoQueryTarget:()=>Vd,_isBase64Available:()=>ft,_logWarn:()=>y,_validateIsNotUsedTogether:()=>Vc,addDoc:()=>Wh,aggregateFieldEqual:()=>Ah,aggregateQuerySnapshotEqual:()=>kh,and:()=>ah,arrayRemove:()=>Id,arrayUnion:()=>_d,average:()=>Ch,clearIndexedDbPersistence:()=>cl,collection:()=>Qc,collectionGroup:()=>jc,connectFirestoreEmulator:()=>zc,count:()=>Nh,deleteAllPersistentCacheIndexes:()=>kd,deleteDoc:()=>jh,deleteField:()=>wd,disableNetwork:()=>dl,disablePersistentCacheIndexAutoCreation:()=>Ad,doc:()=>Wc,documentId:()=>_l,enableIndexedDbPersistence:()=>ol,enableMultiTabIndexedDbPersistence:()=>al,enableNetwork:()=>hl,enablePersistentCacheIndexAutoCreation:()=>Nd,endAt:()=>wh,endBefore:()=>yh,ensureFirestoreConfigured:()=>sl,executeWrite:()=>Yh,getAggregateFromServer:()=>ed,getCountFromServer:()=>Zh,getDoc:()=>Ph,getDocFromCache:()=>Uh,getDocFromServer:()=>Bh,getDocs:()=>zh,getDocsFromCache:()=>Kh,getDocsFromServer:()=>Gh,getFirestore:()=>rl,getPersistentCacheIndexManager:()=>Cd,increment:()=>bd,initializeFirestore:()=>nl,limit:()=>hh,limitToLast:()=>dh,loadBundle:()=>ml,memoryEagerGarbageCollector:()=>id,memoryLocalCache:()=>ad,memoryLruGarbageCollector:()=>od,namedQuery:()=>gl,onSnapshot:()=>Jh,onSnapshotsInSync:()=>Hh,or:()=>oh,orderBy:()=>ch,persistentLocalCache:()=>ud,persistentMultipleTabManager:()=>dd,persistentSingleTabManager:()=>hd,query:()=>nh,queryEqual:()=>Hc,refEqual:()=>Jc,runTransaction:()=>yd,serverTimestamp:()=>vd,setDoc:()=>$h,setIndexConfiguration:()=>Sd,setLogLevel:()=>m,snapshotEqual:()=>Lh,startAfter:()=>gh,startAt:()=>mh,sum:()=>Dh,terminate:()=>fl,updateDoc:()=>Qh,vector:()=>Td,waitForPendingWrites:()=>ll,where:()=>sh,writeBatch:()=>Ed});var r=n(990),s=n(125),i=n(424),o=n(743),a=n(429),u=n(853);const c="@firebase/firestore";class l{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}l.UNAUTHENTICATED=new l(null),l.GOOGLE_CREDENTIALS=new l("google-credentials-uid"),l.FIRST_PARTY=new l("first-party-uid"),l.MOCK_USER=new l("mock-user");let h="10.14.0";const d=new i.Vy("@firebase/firestore");function f(){return d.logLevel}function m(e){d.setLogLevel(e)}function g(e,...t){if(d.logLevel<=i.$b.DEBUG){const n=t.map(w);d.debug(`Firestore (${h}): ${e}`,...n)}}function p(e,...t){if(d.logLevel<=i.$b.ERROR){const n=t.map(w);d.error(`Firestore (${h}): ${e}`,...n)}}function y(e,...t){if(d.logLevel<=i.$b.WARN){const n=t.map(w);d.warn(`Firestore (${h}): ${e}`,...n)}}function w(e){if("string"==typeof e)return e;try{return function(e){return JSON.stringify(e)}(e)}catch(t){return e}}function v(e="Unexpected state"){const t=`FIRESTORE (${h}) INTERNAL ASSERTION FAILED: `+e;throw p(t),new Error(t)}function _(e,t){e||v()}function I(e,t){e||v()}function b(e,t){return e}const T={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class E extends o.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class S{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class x{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class D{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(l.UNAUTHENTICATED)))}shutdown(){}}class C{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class N{constructor(e){this.t=e,this.currentUser=l.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){_(void 0===this.o);let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let s=new S;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new S,e.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const t=s;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},o=e=>{g("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),i())};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(g("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new S)}}),0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(g("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(_("string"==typeof t.accessToken),new x(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const e=this.auth&&this.auth.getUid();return _(null===e||"string"==typeof e),new l(e)}}class A{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=l.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class k{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new A(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable((()=>t(l.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class R{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class F{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){_(void 0===this.o);const n=e=>{null!=e.error&&g("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.R;return this.R=e.token,g("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{g("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit((e=>r(e))),setTimeout((()=>{if(!this.appCheck){const e=this.A.getImmediate({optional:!0});e?r(e):g("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(_("string"==typeof e.token),this.R=e.token,new R(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class V{getToken(){return Promise.resolve(new R(""))}invalidateToken(){}start(e,t){}shutdown(){}}function M(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let t=0;t<e;t++)n[t]=Math.floor(256*Math.random());return n}class O{static newId(){const e=62*Math.floor(256/62);let t="";for(;t.length<20;){const n=M(40);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function L(e,t){return e<t?-1:e>t?1:0}function P(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}function q(e){return e+"\0"}class U{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new E(T.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new E(T.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new E(T.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new E(T.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return U.fromMillis(Date.now())}static fromDate(e){return U.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new U(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?L(this.nanoseconds,e.nanoseconds):L(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class B{constructor(e){this.timestamp=e}static fromTimestamp(e){return new B(e)}static min(){return new B(new U(0,0))}static max(){return new B(new U(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class z{constructor(e,t,n){void 0===t?t=0:t>e.length&&v(),void 0===n?n=e.length-t:n>e.length-t&&v(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===z.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof z?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class K extends z{construct(e,t,n){return new K(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new E(T.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new K(t)}static emptyPath(){return new K([])}}const G=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class $ extends z{construct(e,t,n){return new $(e,t,n)}static isValidIdentifier(e){return G.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),$.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new $(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const s=()=>{if(0===n.length)throw new E(T.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new E(T.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new E(T.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(i=!i,r++):"."!==t||i?(n+=t,r++):(s(),r++)}if(s(),i)throw new E(T.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new $(t)}static emptyPath(){return new $([])}}class Q{constructor(e){this.path=e}static fromPath(e){return new Q(K.fromString(e))}static fromName(e){return new Q(K.fromString(e).popFirst(5))}static empty(){return new Q(K.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===K.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return K.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new Q(new K(e.slice()))}}class j{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function W(e){return e.fields.find((e=>2===e.kind))}function J(e){return e.fields.filter((e=>2!==e.kind))}function H(e,t){let n=L(e.collectionGroup,t.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(e.fields.length,t.fields.length);++r)if(n=X(e.fields[r],t.fields[r]),0!==n)return n;return L(e.fields.length,t.fields.length)}j.UNKNOWN_ID=-1;class Y{constructor(e,t){this.fieldPath=e,this.kind=t}}function X(e,t){const n=$.comparator(e.fieldPath,t.fieldPath);return 0!==n?n:L(e.kind,t.kind)}class Z{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new Z(0,ne.min())}}function ee(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,s=B.fromTimestamp(1e9===r?new U(n+1,0):new U(n,r));return new ne(s,Q.empty(),t)}function te(e){return new ne(e.readTime,e.key,-1)}class ne{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new ne(B.min(),Q.empty(),-1)}static max(){return new ne(B.max(),Q.empty(),-1)}}function re(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=Q.comparator(e.documentKey,t.documentKey),0!==n?n:L(e.largestBatchId,t.largestBatchId))}const se="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ie{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function oe(e){if(e.code!==T.FAILED_PRECONDITION||e.message!==se)throw e;g("LocalStore","Unexpectedly lost primary lease")}class ae{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&v(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new ae(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof ae?t:ae.resolve(t)}catch(e){return ae.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):ae.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):ae.reject(t)}static resolve(e){return new ae(((t,n)=>{t(e)}))}static reject(e){return new ae(((t,n)=>{n(e)}))}static waitFor(e){return new ae(((t,n)=>{let r=0,s=0,i=!1;e.forEach((e=>{++r,e.next((()=>{++s,i&&s===r&&t()}),(e=>n(e)))})),i=!0,s===r&&t()}))}static or(e){let t=ae.resolve(!1);for(const n of e)t=t.next((e=>e?ae.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}static mapArray(e,t){return new ae(((n,r)=>{const s=e.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const u=a;t(e[u]).next((e=>{i[u]=e,++o,o===s&&n(i)}),(e=>r(e)))}}))}static doWhile(e,t){return new ae(((n,r)=>{const s=()=>{!0===e()?t().next((()=>{s()}),r):n()};s()}))}}class ue{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new S,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new de(e,t.error)):this.V.resolve()},this.transaction.onerror=t=>{const n=ye(t.target.error);this.V.reject(new de(e,n))}}static open(e,t,n,r){try{return new ue(t,e.transaction(r,n))}catch(e){throw new de(t,e)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(g("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new me(t)}}class ce{constructor(e,t,n){this.name=e,this.version=t,this.p=n,12.2===ce.S((0,o.ZQ)())&&p("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return g("SimpleDb","Removing database:",e),ge(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!(0,o.zW)())return!1;if(ce.v())return!0;const e=(0,o.ZQ)(),t=ce.S(e),n=0<t&&t<10,r=le(e),s=0<r&&r<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static v(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.__PRIVATE_env)||void 0===e?void 0:e.C)}static F(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}async M(e){return this.db||(g("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{const n=e.target.result;t(n)},r.onblocked=()=>{n(new de(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const r=t.target.error;"VersionError"===r.name?n(new E(T.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new E(T.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new de(e,r))},r.onupgradeneeded=e=>{g("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.p.O(t,r.transaction,e.oldVersion,this.version).next((()=>{g("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.N&&(this.db.onversionchange=e=>this.N(e)),this.db}L(e){this.N=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){const s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.M(e);const t=ue.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next((e=>(t.g(),e))).catch((e=>(t.abort(e),ae.reject(e)))).toPromise();return i.catch((()=>{})),await t.m,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(g("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function le(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}class he{constructor(e){this.B=e,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(e){this.B=e}done(){this.k=!0}$(e){this.q=e}delete(){return ge(this.B.delete())}}class de extends E{constructor(e,t){super(T.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function fe(e){return"IndexedDbTransactionError"===e.name}class me{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(g("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(g("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),ge(n)}add(e){return g("SimpleDb","ADD",this.store.name,e,e),ge(this.store.add(e))}get(e){return ge(this.store.get(e)).next((t=>(void 0===t&&(t=null),g("SimpleDb","GET",this.store.name,e,t),t)))}delete(e){return g("SimpleDb","DELETE",this.store.name,e),ge(this.store.delete(e))}count(){return g("SimpleDb","COUNT",this.store.name),ge(this.store.count())}U(e,t){const n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){const e=r.getAll(n.range);return new ae(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}{const e=this.cursor(n),t=[];return this.W(e,((e,n)=>{t.push(n)})).next((()=>t))}}G(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new ae(((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}}))}j(e,t){g("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.H=!1;const r=this.cursor(n);return this.W(r,((e,t,n)=>n.delete()))}J(e,t){let n;t?n=e:(n={},t=e);const r=this.cursor(n);return this.W(r,t)}Y(e){const t=this.cursor({});return new ae(((n,r)=>{t.onerror=e=>{const t=ye(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next((e=>{e?r.continue():n()})):n()}}))}W(e,t){const n=[];return new ae(((r,s)=>{e.onerror=e=>{s(e.target.error)},e.onsuccess=e=>{const s=e.target.result;if(!s)return void r();const i=new he(s),o=t(s.primaryKey,s.value,i);if(o instanceof ae){const e=o.catch((e=>(i.done(),ae.reject(e))));n.push(e)}i.isDone?r():null===i.K?s.continue():s.continue(i.K)}})).next((()=>ae.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.H?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function ge(e){return new ae(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=ye(e.target.error);n(t)}}))}let pe=!1;function ye(e){const t=ce.S((0,o.ZQ)());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new E("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return pe||(pe=!0,setTimeout((()=>{throw e}),0)),e}}return e}class we{constructor(e,t){this.asyncQueue=e,this.Z=t,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}X(e){g("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(async()=>{this.task=null;try{g("IndexBackfiller",`Documents written: ${await this.Z.ee()}`)}catch(e){fe(e)?g("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",e):await oe(e)}await this.X(6e4)}))}}class ve{constructor(e,t){this.localStore=e,this.persistence=t}async ee(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(t=>this.te(t,e)))}te(e,t){const n=new Set;let r=t,s=!0;return ae.doWhile((()=>!0===s&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next((t=>{if(null!==t&&!n.has(t))return g("IndexBackfiller",`Processing collection: ${t}`),this.ne(e,t,r).next((e=>{r-=e,n.add(t)}));s=!1})))).next((()=>t-r))}ne(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next((r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next((n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(e,s).next((()=>this.re(r,n))).next((n=>(g("IndexBackfiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n)))).next((()=>s.size))}))))}re(e,t){let n=e;return t.changes.forEach(((e,t)=>{const r=te(t);re(r,n)>0&&(n=r)})),new ne(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class _e{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ie(e),this.se=e=>t.writeSequenceNumber(e))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.se&&this.se(e),e}}function Ie(e){return null==e}function be(e){return 0===e&&1/e==-1/0}function Te(e){return"number"==typeof e&&Number.isInteger(e)&&!be(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Ee(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=xe(t)),t=Se(e.get(n),t);return xe(t)}function Se(e,t){let n=t;const r=e.length;for(let t=0;t<r;t++){const r=e.charAt(t);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}function xe(e){return e+""}function De(e){const t=e.length;if(_(t>=2),2===t)return _(""===e.charAt(0)&&""===e.charAt(1)),K.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf("",i);switch((t<0||t>n)&&v(),e.charAt(t+1)){case"":const n=e.substring(i,t);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"":s+=e.substring(i,t),s+="\0";break;case"":s+=e.substring(i,t+1);break;default:v()}i=t+2}return new K(r)}_e.oe=-1;const Ce=["userId","batchId"];function Ne(e,t){return[e,Ee(t)]}function Ae(e,t,n){return[e,Ee(t),n]}const ke={},Re=["prefixPath","collectionGroup","readTime","documentId"],Fe=["prefixPath","collectionGroup","documentId"],Ve=["collectionGroup","readTime","prefixPath","documentId"],Me=["canonicalId","targetId"],Oe=["targetId","path"],Le=["path","targetId"],Pe=["collectionId","parent"],qe=["indexId","uid"],Ue=["uid","sequenceNumber"],Be=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],ze=["indexId","uid","orderedDocumentKey"],Ke=["userId","collectionPath","documentId"],Ge=["userId","collectionPath","largestBatchId"],$e=["userId","collectionGroup","largestBatchId"],Qe=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],je=[...Qe,"documentOverlays"],We=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Je=We,He=[...Je,"indexConfiguration","indexState","indexEntries"],Ye=He,Xe=[...He,"globals"];class Ze extends ie{constructor(e,t){super(),this._e=e,this.currentSequenceNumber=t}}function et(e,t){const n=b(e);return ce.F(n._e,t)}function tt(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function nt(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function rt(e,t){const n=[];for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.push(t(e[r],r,e));return n}function st(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class it{constructor(e,t){this.comparator=e,this.root=t||at.EMPTY}insert(e,t){return new it(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,at.BLACK,null,null))}remove(e){return new it(this.comparator,this.root.remove(e,this.comparator).copy(null,null,at.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new ot(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new ot(this.root,e,this.comparator,!1)}getReverseIterator(){return new ot(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new ot(this.root,e,this.comparator,!0)}}class ot{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class at{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:at.RED,this.left=null!=r?r:at.EMPTY,this.right=null!=s?s:at.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new at(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return at.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return at.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,at.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,at.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw v();if(this.right.isRed())throw v();const e=this.left.check();if(e!==this.right.check())throw v();return e+(this.isRed()?0:1)}}at.EMPTY=null,at.RED=!0,at.BLACK=!1,at.EMPTY=new class{constructor(){this.size=0}get key(){throw v()}get value(){throw v()}get color(){throw v()}get left(){throw v()}get right(){throw v()}copy(e,t,n,r,s){return this}insert(e,t,n){return new at(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class ut{constructor(e){this.comparator=e,this.data=new it(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new ct(this.data.getIterator())}getIteratorFrom(e){return new ct(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof ut))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new ut(this.comparator);return t.data=e,t}}class ct{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function lt(e){return e.hasNext()?e.getNext():void 0}class ht{constructor(e){this.fields=e,e.sort($.comparator)}static empty(){return new ht([])}unionWith(e){let t=new ut($.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new ht(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return P(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class dt extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function ft(){return"undefined"!=typeof atob}class mt{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new dt("Invalid base64 string: "+e):e}}(e);return new mt(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new mt(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return L(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}mt.EMPTY_BYTE_STRING=new mt("");const gt=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function pt(e){if(_(!!e),"string"==typeof e){let t=0;const n=gt.exec(e);if(_(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:yt(e.seconds),nanos:yt(e.nanos)}}function yt(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function wt(e){return"string"==typeof e?mt.fromBase64String(e):mt.fromUint8Array(e)}function vt(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function _t(e){const t=e.mapValue.fields.__previous_value__;return vt(t)?_t(t):t}function It(e){const t=pt(e.mapValue.fields.__local_write_time__.timestampValue);return new U(t.seconds,t.nanos)}class bt{constructor(e,t,n,r,s,i,o,a,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=u}}class Tt{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Tt("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Tt&&e.projectId===this.projectId&&e.database===this.database}}const Et={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},St={nullValue:"NULL_VALUE"};function xt(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?vt(e)?4:Kt(e)?9007199254740991:Bt(e)?10:11:v()}function Dt(e,t){if(e===t)return!0;const n=xt(e);if(n!==xt(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return It(e).isEqual(It(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=pt(e.timestampValue),r=pt(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return wt(e.bytesValue).isEqual(wt(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return yt(e.geoPointValue.latitude)===yt(t.geoPointValue.latitude)&&yt(e.geoPointValue.longitude)===yt(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return yt(e.integerValue)===yt(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=yt(e.doubleValue),r=yt(t.doubleValue);return n===r?be(n)===be(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return P(e.arrayValue.values||[],t.arrayValue.values||[],Dt);case 10:case 11:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(tt(n)!==tt(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!Dt(n[e],r[e])))return!1;return!0}(e,t);default:return v()}}function Ct(e,t){return void 0!==(e.values||[]).find((e=>Dt(e,t)))}function Nt(e,t){if(e===t)return 0;const n=xt(e),r=xt(t);if(n!==r)return L(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return L(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=yt(e.integerValue||e.doubleValue),r=yt(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return At(e.timestampValue,t.timestampValue);case 4:return At(It(e),It(t));case 5:return L(e.stringValue,t.stringValue);case 6:return function(e,t){const n=wt(e),r=wt(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){const t=L(n[e],r[e]);if(0!==t)return t}return L(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=L(yt(e.latitude),yt(t.latitude));return 0!==n?n:L(yt(e.longitude),yt(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return kt(e.arrayValue,t.arrayValue);case 10:return function(e,t){var n,r,s,i;const o=e.fields||{},a=t.fields||{},u=null===(n=o.value)||void 0===n?void 0:n.arrayValue,c=null===(r=a.value)||void 0===r?void 0:r.arrayValue,l=L((null===(s=null==u?void 0:u.values)||void 0===s?void 0:s.length)||0,(null===(i=null==c?void 0:c.values)||void 0===i?void 0:i.length)||0);return 0!==l?l:kt(u,c)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===Et.mapValue&&t===Et.mapValue)return 0;if(e===Et.mapValue)return 1;if(t===Et.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let e=0;e<r.length&&e<i.length;++e){const t=L(r[e],i[e]);if(0!==t)return t;const o=Nt(n[r[e]],s[i[e]]);if(0!==o)return o}return L(r.length,i.length)}(e.mapValue,t.mapValue);default:throw v()}}function At(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return L(e,t);const n=pt(e),r=pt(t),s=L(n.seconds,r.seconds);return 0!==s?s:L(n.nanos,r.nanos)}function kt(e,t){const n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){const t=Nt(n[e],r[e]);if(t)return t}return L(n.length,r.length)}function Rt(e){return Ft(e)}function Ft(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=pt(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?function(e){return wt(e).toBase64()}(e.bytesValue):"referenceValue"in e?function(e){return Q.fromName(e).toString()}(e.referenceValue):"geoPointValue"in e?function(e){return`geo(${e.latitude},${e.longitude})`}(e.geoPointValue):"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=Ft(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${Ft(e.fields[s])}`;return n+"}"}(e.mapValue):v()}function Vt(e){switch(xt(e)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const t=_t(e);return t?16+Vt(t):16;case 5:return 2*e.stringValue.length;case 6:return wt(e.bytesValue).approximateByteSize();case 7:return e.referenceValue.length;case 9:return function(e){return(e.values||[]).reduce(((e,t)=>e+Vt(t)),0)}(e.arrayValue);case 10:case 11:return function(e){let t=0;return nt(e.fields,((e,n)=>{t+=e.length+Vt(n)})),t}(e.mapValue);default:throw v()}}function Mt(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Ot(e){return!!e&&"integerValue"in e}function Lt(e){return!!e&&"arrayValue"in e}function Pt(e){return!!e&&"nullValue"in e}function qt(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Ut(e){return!!e&&"mapValue"in e}function Bt(e){var t,n;return"__vector__"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function zt(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return nt(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=zt(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=zt(e.arrayValue.values[n]);return t}return Object.assign({},e)}function Kt(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}const Gt={mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{}}}}};function $t(e){return"nullValue"in e?St:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?Mt(Tt.empty(),Q.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?Bt(e)?Gt:{mapValue:{}}:v()}function Qt(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?Mt(Tt.empty(),Q.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?Gt:"mapValue"in e?Bt(e)?{mapValue:{}}:Et:v()}function jt(e,t){const n=Nt(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Wt(e,t){const n=Nt(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Jt{constructor(e){this.value=e}static empty(){return new Jt({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!Ut(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=zt(t)}setAll(e){let t=$.emptyPath(),n={},r=[];e.forEach(((e,s)=>{if(!t.isImmediateParentOf(s)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=s.popLast()}e?n[s.lastSegment()]=zt(e):r.push(s.lastSegment())}));const s=this.getFieldsMap(t);this.applyChanges(s,n,r)}delete(e){const t=this.field(e.popLast());Ut(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Dt(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];Ut(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){nt(t,((t,n)=>e[t]=n));for(const t of n)delete e[t]}clone(){return new Jt(zt(this.value))}}function Ht(e){const t=[];return nt(e.fields,((e,n)=>{const r=new $([e]);if(Ut(n)){const e=Ht(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new ht(t)}class Yt{constructor(e,t,n,r,s,i,o){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(e){return new Yt(e,0,B.min(),B.min(),B.min(),Jt.empty(),0)}static newFoundDocument(e,t,n,r){return new Yt(e,1,t,B.min(),n,r,0)}static newNoDocument(e,t){return new Yt(e,2,t,B.min(),B.min(),Jt.empty(),0)}static newUnknownDocument(e,t){return new Yt(e,3,t,B.min(),B.min(),Jt.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(B.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Jt.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Jt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=B.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Yt&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Yt(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Xt{constructor(e,t){this.position=e,this.inclusive=t}}function Zt(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(r=i.field.isKeyField()?Q.comparator(Q.fromName(o.referenceValue),n.key):Nt(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function en(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!Dt(e.position[n],t.position[n]))return!1;return!0}class tn{constructor(e,t="asc"){this.field=e,this.dir=t}}function nn(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class rn{}class sn extends rn{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new gn(e,t,n):"array-contains"===t?new vn(e,n):"in"===t?new _n(e,n):"not-in"===t?new In(e,n):"array-contains-any"===t?new bn(e,n):new sn(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new pn(e,n):new yn(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Nt(t,this.value)):null!==t&&xt(this.value)===xt(t)&&this.matchesComparison(Nt(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return v()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class on extends rn{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new on(e,t)}matches(e){return an(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.ae||(this.ae=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function an(e){return"and"===e.op}function un(e){return"or"===e.op}function cn(e){return ln(e)&&an(e)}function ln(e){for(const t of e.filters)if(t instanceof on)return!1;return!0}function hn(e){if(e instanceof sn)return e.field.canonicalString()+e.op.toString()+Rt(e.value);if(cn(e))return e.filters.map((e=>hn(e))).join(",");{const t=e.filters.map((e=>hn(e))).join(",");return`${e.op}(${t})`}}function dn(e,t){return e instanceof sn?function(e,t){return t instanceof sn&&e.op===t.op&&e.field.isEqual(t.field)&&Dt(e.value,t.value)}(e,t):e instanceof on?function(e,t){return t instanceof on&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce(((e,n,r)=>e&&dn(n,t.filters[r])),!0)}(e,t):void v()}function fn(e,t){const n=e.filters.concat(t);return on.create(n,e.op)}function mn(e){return e instanceof sn?function(e){return`${e.field.canonicalString()} ${e.op} ${Rt(e.value)}`}(e):e instanceof on?function(e){return e.op.toString()+" {"+e.getFilters().map(mn).join(" ,")+"}"}(e):"Filter"}class gn extends sn{constructor(e,t,n){super(e,t,n),this.key=Q.fromName(n.referenceValue)}matches(e){const t=Q.comparator(e.key,this.key);return this.matchesComparison(t)}}class pn extends sn{constructor(e,t){super(e,"in",t),this.keys=wn(0,t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class yn extends sn{constructor(e,t){super(e,"not-in",t),this.keys=wn(0,t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function wn(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>Q.fromName(e.referenceValue)))}class vn extends sn{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Lt(t)&&Ct(t.arrayValue,this.value)}}class _n extends sn{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&Ct(this.value.arrayValue,t)}}class In extends sn{constructor(e,t){super(e,"not-in",t)}matches(e){if(Ct(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!Ct(this.value.arrayValue,t)}}class bn extends sn{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Lt(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>Ct(this.value.arrayValue,e)))}}class Tn{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.ue=null}}function En(e,t=null,n=[],r=[],s=null,i=null,o=null){return new Tn(e,t,n,r,s,i,o)}function Sn(e){const t=b(e);if(null===t.ue){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>hn(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),Ie(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>Rt(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>Rt(e))).join(",")),t.ue=e}return t.ue}function xn(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!nn(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!dn(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!en(e.startAt,t.startAt)&&en(e.endAt,t.endAt)}function Dn(e){return Q.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function Cn(e,t){return e.filters.filter((e=>e instanceof sn&&e.field.isEqual(t)))}function Nn(e,t,n){let r=St,s=!0;for(const n of Cn(e,t)){let e=St,t=!0;switch(n.op){case"<":case"<=":e=$t(n.value);break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=St}jt({value:r,inclusive:s},{value:e,inclusive:t})<0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];jt({value:r,inclusive:s},{value:e,inclusive:n.inclusive})<0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}function An(e,t,n){let r=Et,s=!0;for(const n of Cn(e,t)){let e=Et,t=!0;switch(n.op){case">=":case">":e=Qt(n.value),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=Et}Wt({value:r,inclusive:s},{value:e,inclusive:t})>0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Wt({value:r,inclusive:s},{value:e,inclusive:n.inclusive})>0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}class kn{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}}function Rn(e,t,n,r,s,i,o,a){return new kn(e,t,n,r,s,i,o,a)}function Fn(e){return new kn(e)}function Vn(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Mn(e){return null!==e.collectionGroup}function On(e){const t=b(e);if(null===t.ce){t.ce=[];const e=new Set;for(const n of t.explicitOrderBy)t.ce.push(n),e.add(n.field.canonicalString());const n=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc",r=function(e){let t=new ut($.comparator);return e.filters.forEach((e=>{e.getFlattenedFilters().forEach((e=>{e.isInequality()&&(t=t.add(e.field))}))})),t}(t);r.forEach((r=>{e.has(r.canonicalString())||r.isKeyField()||t.ce.push(new tn(r,n))})),e.has($.keyField().canonicalString())||t.ce.push(new tn($.keyField(),n))}return t.ce}function Ln(e){const t=b(e);return t.le||(t.le=qn(t,On(e))),t.le}function Pn(e){const t=b(e);return t.he||(t.he=qn(t,e.explicitOrderBy)),t.he}function qn(e,t){if("F"===e.limitType)return En(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map((e=>{const t="desc"===e.dir?"asc":"desc";return new tn(e.field,t)}));const n=e.endAt?new Xt(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new Xt(e.startAt.position,e.startAt.inclusive):null;return En(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}function Un(e,t){const n=e.filters.concat([t]);return new kn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function Bn(e,t,n){return new kn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function zn(e,t){return xn(Ln(e),Ln(t))&&e.limitType===t.limitType}function Kn(e){return`${Sn(Ln(e))}|lt:${e.limitType}`}function Gn(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>mn(e))).join(", ")}]`),Ie(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>Rt(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>Rt(e))).join(",")),`Target(${t})`}(Ln(e))}; limitType=${e.limitType})`}function $n(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):Q.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of On(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=Zt(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,On(e),t)||e.endAt&&!function(e,t,n){const r=Zt(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,On(e),t))}(e,t)}function Qn(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function jn(e){return(t,n)=>{let r=!1;for(const s of On(e)){const e=Wn(s,t,n);if(0!==e)return e;r=r||s.field.isKeyField()}return 0}}function Wn(e,t,n){const r=e.field.isKeyField()?Q.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),s=n.data.field(e);return null!==r&&null!==s?Nt(r,s):v()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return v()}}class Jn{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){nt(this.inner,((t,n)=>{for(const[t,r]of n)e(t,r)}))}isEmpty(){return st(this.inner)}size(){return this.innerSize}}const Hn=new it(Q.comparator);function Yn(){return Hn}const Xn=new it(Q.comparator);function Zn(...e){let t=Xn;for(const n of e)t=t.insert(n.key,n);return t}function er(e){let t=Xn;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function tr(){return rr()}function nr(){return rr()}function rr(){return new Jn((e=>e.toString()),((e,t)=>e.isEqual(t)))}const sr=new it(Q.comparator),ir=new ut(Q.comparator);function or(...e){let t=ir;for(const n of e)t=t.add(n);return t}const ar=new ut(L);function ur(){return ar}function cr(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:be(t)?"-0":t}}function lr(e){return{integerValue:""+e}}function hr(e,t){return Te(t)?lr(t):cr(e,t)}class dr{constructor(){this._=void 0}}function fr(e,t,n){return e instanceof pr?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&vt(t)&&(t=_t(t)),t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof yr?wr(e,t):e instanceof vr?_r(e,t):function(e,t){const n=gr(e,t),r=br(n)+br(e.Pe);return Ot(n)&&Ot(e.Pe)?lr(r):cr(e.serializer,r)}(e,t)}function mr(e,t,n){return e instanceof yr?wr(e,t):e instanceof vr?_r(e,t):n}function gr(e,t){return e instanceof Ir?function(e){return Ot(e)||function(e){return!!e&&"doubleValue"in e}(e)}(t)?t:{integerValue:0}:null}class pr extends dr{}class yr extends dr{constructor(e){super(),this.elements=e}}function wr(e,t){const n=Tr(t);for(const t of e.elements)n.some((e=>Dt(e,t)))||n.push(t);return{arrayValue:{values:n}}}class vr extends dr{constructor(e){super(),this.elements=e}}function _r(e,t){let n=Tr(t);for(const t of e.elements)n=n.filter((e=>!Dt(e,t)));return{arrayValue:{values:n}}}class Ir extends dr{constructor(e,t){super(),this.serializer=e,this.Pe=t}}function br(e){return yt(e.integerValue||e.doubleValue)}function Tr(e){return Lt(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class Er{constructor(e,t){this.field=e,this.transform=t}}class Sr{constructor(e,t){this.version=e,this.transformResults=t}}class xr{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new xr}static exists(e){return new xr(void 0,e)}static updateTime(e){return new xr(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function Dr(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class Cr{}function Nr(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new qr(e.key,xr.none()):new Vr(e.key,e.data,xr.none());{const n=e.data,r=Jt.empty();let s=new ut($.comparator);for(let e of t.fields)if(!s.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),s=s.add(e)}return new Mr(e.key,r,new ht(s.toArray()),xr.none())}}function Ar(e,t,n){e instanceof Vr?function(e,t,n){const r=e.value.clone(),s=Lr(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof Mr?function(e,t,n){if(!Dr(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=Lr(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(Or(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function kr(e,t,n,r){return e instanceof Vr?function(e,t,n,r){if(!Dr(e.precondition,t))return n;const s=e.value.clone(),i=Pr(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof Mr?function(e,t,n,r){if(!Dr(e.precondition,t))return n;const s=Pr(e.fieldTransforms,r,t),i=t.data;return i.setAll(Or(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,r):function(e,t,n){return Dr(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function Rr(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=gr(r.transform,e||null);null!=s&&(null===n&&(n=Jt.empty()),n.set(r.field,s))}return n||null}function Fr(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&P(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof yr&&t instanceof yr||e instanceof vr&&t instanceof vr?P(e.elements,t.elements,Dt):e instanceof Ir&&t instanceof Ir?Dt(e.Pe,t.Pe):e instanceof pr&&t instanceof pr}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class Vr extends Cr{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class Mr extends Cr{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function Or(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function Lr(e,t,n){const r=new Map;_(e.length===n.length);for(let s=0;s<n.length;s++){const i=e[s],o=i.transform,a=t.data.field(i.field);r.set(i.field,mr(o,a,n[s]))}return r}function Pr(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,fr(e,i,t))}return r}class qr extends Cr{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Ur extends Cr{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Br{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const r=this.mutations[t];r.key.isEqual(e.key)&&Ar(r,e,n[t])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=kr(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=kr(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=nr();return this.mutations.forEach((r=>{const s=e.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=t.has(r.key)?null:o;const a=Nr(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(B.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),or())}isEqual(e){return this.batchId===e.batchId&&P(this.mutations,e.mutations,((e,t)=>Fr(e,t)))&&P(this.baseMutations,e.baseMutations,((e,t)=>Fr(e,t)))}}class zr{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){_(e.mutations.length===n.length);let r=sr;const s=e.mutations;for(let e=0;e<s.length;e++)r=r.insert(s[e].key,n[e].version);return new zr(e,t,n,r)}}class Kr{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Gr{constructor(e,t,n){this.alias=e,this.aggregateType=t,this.fieldPath=n}}class $r{constructor(e,t){this.count=e,this.unchangedNames=t}}var Qr,jr;function Wr(e){switch(e){default:return v();case T.CANCELLED:case T.UNKNOWN:case T.DEADLINE_EXCEEDED:case T.RESOURCE_EXHAUSTED:case T.INTERNAL:case T.UNAVAILABLE:case T.UNAUTHENTICATED:return!1;case T.INVALID_ARGUMENT:case T.NOT_FOUND:case T.ALREADY_EXISTS:case T.PERMISSION_DENIED:case T.FAILED_PRECONDITION:case T.ABORTED:case T.OUT_OF_RANGE:case T.UNIMPLEMENTED:case T.DATA_LOSS:return!0}}function Jr(e){if(void 0===e)return p("GRPC error has no .code"),T.UNKNOWN;switch(e){case Qr.OK:return T.OK;case Qr.CANCELLED:return T.CANCELLED;case Qr.UNKNOWN:return T.UNKNOWN;case Qr.DEADLINE_EXCEEDED:return T.DEADLINE_EXCEEDED;case Qr.RESOURCE_EXHAUSTED:return T.RESOURCE_EXHAUSTED;case Qr.INTERNAL:return T.INTERNAL;case Qr.UNAVAILABLE:return T.UNAVAILABLE;case Qr.UNAUTHENTICATED:return T.UNAUTHENTICATED;case Qr.INVALID_ARGUMENT:return T.INVALID_ARGUMENT;case Qr.NOT_FOUND:return T.NOT_FOUND;case Qr.ALREADY_EXISTS:return T.ALREADY_EXISTS;case Qr.PERMISSION_DENIED:return T.PERMISSION_DENIED;case Qr.FAILED_PRECONDITION:return T.FAILED_PRECONDITION;case Qr.ABORTED:return T.ABORTED;case Qr.OUT_OF_RANGE:return T.OUT_OF_RANGE;case Qr.UNIMPLEMENTED:return T.UNIMPLEMENTED;case Qr.DATA_LOSS:return T.DATA_LOSS;default:return v()}}(jr=Qr||(Qr={}))[jr.OK=0]="OK",jr[jr.CANCELLED=1]="CANCELLED",jr[jr.UNKNOWN=2]="UNKNOWN",jr[jr.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",jr[jr.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",jr[jr.NOT_FOUND=5]="NOT_FOUND",jr[jr.ALREADY_EXISTS=6]="ALREADY_EXISTS",jr[jr.PERMISSION_DENIED=7]="PERMISSION_DENIED",jr[jr.UNAUTHENTICATED=16]="UNAUTHENTICATED",jr[jr.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",jr[jr.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",jr[jr.ABORTED=10]="ABORTED",jr[jr.OUT_OF_RANGE=11]="OUT_OF_RANGE",jr[jr.UNIMPLEMENTED=12]="UNIMPLEMENTED",jr[jr.INTERNAL=13]="INTERNAL",jr[jr.UNAVAILABLE=14]="UNAVAILABLE",jr[jr.DATA_LOSS=15]="DATA_LOSS";let Hr=null;function Yr(){return new TextEncoder}const Xr=new a.jz([4294967295,4294967295],0);function Zr(e){const t=Yr().encode(e),n=new a.VV;return n.update(t),new Uint8Array(n.digest())}function es(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),s=t.getUint32(8,!0),i=t.getUint32(12,!0);return[new a.jz([n,r],0),new a.jz([s,i],0)]}class ts{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new ns(`Invalid padding: ${t}`);if(n<0)throw new ns(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new ns(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new ns(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=a.jz.fromNumber(this.Ie)}Ee(e,t,n){let r=e.add(t.multiply(a.jz.fromNumber(n)));return 1===r.compare(Xr)&&(r=new a.jz([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Te).toNumber()}de(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ie)return!1;const t=Zr(e),[n,r]=es(t);for(let e=0;e<this.hashCount;e++){const t=this.Ee(n,r,e);if(!this.de(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),i=new ts(s,r,t);return n.forEach((e=>i.insert(e))),i}insert(e){if(0===this.Ie)return;const t=Zr(e),[n,r]=es(t);for(let e=0;e<this.hashCount;e++){const t=this.Ee(n,r,e);this.Ae(t)}}Ae(e){const t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}class ns extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class rs{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,ss.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new rs(B.min(),r,new it(L),Yn(),or())}}class ss{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new ss(n,t,or(),or(),or())}}class is{constructor(e,t,n,r){this.Re=e,this.removedTargetIds=t,this.key=n,this.Ve=r}}class os{constructor(e,t){this.targetId=e,this.me=t}}class as{constructor(e,t,n=mt.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class us{constructor(){this.fe=0,this.ge=hs(),this.pe=mt.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return 0!==this.fe}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}ve(){let e=or(),t=or(),n=or();return this.ge.forEach(((r,s)=>{switch(s){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:v()}})),new ss(this.pe,this.ye,e,t,n)}Ce(){this.we=!1,this.ge=hs()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,_(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}}class cs{constructor(e){this.Le=e,this.Be=new Map,this.ke=Yn(),this.qe=ls(),this.Qe=new it(L)}Ke(e){for(const t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(const t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,(t=>{const n=this.Ge(t);switch(e.state){case 0:this.ze(t)&&n.De(e.resumeToken);break;case 1:n.Oe(),n.Se||n.Ce(),n.De(e.resumeToken);break;case 2:n.Oe(),n.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(n.Ne(),n.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),n.De(e.resumeToken));break;default:v()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach(((e,n)=>{this.ze(n)&&t(n)}))}He(e){const t=e.targetId,n=e.me.count,r=this.Je(t);if(r){const s=r.target;if(Dn(s))if(0===n){const e=new Q(s.path);this.Ue(t,e,Yt.newNoDocument(e,B.min()))}else _(1===n);else{const r=this.Ye(t);if(r!==n){const n=this.Ze(e),s=n?this.Xe(n,e,r):1;if(0!==s){this.je(t);const e=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(t,e)}null==Hr||Hr.et(function(e,t,n,r,s){var i,o,a,u,c,l;const h={localCacheCount:e,existenceFilterCount:t.count,databaseId:n.database,projectId:n.projectId},d=t.unchangedNames;return d&&(h.bloomFilter={applied:0===s,hashCount:null!==(i=null==d?void 0:d.hashCount)&&void 0!==i?i:0,bitmapLength:null!==(u=null===(a=null===(o=null==d?void 0:d.bits)||void 0===o?void 0:o.bitmap)||void 0===a?void 0:a.length)&&void 0!==u?u:0,padding:null!==(l=null===(c=null==d?void 0:d.bits)||void 0===c?void 0:c.padding)&&void 0!==l?l:0,mightContain:e=>{var t;return null!==(t=null==r?void 0:r.mightContain(e))&&void 0!==t&&t}}),h}(r,e.me,this.Le.tt(),n,s))}}}}Ze(e){const t=e.me.unchangedNames;if(!t||!t.bits)return null;const{bits:{bitmap:n="",padding:r=0},hashCount:s=0}=t;let i,o;try{i=wt(n).toUint8Array()}catch(e){if(e instanceof dt)return y("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{o=new ts(i,r,s)}catch(e){return y(e instanceof ns?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===o.Ie?null:o}Xe(e,t,n){return t.me.count===n-this.nt(e,t.targetId)?0:2}nt(e,t){const n=this.Le.getRemoteKeysForTarget(t);let r=0;return n.forEach((n=>{const s=this.Le.tt(),i=`projects/${s.projectId}/databases/${s.database}/documents/${n.path.canonicalString()}`;e.mightContain(i)||(this.Ue(t,n,null),r++)})),r}rt(e){const t=new Map;this.Be.forEach(((n,r)=>{const s=this.Je(r);if(s){if(n.current&&Dn(s.target)){const t=new Q(s.target.path);null!==this.ke.get(t)||this.it(r,t)||this.Ue(r,t,Yt.newNoDocument(t,e))}n.be&&(t.set(r,n.ve()),n.Ce())}}));let n=or();this.qe.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.Je(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))})),this.ke.forEach(((t,n)=>n.setReadTime(e)));const r=new rs(e,t,this.Qe,this.ke,n);return this.ke=Yn(),this.qe=ls(),this.Qe=new it(L),r}$e(e,t){if(!this.ze(e))return;const n=this.it(e,t.key)?2:0;this.Ge(e).Fe(t.key,n),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,n){if(!this.ze(e))return;const r=this.Ge(e);this.it(e,t)?r.Fe(t,1):r.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),n&&(this.ke=this.ke.insert(t,n))}removeTarget(e){this.Be.delete(e)}Ye(e){const t=this.Ge(e).ve();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new us,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new ut(L),this.qe=this.qe.insert(e,t)),t}ze(e){const t=null!==this.Je(e);return t||g("WatchChangeAggregator","Detected inactive target",e),t}Je(e){const t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new us),this.Le.getRemoteKeysForTarget(e).forEach((t=>{this.Ue(e,t,null)}))}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function ls(){return new it(Q.comparator)}function hs(){return new it(Q.comparator)}const ds={asc:"ASCENDING",desc:"DESCENDING"},fs={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},ms={and:"AND",or:"OR"};class gs{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function ps(e,t){return e.useProto3Json||Ie(t)?t:{value:t}}function ys(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function ws(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function vs(e,t){return ys(e,t.toTimestamp())}function _s(e){return _(!!e),B.fromTimestamp(function(e){const t=pt(e);return new U(t.seconds,t.nanos)}(e))}function Is(e,t){return bs(e,t).canonicalString()}function bs(e,t){const n=function(e){return new K(["projects",e.projectId,"databases",e.database])}(e).child("documents");return void 0===t?n:n.child(t)}function Ts(e){const t=K.fromString(e);return _(Qs(t)),t}function Es(e,t){return Is(e.databaseId,t.path)}function Ss(e,t){const n=Ts(t);if(n.get(1)!==e.databaseId.projectId)throw new E(T.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new E(T.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new Q(Ns(n))}function xs(e,t){return Is(e.databaseId,t)}function Ds(e){const t=Ts(e);return 4===t.length?K.emptyPath():Ns(t)}function Cs(e){return new K(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function Ns(e){return _(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function As(e,t,n){return{name:Es(e,t),fields:n.value.mapValue.fields}}function ks(e,t,n){const r=Ss(e,t.name),s=_s(t.updateTime),i=t.createTime?_s(t.createTime):B.min(),o=new Jt({mapValue:{fields:t.fields}}),a=Yt.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function Rs(e,t){let n;if(t instanceof Vr)n={update:As(e,t.key,t.value)};else if(t instanceof qr)n={delete:Es(e,t.key)};else if(t instanceof Mr)n={update:As(e,t.key,t.data),updateMask:$s(t.fieldMask)};else{if(!(t instanceof Ur))return v();n={verify:Es(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof pr)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof yr)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof vr)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Ir)return{fieldPath:t.field.canonicalString(),increment:n.Pe};throw v()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:vs(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:v()}(e,t.precondition)),n}function Fs(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?xr.updateTime(_s(e.updateTime)):void 0!==e.exists?xr.exists(e.exists):xr.none()}(t.currentDocument):xr.none(),r=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)_("REQUEST_TIME"===t.setToServerValue),n=new pr;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new yr(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new vr(e)}else"increment"in t?n=new Ir(e,t.increment):v();const r=$.fromServerFormat(t.fieldPath);return new Er(r,n)}(e,t))):[];if(t.update){t.update.name;const s=Ss(e,t.update.name),i=new Jt({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new ht(t.map((e=>$.fromServerFormat(e))))}(t.updateMask);return new Mr(s,i,e,n,r)}return new Vr(s,i,n,r)}if(t.delete){const r=Ss(e,t.delete);return new qr(r,n)}if(t.verify){const r=Ss(e,t.verify);return new Ur(r,n)}return v()}function Vs(e,t){return{documents:[xs(e,t.path)]}}function Ms(e,t){const n={structuredQuery:{}},r=t.path;let s;null!==t.collectionGroup?(s=r,n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(s=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=xs(e,s);const i=function(e){if(0!==e.length)return Gs(on.create(e,"and"))}(t.filters);i&&(n.structuredQuery.where=i);const o=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:zs(e.field),direction:qs(e.dir)}}(e)))}(t.orderBy);o&&(n.structuredQuery.orderBy=o);const a=ps(e,t.limit);return null!==a&&(n.structuredQuery.limit=a),t.startAt&&(n.structuredQuery.startAt=function(e){return{before:e.inclusive,values:e.position}}(t.startAt)),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),{_t:n,parent:s}}function Os(e,t,n,r){const{_t:s,parent:i}=Ms(e,t),o={},a=[];let u=0;return n.forEach((e=>{const t=r?e.alias:"aggregate_"+u++;o[t]=e.alias,"count"===e.aggregateType?a.push({alias:t,count:{}}):"avg"===e.aggregateType?a.push({alias:t,avg:{field:zs(e.fieldPath)}}):"sum"===e.aggregateType&&a.push({alias:t,sum:{field:zs(e.fieldPath)}})})),{request:{structuredAggregationQuery:{aggregations:a,structuredQuery:s.structuredQuery},parent:s.parent},ut:o,parent:i}}function Ls(e){let t=Ds(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){_(1===r);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=function(e){const t=Ps(e);return t instanceof on&&cn(t)?t.getFilters():[t]}(n.where));let o=[];n.orderBy&&(o=function(e){return e.map((e=>function(e){return new tn(Ks(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e)))}(n.orderBy));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,Ie(t)?null:t}(n.limit));let u=null;n.startAt&&(u=function(e){const t=!!e.before,n=e.values||[];return new Xt(n,t)}(n.startAt));let c=null;return n.endAt&&(c=function(e){const t=!e.before,n=e.values||[];return new Xt(n,t)}(n.endAt)),Rn(t,s,o,i,a,"F",u,c)}function Ps(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Ks(e.unaryFilter.field);return sn.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Ks(e.unaryFilter.field);return sn.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Ks(e.unaryFilter.field);return sn.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=Ks(e.unaryFilter.field);return sn.create(s,"!=",{nullValue:"NULL_VALUE"});default:return v()}}(e):void 0!==e.fieldFilter?function(e){return sn.create(Ks(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return v()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return on.create(e.compositeFilter.filters.map((e=>Ps(e))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return v()}}(e.compositeFilter.op))}(e):v()}function qs(e){return ds[e]}function Us(e){return fs[e]}function Bs(e){return ms[e]}function zs(e){return{fieldPath:e.canonicalString()}}function Ks(e){return $.fromServerFormat(e.fieldPath)}function Gs(e){return e instanceof sn?function(e){if("=="===e.op){if(qt(e.value))return{unaryFilter:{field:zs(e.field),op:"IS_NAN"}};if(Pt(e.value))return{unaryFilter:{field:zs(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(qt(e.value))return{unaryFilter:{field:zs(e.field),op:"IS_NOT_NAN"}};if(Pt(e.value))return{unaryFilter:{field:zs(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:zs(e.field),op:Us(e.op),value:e.value}}}(e):e instanceof on?function(e){const t=e.getFilters().map((e=>Gs(e)));return 1===t.length?t[0]:{compositeFilter:{op:Bs(e.op),filters:t}}}(e):v()}function $s(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function Qs(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class js{constructor(e,t,n,r,s=B.min(),i=B.min(),o=mt.EMPTY_BYTE_STRING,a=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(e){return new js(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new js(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new js(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new js(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Ws{constructor(e){this.ct=e}}function Js(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Hs(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function(e,t){return{name:Es(e,t.key),fields:t.data.value.mapValue.fields,updateTime:ys(e,t.version.toTimestamp()),createTime:ys(e,t.createTime.toTimestamp())}}(e.ct,t);else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Ys(t.version)};else{if(!t.isUnknownDocument())return v();r.unknownDocument={path:n.path.toArray(),version:Ys(t.version)}}return r}function Hs(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Ys(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function Xs(e){const t=new U(e.seconds,e.nanoseconds);return B.fromTimestamp(t)}function Zs(e,t){const n=(t.baseMutations||[]).map((t=>Fs(e.ct,t)));for(let e=0;e<t.mutations.length-1;++e){const n=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){const r=t.mutations[e+1];n.updateTransforms=r.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}const r=t.mutations.map((t=>Fs(e.ct,t))),s=U.fromMillis(t.localWriteTimeMs);return new Br(t.batchId,s,n,r)}function ei(e){const t=Xs(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?Xs(e.lastLimboFreeSnapshotVersion):B.min();let r;return r=function(e){return void 0!==e.documents}(e.query)?function(e){return _(1===e.documents.length),Ln(Fn(Ds(e.documents[0])))}(e.query):function(e){return Ln(Ls(e))}(e.query),new js(r,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,mt.fromBase64String(e.resumeToken))}function ti(e,t){const n=Ys(t.snapshotVersion),r=Ys(t.lastLimboFreeSnapshotVersion);let s;s=Dn(t.target)?Vs(e.ct,t.target):Ms(e.ct,t.target)._t;const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:Sn(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function ni(e){const t=Ls({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Bn(t,t.limit,"L"):t}function ri(e,t){return new Kr(t.largestBatchId,Fs(e.ct,t.overlayMutation))}function si(e,t){const n=t.path.lastSegment();return[e,Ee(t.path.popLast()),n]}function ii(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:Ys(r.readTime),documentKey:Ee(r.documentKey.path),largestBatchId:r.largestBatchId}}class oi{getBundleMetadata(e,t){return ai(e).get(t).next((e=>{if(e)return function(e){return{id:e.bundleId,createTime:Xs(e.createTime),version:e.version}}(e)}))}saveBundleMetadata(e,t){return ai(e).put(function(e){return{bundleId:e.id,createTime:Ys(_s(e.createTime)),version:e.version}}(t))}getNamedQuery(e,t){return ui(e).get(t).next((e=>{if(e)return function(e){return{name:e.name,query:ni(e.bundledQuery),readTime:Xs(e.readTime)}}(e)}))}saveNamedQuery(e,t){return ui(e).put(function(e){return{name:e.name,readTime:Ys(_s(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function ai(e){return et(e,"bundles")}function ui(e){return et(e,"namedQueries")}class ci{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){const n=t.uid||"";return new ci(e,n)}getOverlay(e,t){return li(e).get(si(this.userId,t)).next((e=>e?ri(this.serializer,e):null))}getOverlays(e,t){const n=tr();return ae.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){const r=[];return n.forEach(((n,s)=>{const i=new Kr(t,s);r.push(this.ht(e,i))})),ae.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach((e=>r.add(Ee(e.getCollectionPath()))));const s=[];return r.forEach((t=>{const r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);s.push(li(e).j("collectionPathOverlayIndex",r))})),ae.waitFor(s)}getOverlaysForCollection(e,t,n){const r=tr(),s=Ee(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return li(e).U("collectionPathOverlayIndex",i).next((e=>{for(const t of e){const e=ri(this.serializer,t);r.set(e.getKey(),e)}return r}))}getOverlaysForCollectionGroup(e,t,n,r){const s=tr();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return li(e).J({index:"collectionGroupOverlayIndex",range:o},((e,t,n)=>{const o=ri(this.serializer,t);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}ht(e,t){return li(e).put(function(e,t,n){const[r,s,i]=si(t,n.mutation.key);return{userId:t,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Rs(e.ct,n.mutation)}}(this.serializer,this.userId,t))}}function li(e){return et(e,"documentOverlays")}class hi{Pt(e){return et(e,"globals")}getSessionToken(e){return this.Pt(e).get("sessionToken").next((e=>{const t=null==e?void 0:e.value;return t?mt.fromUint8Array(t):mt.EMPTY_BYTE_STRING}))}setSessionToken(e,t){return this.Pt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class di{constructor(){}It(e,t){this.Tt(e,t),t.Et()}Tt(e,t){if("nullValue"in e)this.dt(t,5);else if("booleanValue"in e)this.dt(t,10),t.At(e.booleanValue?1:0);else if("integerValue"in e)this.dt(t,15),t.At(yt(e.integerValue));else if("doubleValue"in e){const n=yt(e.doubleValue);isNaN(n)?this.dt(t,13):(this.dt(t,15),be(n)?t.At(0):t.At(n))}else if("timestampValue"in e){let n=e.timestampValue;this.dt(t,20),"string"==typeof n&&(n=pt(n)),t.Rt(`${n.seconds||""}`),t.At(n.nanos||0)}else if("stringValue"in e)this.Vt(e.stringValue,t),this.ft(t);else if("bytesValue"in e)this.dt(t,30),t.gt(wt(e.bytesValue)),this.ft(t);else if("referenceValue"in e)this.yt(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.dt(t,45),t.At(n.latitude||0),t.At(n.longitude||0)}else"mapValue"in e?Kt(e)?this.dt(t,Number.MAX_SAFE_INTEGER):Bt(e)?this.wt(e.mapValue,t):(this.St(e.mapValue,t),this.ft(t)):"arrayValue"in e?(this.bt(e.arrayValue,t),this.ft(t)):v()}Vt(e,t){this.dt(t,25),this.Dt(e,t)}Dt(e,t){t.Rt(e)}St(e,t){const n=e.fields||{};this.dt(t,55);for(const e of Object.keys(n))this.Vt(e,t),this.Tt(n[e],t)}wt(e,t){var n,r;const s=e.fields||{};this.dt(t,53);const i="value",o=(null===(r=null===(n=s[i].arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.length)||0;this.dt(t,15),t.At(yt(o)),this.Vt(i,t),this.Tt(s[i],t)}bt(e,t){const n=e.values||[];this.dt(t,50);for(const e of n)this.Tt(e,t)}yt(e,t){this.dt(t,37),Q.fromName(e).path.forEach((e=>{this.dt(t,60),this.Dt(e,t)}))}dt(e,t){e.At(t)}ft(e){e.At(2)}}function fi(e){if(0===e)return 8;let t=0;return!(e>>4)&&(t+=4,e<<=4),!(e>>6)&&(t+=2,e<<=2),!(e>>7)&&(t+=1),t}function mi(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const r=fi(255&e[n]);if(t+=r,8!==r)break}return t}(e);return Math.ceil(t/8)}di.vt=new di;class gi{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ct(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ft(n.value),n=t.next();this.Mt()}xt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ot(n.value),n=t.next();this.Nt()}Lt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ft(e);else if(e<2048)this.Ft(960|e>>>6),this.Ft(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ft(480|e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e);else{const e=t.codePointAt(0);this.Ft(240|e>>>18),this.Ft(128|63&e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e)}}this.Mt()}Bt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ot(e);else if(e<2048)this.Ot(960|e>>>6),this.Ot(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ot(480|e>>>12),this.Ot(128|63&e>>>6),this.Ot(128|63&e);else{const e=t.codePointAt(0);this.Ot(240|e>>>18),this.Ot(128|63&e>>>12),this.Ot(128|63&e>>>6),this.Ot(128|63&e)}}this.Nt()}kt(e){const t=this.qt(e),n=mi(t);this.Qt(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}Kt(e){const t=this.qt(e),n=mi(t);this.Qt(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}$t(){this.Ut(255),this.Ut(255)}Wt(){this.Gt(255),this.Gt(255)}reset(){this.position=0}seed(e){this.Qt(e.length),this.buffer.set(e,this.position),this.position+=e.length}zt(){return this.buffer.slice(0,this.position)}qt(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}Ft(e){const t=255&e;0===t?(this.Ut(0),this.Ut(255)):255===t?(this.Ut(255),this.Ut(0)):this.Ut(t)}Ot(e){const t=255&e;0===t?(this.Gt(0),this.Gt(255)):255===t?(this.Gt(255),this.Gt(0)):this.Gt(e)}Mt(){this.Ut(0),this.Ut(1)}Nt(){this.Gt(0),this.Gt(1)}Ut(e){this.Qt(1),this.buffer[this.position++]=e}Gt(e){this.Qt(1),this.buffer[this.position++]=~e}Qt(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class pi{constructor(e){this.jt=e}gt(e){this.jt.Ct(e)}Rt(e){this.jt.Lt(e)}At(e){this.jt.kt(e)}Et(){this.jt.$t()}}class yi{constructor(e){this.jt=e}gt(e){this.jt.xt(e)}Rt(e){this.jt.Bt(e)}At(e){this.jt.Kt(e)}Et(){this.jt.Wt()}}class wi{constructor(){this.jt=new gi,this.Ht=new pi(this.jt),this.Jt=new yi(this.jt)}seed(e){this.jt.seed(e)}Yt(e){return 0===e?this.Ht:this.Jt}zt(){return this.jt.zt()}reset(){this.jt.reset()}}class vi{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Zt(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new vi(this.indexId,this.documentKey,this.arrayValue,n)}}function _i(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=Ii(e.arrayValue,t.arrayValue),0!==n?n:(n=Ii(e.directionalValue,t.directionalValue),0!==n?n:Q.comparator(e.documentKey,t.documentKey)))}function Ii(e,t){for(let n=0;n<e.length&&n<t.length;++n){const r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class bi{constructor(e){this.Xt=new ut(((e,t)=>$.comparator(e.field,t.field))),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.en=e.orderBy,this.tn=[];for(const t of e.filters){const e=t;e.isInequality()?this.Xt=this.Xt.add(e):this.tn.push(e)}}get nn(){return this.Xt.size>1}rn(e){if(_(e.collectionGroup===this.collectionId),this.nn)return!1;const t=W(e);if(void 0!==t&&!this.sn(t))return!1;const n=J(e);let r=new Set,s=0,i=0;for(;s<n.length&&this.sn(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.Xt.size>0){const e=this.Xt.getIterator().getNext();if(!r.has(e.field.canonicalString())){const t=n[s];if(!this.on(e,t)||!this._n(this.en[i++],t))return!1}++s}for(;s<n.length;++s){const e=n[s];if(i>=this.en.length||!this._n(this.en[i++],e))return!1}return!0}an(){if(this.nn)return null;let e=new ut($.comparator);const t=[];for(const n of this.tn)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new Y(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new Y(n.field,0))}for(const n of this.en)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new Y(n.field,"asc"===n.dir?0:1)));return new j(j.UNKNOWN_ID,this.collectionId,t,Z.empty())}sn(e){for(const t of this.tn)if(this.on(t,e))return!0;return!1}on(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}_n(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function Ti(e){var t,n;if(_(e instanceof sn||e instanceof on),e instanceof sn){if(e instanceof _n){const r=(null===(n=null===(t=e.value.arrayValue)||void 0===t?void 0:t.values)||void 0===n?void 0:n.map((t=>sn.create(e.field,"==",t))))||[];return on.create(r,"or")}return e}const r=e.filters.map((e=>Ti(e)));return on.create(r,e.op)}function Ei(e){if(0===e.getFilters().length)return[];const t=Ci(Ti(e));return _(Di(t)),Si(t)||xi(t)?[t]:t.getFilters()}function Si(e){return e instanceof sn}function xi(e){return e instanceof on&&cn(e)}function Di(e){return Si(e)||xi(e)||function(e){if(e instanceof on&&un(e)){for(const t of e.getFilters())if(!Si(t)&&!xi(t))return!1;return!0}return!1}(e)}function Ci(e){if(_(e instanceof sn||e instanceof on),e instanceof sn)return e;if(1===e.filters.length)return Ci(e.filters[0]);const t=e.filters.map((e=>Ci(e)));let n=on.create(t,e.op);return n=ki(n),Di(n)?n:(_(n instanceof on),_(an(n)),_(n.filters.length>1),n.filters.reduce(((e,t)=>Ni(e,t))))}function Ni(e,t){let n;return _(e instanceof sn||e instanceof on),_(t instanceof sn||t instanceof on),n=e instanceof sn?t instanceof sn?function(e,t){return on.create([e,t],"and")}(e,t):Ai(e,t):t instanceof sn?Ai(t,e):function(e,t){if(_(e.filters.length>0&&t.filters.length>0),an(e)&&an(t))return fn(e,t.getFilters());const n=un(e)?e:t,r=un(e)?t:e,s=n.filters.map((e=>Ni(e,r)));return on.create(s,"or")}(e,t),ki(n)}function Ai(e,t){if(an(t))return fn(t,e.getFilters());{const n=t.filters.map((t=>Ni(e,t)));return on.create(n,"or")}}function ki(e){if(_(e instanceof sn||e instanceof on),e instanceof sn)return e;const t=e.getFilters();if(1===t.length)return ki(t[0]);if(ln(e))return e;const n=t.map((e=>ki(e))),r=[];return n.forEach((t=>{t instanceof sn?r.push(t):t instanceof on&&(t.op===e.op?r.push(...t.filters):r.push(t))})),1===r.length?r[0]:on.create(r,e.op)}class Ri{constructor(){this.un=new Fi}addToCollectionParentIndex(e,t){return this.un.add(t),ae.resolve()}getCollectionParents(e,t){return ae.resolve(this.un.getEntries(t))}addFieldIndex(e,t){return ae.resolve()}deleteFieldIndex(e,t){return ae.resolve()}deleteAllFieldIndexes(e){return ae.resolve()}createTargetIndexes(e,t){return ae.resolve()}getDocumentsMatchingTarget(e,t){return ae.resolve(null)}getIndexType(e,t){return ae.resolve(0)}getFieldIndexes(e,t){return ae.resolve([])}getNextCollectionGroupToUpdate(e){return ae.resolve(null)}getMinOffset(e,t){return ae.resolve(ne.min())}getMinOffsetFromCollectionGroup(e,t){return ae.resolve(ne.min())}updateCollectionGroup(e,t,n){return ae.resolve()}updateIndexEntries(e,t){return ae.resolve()}}class Fi{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new ut(K.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new ut(K.comparator)).toArray()}}const Vi=new Uint8Array(0);class Mi{constructor(e,t){this.databaseId=t,this.cn=new Fi,this.ln=new Jn((e=>Sn(e)),((e,t)=>xn(e,t))),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.cn.has(t)){const n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener((()=>{this.cn.add(t)}));const s={collectionId:n,parent:Ee(r)};return Oi(e).put(s)}return ae.resolve()}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[q(t),""],!1,!0);return Oi(e).U(r).next((e=>{for(const r of e){if(r.collectionId!==t)break;n.push(De(r.parent))}return n}))}addFieldIndex(e,t){const n=Pi(e),r=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map((e=>[e.fieldPath.canonicalString(),e.kind]))}}(t);delete r.indexId;const s=n.add(r);if(t.indexState){const n=qi(e);return s.next((e=>{n.put(ii(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))}))}return s.next()}deleteFieldIndex(e,t){const n=Pi(e),r=qi(e),s=Li(e);return n.delete(t.indexId).next((()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}deleteAllFieldIndexes(e){const t=Pi(e),n=Li(e),r=qi(e);return t.j().next((()=>n.j())).next((()=>r.j()))}createTargetIndexes(e,t){return ae.forEach(this.hn(t),(t=>this.getIndexType(e,t).next((n=>{if(0===n||1===n){const n=new bi(t).an();if(null!=n)return this.addFieldIndex(e,n)}}))))}getDocumentsMatchingTarget(e,t){const n=Li(e);let r=!0;const s=new Map;return ae.forEach(this.hn(t),(t=>this.Pn(e,t).next((e=>{r&&(r=!!e),s.set(t,e)})))).next((()=>{if(r){let e=or();const r=[];return ae.forEach(s,((s,i)=>{g("IndexedDbIndexManager",`Using index ${function(e){return`id=${e.indexId}|cg=${e.collectionGroup}|f=${e.fields.map((e=>`${e.fieldPath}:${e.kind}`)).join(",")}`}(s)} to execute ${Sn(t)}`);const o=function(e,t){const n=W(t);if(void 0===n)return null;for(const t of Cn(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(i,s),a=function(e,t){const n=new Map;for(const r of J(t))for(const t of Cn(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,s),u=function(e,t){const n=[];let r=!0;for(const s of J(t)){const t=0===s.kind?Nn(e,s.fieldPath,e.startAt):An(e,s.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new Xt(n,r)}(i,s),c=function(e,t){const n=[];let r=!0;for(const s of J(t)){const t=0===s.kind?An(e,s.fieldPath,e.endAt):Nn(e,s.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new Xt(n,r)}(i,s),l=this.In(s,i,u),h=this.In(s,i,c),d=this.Tn(s,i,a),f=this.En(s.indexId,o,l,u.inclusive,h,c.inclusive,d);return ae.forEach(f,(s=>n.G(s,t.limit).next((t=>{t.forEach((t=>{const n=Q.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))}))}))))})).next((()=>r))}return ae.resolve(null)}))}hn(e){let t=this.ln.get(e);return t||(t=0===e.filters.length?[e]:Ei(on.create(e.filters,"and")).map((t=>En(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt))),this.ln.set(e,t),t)}En(e,t,n,r,s,i,o){const a=(null!=t?t.length:1)*Math.max(n.length,s.length),u=a/(null!=t?t.length:1),c=[];for(let l=0;l<a;++l){const a=t?this.dn(t[l/u]):Vi,h=this.An(e,a,n[l%u],r),d=this.Rn(e,a,s[l%u],i),f=o.map((t=>this.An(e,a,t,!0)));c.push(...this.createRange(h,d,f))}return c}An(e,t,n,r){const s=new vi(e,Q.empty(),t,n);return r?s:s.Zt()}Rn(e,t,n,r){const s=new vi(e,Q.empty(),t,n);return r?s.Zt():s}Pn(e,t){const n=new bi(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next((e=>{let t=null;for(const r of e)n.rn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t}))}getIndexType(e,t){let n=2;const r=this.hn(t);return ae.forEach(r,(t=>this.Pn(e,t).next((e=>{e?0!==n&&e.fields.length<function(e){let t=new ut($.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})))).next((()=>function(e){return null!==e.limit}(t)&&r.length>1&&2===n?1:n))}Vn(e,t){const n=new wi;for(const r of J(e)){const e=t.data.field(r.fieldPath);if(null==e)return null;const s=n.Yt(r.kind);di.vt.It(e,s)}return n.zt()}dn(e){const t=new wi;return di.vt.It(e,t.Yt(0)),t.zt()}mn(e,t){const n=new wi;return di.vt.It(Mt(this.databaseId,t),n.Yt(function(e){const t=J(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.zt()}Tn(e,t,n){if(null===n)return[];let r=[];r.push(new wi);let s=0;for(const i of J(e)){const e=n[s++];for(const n of r)if(this.fn(t,i.fieldPath)&&Lt(e))r=this.gn(r,i,e);else{const t=n.Yt(i.kind);di.vt.It(e,t)}}return this.pn(r)}In(e,t,n){return this.Tn(e,t,n.position)}pn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].zt();return t}gn(e,t,n){const r=[...e],s=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new wi;r.seed(n.zt()),di.vt.It(e,r.Yt(t.kind)),s.push(r)}return s}fn(e,t){return!!e.filters.find((e=>e instanceof sn&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)))}getFieldIndexes(e,t){const n=Pi(e),r=qi(e);return(t?n.U("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.U()).next((e=>{const t=[];return ae.forEach(e,(e=>r.get([e.indexId,this.uid]).next((n=>{t.push(function(e,t){const n=t?new Z(t.sequenceNumber,new ne(Xs(t.readTime),new Q(De(t.documentKey)),t.largestBatchId)):Z.empty(),r=e.fields.map((([e,t])=>new Y($.fromServerFormat(e),t)));return new j(e.indexId,e.collectionGroup,r,n)}(e,n))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:L(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const r=Pi(e),s=qi(e);return this.yn(e).next((e=>r.U("collectionGroupIndex",IDBKeyRange.bound(t,t)).next((t=>ae.forEach(t,(t=>s.put(ii(t.indexId,this.uid,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return ae.forEach(t,((t,r)=>{const s=n.get(t.collectionGroup);return(s?ae.resolve(s):this.getFieldIndexes(e,t.collectionGroup)).next((s=>(n.set(t.collectionGroup,s),ae.forEach(s,(n=>this.wn(e,t,n).next((t=>{const s=this.Sn(r,n);return t.isEqual(s)?ae.resolve():this.bn(e,r,n,t,s)})))))))}))}Dn(e,t,n,r){return Li(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.mn(n,t.key),documentKey:t.key.path.toArray()})}vn(e,t,n,r){return Li(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.mn(n,t.key),t.key.path.toArray()])}wn(e,t,n){const r=Li(e);let s=new ut(_i);return r.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.mn(n,t)])},((e,r)=>{s=s.add(new vi(n.indexId,t,r.arrayValue,r.directionalValue))})).next((()=>s))}Sn(e,t){let n=new ut(_i);const r=this.Vn(t,e);if(null==r)return n;const s=W(t);if(null!=s){const i=e.data.field(s.fieldPath);if(Lt(i))for(const s of i.arrayValue.values||[])n=n.add(new vi(t.indexId,e.key,this.dn(s),r))}else n=n.add(new vi(t.indexId,e.key,Vi,r));return n}bn(e,t,n,r,s){g("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const i=[];return function(e,t,n,r,s){const i=e.getIterator(),o=t.getIterator();let a=lt(i),u=lt(o);for(;a||u;){let e=!1,t=!1;if(a&&u){const r=n(a,u);r<0?t=!0:r>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(r(u),u=lt(o)):t?(s(a),a=lt(i)):(a=lt(i),u=lt(o))}}(r,s,_i,(r=>{i.push(this.Dn(e,t,n,r))}),(r=>{i.push(this.vn(e,t,n,r))})),ae.waitFor(i)}yn(e){let t=1;return qi(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,r)=>{r.done(),t=n.sequenceNumber+1})).next((()=>t))}createRange(e,t,n){n=n.sort(((e,t)=>_i(e,t))).filter(((e,t,n)=>!t||0!==_i(e,n[t-1])));const r=[];r.push(e);for(const s of n){const n=_i(s,e),i=_i(s,t);if(0===n)r[0]=e.Zt();else if(n>0&&i<0)r.push(s),r.push(s.Zt());else if(i>0)break}r.push(t);const s=[];for(let e=0;e<r.length;e+=2){if(this.Cn(r[e],r[e+1]))return[];const t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,Vi,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,Vi,[]];s.push(IDBKeyRange.bound(t,n))}return s}Cn(e,t){return _i(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Ui)}getMinOffset(e,t){return ae.mapArray(this.hn(t),(t=>this.Pn(e,t).next((e=>e||v())))).next(Ui)}}function Oi(e){return et(e,"collectionParents")}function Li(e){return et(e,"indexEntries")}function Pi(e){return et(e,"indexConfiguration")}function qi(e){return et(e,"indexState")}function Ui(e){_(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){const s=e[r].indexState.offset;re(s,t)<0&&(t=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new ne(t.readTime,t.documentKey,n)}const Bi={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class zi{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new zi(e,zi.DEFAULT_COLLECTION_PERCENTILE,zi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Ki(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=r.J({range:o},((e,t,n)=>(a++,n.delete())));i.push(u.next((()=>{_(1===a)})));const c=[];for(const e of n.mutations){const r=Ae(t,e.key.path,n.batchId);i.push(s.delete(r)),c.push(e.key)}return ae.waitFor(i).next((()=>c))}function Gi(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw v();t=e.noDocument}return JSON.stringify(t).length}zi.DEFAULT_COLLECTION_PERCENTILE=10,zi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,zi.DEFAULT=new zi(41943040,zi.DEFAULT_COLLECTION_PERCENTILE,zi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),zi.DISABLED=new zi(-1,0,0);class $i{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Fn={}}static lt(e,t,n,r){_(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new $i(s,t,n,r)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ji(e).J({index:"userMutationsIndex",range:n},((e,n,r)=>{t=!1,r.done()})).next((()=>t))}addMutationBatch(e,t,n,r){const s=Wi(e),i=ji(e);return i.add({}).next((o=>{_("number"==typeof o);const a=new Br(o,t,n,r),u=function(e,t,n){const r=n.baseMutations.map((t=>Rs(e.ct,t))),s=n.mutations.map((t=>Rs(e.ct,t)));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.serializer,this.userId,a),c=[];let l=new ut(((e,t)=>L(e.canonicalString(),t.canonicalString())));for(const e of r){const t=Ae(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),c.push(i.put(u)),c.push(s.put(t,ke))}return l.forEach((t=>{c.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.Fn[o]=a.keys()})),ae.waitFor(c).next((()=>a))}))}lookupMutationBatch(e,t){return ji(e).get(t).next((e=>e?(_(e.userId===this.userId),Zs(this.serializer,e)):null))}Mn(e,t){return this.Fn[t]?ae.resolve(this.Fn[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.Fn[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return ji(e).J({index:"userMutationsIndex",range:r},((e,t,r)=>{t.userId===this.userId&&(_(t.batchId>=n),s=Zs(this.serializer,t)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return ji(e).J({index:"userMutationsIndex",range:t,reverse:!0},((e,t,r)=>{n=t.batchId,r.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ji(e).U("userMutationsIndex",t).next((e=>e.map((e=>Zs(this.serializer,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=Ne(this.userId,t.path),r=IDBKeyRange.lowerBound(n),s=[];return Wi(e).J({range:r},((n,r,i)=>{const[o,a,u]=n,c=De(a);if(o===this.userId&&t.path.isEqual(c))return ji(e).get(u).next((e=>{if(!e)throw v();_(e.userId===this.userId),s.push(Zs(this.serializer,e))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new ut(L);const r=[];return t.forEach((t=>{const s=Ne(this.userId,t.path),i=IDBKeyRange.lowerBound(s),o=Wi(e).J({range:i},((e,r,s)=>{const[i,o,a]=e,u=De(o);i===this.userId&&t.path.isEqual(u)?n=n.add(a):s.done()}));r.push(o)})),ae.waitFor(r).next((()=>this.xn(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,s=Ne(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new ut(L);return Wi(e).J({range:i},((e,t,s)=>{const[i,a,u]=e,c=De(a);i===this.userId&&n.isPrefixOf(c)?c.length===r&&(o=o.add(u)):s.done()})).next((()=>this.xn(e,o)))}xn(e,t){const n=[],r=[];return t.forEach((t=>{r.push(ji(e).get(t).next((e=>{if(null===e)throw v();_(e.userId===this.userId),n.push(Zs(this.serializer,e))})))})),ae.waitFor(r).next((()=>n))}removeMutationBatch(e,t){return Ki(e._e,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.On(t.batchId)})),ae.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}On(e){delete this.Fn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return ae.resolve();const n=IDBKeyRange.lowerBound(function(e){return[e]}(this.userId)),r=[];return Wi(e).J({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=De(e[1]);r.push(t)}else n.done()})).next((()=>{_(0===r.length)}))}))}containsKey(e,t){return Qi(e,this.userId,t)}Nn(e){return Ji(e).get(this.userId).next((e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function Qi(e,t,n){const r=Ne(t,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return Wi(e).J({range:i,H:!0},((e,n,r)=>{const[i,a,u]=e;i===t&&a===s&&(o=!0),r.done()})).next((()=>o))}function ji(e){return et(e,"mutations")}function Wi(e){return et(e,"documentMutations")}function Ji(e){return et(e,"mutationQueues")}class Hi{constructor(e){this.Ln=e}next(){return this.Ln+=2,this.Ln}static Bn(){return new Hi(0)}static kn(){return new Hi(-1)}}class Yi{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.qn(e).next((t=>{const n=new Hi(t.highestTargetId);return t.highestTargetId=n.next(),this.Qn(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.qn(e).next((e=>B.fromTimestamp(new U(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.qn(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.qn(e).next((r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.Qn(e,r))))}addTargetData(e,t){return this.Kn(e,t).next((()=>this.qn(e).next((n=>(n.targetCount+=1,this.$n(t,n),this.Qn(e,n))))))}updateTargetData(e,t){return this.Kn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>Xi(e).delete(t.targetId))).next((()=>this.qn(e))).next((t=>(_(t.targetCount>0),t.targetCount-=1,this.Qn(e,t))))}removeTargets(e,t,n){let r=0;const s=[];return Xi(e).J(((i,o)=>{const a=ei(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(e,a)))})).next((()=>ae.waitFor(s))).next((()=>r))}forEachTarget(e,t){return Xi(e).J(((e,n)=>{const r=ei(n);t(r)}))}qn(e){return Zi(e).get("targetGlobalKey").next((e=>(_(null!==e),e)))}Qn(e,t){return Zi(e).put("targetGlobalKey",t)}Kn(e,t){return Xi(e).put(ti(this.serializer,t))}$n(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.qn(e).next((e=>e.targetCount))}getTargetData(e,t){const n=Sn(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return Xi(e).J({range:r,index:"queryTargetsIndex"},((e,n,r)=>{const i=ei(n);xn(t,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(e,t,n){const r=[],s=eo(e);return t.forEach((t=>{const i=Ee(t.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(e,n,t))})),ae.waitFor(r)}removeMatchingKeys(e,t,n){const r=eo(e);return ae.forEach(t,(t=>{const s=Ee(t.path);return ae.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=eo(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=eo(e);let s=or();return r.J({range:n,H:!0},((e,t,n)=>{const r=De(e[1]),i=new Q(r);s=s.add(i)})).next((()=>s))}containsKey(e,t){const n=Ee(t.path),r=IDBKeyRange.bound([n],[q(n)],!1,!0);let s=0;return eo(e).J({index:"documentTargetsIndex",H:!0,range:r},(([e,t],n,r)=>{0!==e&&(s++,r.done())})).next((()=>s>0))}ot(e,t){return Xi(e).get(t).next((e=>e?ei(e):null))}}function Xi(e){return et(e,"targets")}function Zi(e){return et(e,"targetGlobal")}function eo(e){return et(e,"targetDocuments")}function to([e,t],[n,r]){const s=L(e,n);return 0===s?L(t,r):s}class no{constructor(e){this.Un=e,this.buffer=new ut(to),this.Wn=0}Gn(){return++this.Wn}zn(e){const t=[e,this.Gn()];if(this.buffer.size<this.Un)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();to(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class ro{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.jn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Hn(6e4)}stop(){this.jn&&(this.jn.cancel(),this.jn=null)}get started(){return null!==this.jn}Hn(e){g("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.jn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.jn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){fe(e)?g("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await oe(e)}await this.Hn(3e5)}))}}class so{constructor(e,t){this.Jn=e,this.params=t}calculateTargetCount(e,t){return this.Jn.Yn(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return ae.resolve(_e.oe);const n=new no(t);return this.Jn.forEachTarget(e,(e=>n.zn(e.sequenceNumber))).next((()=>this.Jn.Zn(e,(e=>n.zn(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.Jn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Jn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector","Garbage collection skipped; disabled"),ae.resolve(Bi)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Bi):this.Xn(e,t)))}getCacheSize(e){return this.Jn.getCacheSize(e)}Xn(e,t){let n,r,s,o,a,u,c;const l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(g("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,o=Date.now(),this.nthSequenceNumber(e,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(e,n,t)))).next((t=>(s=t,u=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(c=Date.now(),f()<=i.$b.DEBUG&&g("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-l}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(u-a)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-l}ms`),ae.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:e}))))}}function io(e,t){return new so(e,t)}class oo{constructor(e,t){this.db=e,this.garbageCollector=io(this,t)}Yn(e){const t=this.er(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}er(e){let t=0;return this.Zn(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Zn(e,t){return this.tr(e,((e,n)=>t(n)))}addReference(e,t,n){return ao(e,n)}removeReference(e,t,n){return ao(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return ao(e,t)}nr(e,t){return function(e,t){let n=!1;return Ji(e).Y((r=>Qi(e,r,t).next((e=>(e&&(n=!0),ae.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.tr(e,((i,o)=>{if(o<=t){const t=this.nr(e,i).next((t=>{if(!t)return s++,n.getEntry(e,i).next((()=>(n.removeEntry(i,B.min()),eo(e).delete(function(e){return[0,Ee(e.path)]}(i)))))}));r.push(t)}})).next((()=>ae.waitFor(r))).next((()=>n.apply(e))).next((()=>s))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return ao(e,t)}tr(e,t){const n=eo(e);let r,s=_e.oe;return n.J({index:"documentTargetsIndex"},(([e,n],{path:i,sequenceNumber:o})=>{0===e?(s!==_e.oe&&t(new Q(De(r)),s),s=o,r=i):s=_e.oe})).next((()=>{s!==_e.oe&&t(new Q(De(r)),s)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function ao(e,t){return eo(e).put(function(e,t){return{targetId:0,path:Ee(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class uo{constructor(){this.changes=new Jn((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Yt.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?ae.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class co{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return mo(e).put(n)}removeEntry(e,t,n){return mo(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Hs(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.rr(e,n))))}getEntry(e,t){let n=Yt.newInvalidDocument(t);return mo(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(go(t))},((e,r)=>{n=this.ir(t,r)})).next((()=>n))}sr(e,t){let n={size:0,document:Yt.newInvalidDocument(t)};return mo(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(go(t))},((e,r)=>{n={document:this.ir(t,r),size:Gi(r)}})).next((()=>n))}getEntries(e,t){let n=Yn();return this._r(e,t,((e,t)=>{const r=this.ir(e,t);n=n.insert(e,r)})).next((()=>n))}ar(e,t){let n=Yn(),r=new it(Q.comparator);return this._r(e,t,((e,t)=>{const s=this.ir(e,t);n=n.insert(e,s),r=r.insert(e,Gi(t))})).next((()=>({documents:n,ur:r})))}_r(e,t,n){if(t.isEmpty())return ae.resolve();let r=new ut(yo);t.forEach((e=>r=r.add(e)));const s=IDBKeyRange.bound(go(r.first()),go(r.last())),i=r.getIterator();let o=i.getNext();return mo(e).J({index:"documentKeyIndex",range:s},((e,t,r)=>{const s=Q.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&yo(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?r.$(go(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getDocumentsMatchingQuery(e,t,n,r,s){const i=t.path,o=[i.popLast().toArray(),i.lastSegment(),Hs(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],a=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return mo(e).U(IDBKeyRange.bound(o,a,!0)).next((e=>{null==s||s.incrementDocumentReadCount(e.length);let n=Yn();for(const s of e){const e=this.ir(Q.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);e.isFoundDocument()&&($n(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n}))}getAllFromCollectionGroup(e,t,n,r){let s=Yn();const i=po(t,n),o=po(t,ne.max());return mo(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((e,t,n)=>{const i=this.ir(Q.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(e){return new ho(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return fo(e).get("remoteDocumentGlobalKey").next((e=>(_(!!e),e)))}rr(e,t){return fo(e).put("remoteDocumentGlobalKey",t)}ir(e,t){if(t){const e=function(e,t){let n;if(t.document)n=ks(e.ct,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=Q.fromSegments(t.noDocument.path),r=Xs(t.noDocument.readTime);n=Yt.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return v();{const e=Q.fromSegments(t.unknownDocument.path),r=Xs(t.unknownDocument.version);n=Yt.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){const t=new U(e[0],e[1]);return B.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(B.min()))return e}return Yt.newInvalidDocument(e)}}function lo(e){return new co(e)}class ho extends uo{constructor(e,t){super(),this.cr=e,this.trackRemovals=t,this.lr=new Jn((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,r=new ut(((e,t)=>L(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.lr.get(s);if(t.push(this.cr.removeEntry(e,s,o.readTime)),i.isValidDocument()){const a=Js(this.cr.serializer,i);r=r.add(s.path.popLast());const u=Gi(a);n+=u-o.size,t.push(this.cr.addEntry(e,s,a))}else if(n-=o.size,this.trackRemovals){const n=Js(this.cr.serializer,i.convertToNoDocument(B.min()));t.push(this.cr.addEntry(e,s,n))}})),r.forEach((n=>{t.push(this.cr.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.cr.updateMetadata(e,n)),ae.waitFor(t)}getFromCache(e,t){return this.cr.sr(e,t).next((e=>(this.lr.set(t,{size:e.size,readTime:e.document.readTime}),e.document)))}getAllFromCache(e,t){return this.cr.ar(e,t).next((({documents:e,ur:t})=>(t.forEach(((t,n)=>{this.lr.set(t,{size:n,readTime:e.get(t).readTime})})),e)))}}function fo(e){return et(e,"remoteDocumentGlobal")}function mo(e){return et(e,"remoteDocumentsV14")}function go(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function po(e,t){const n=t.documentKey.path.toArray();return[e,Hs(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function yo(e,t){const n=e.path.toArray(),r=t.path.toArray();let s=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(s=L(n[e],r[e]),s)return s;return s=L(n.length,r.length),s||(s=L(n[n.length-2],r[r.length-2]),s||L(n[n.length-1],r[r.length-1]))}class wo{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class vo{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((r=>(n=r,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&kr(n.mutation,e,ht.empty(),U.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,or()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=or()){const r=tr();return this.populateOverlays(e,r,t).next((()=>this.computeViews(e,t,r,n).next((e=>{let t=Zn();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=tr();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,or())))}populateOverlays(e,t,n){const r=[];return n.forEach((e=>{t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,r){let s=Yn();const i=rr(),o=rr();return t.forEach(((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof Mr)?s=s.insert(t.key,t):void 0!==o?(i.set(t.key,o.mutation.getFieldMask()),kr(o.mutation,t,o.mutation.getFieldMask(),U.now())):i.set(t.key,ht.empty())})),this.recalculateAndSaveOverlays(e,s).next((e=>(e.forEach(((e,t)=>i.set(e,t))),t.forEach(((e,t)=>{var n;return o.set(e,new wo(t,null!==(n=i.get(e))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(e,t){const n=rr();let r=new it(((e,t)=>e-t)),s=or();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const s of e)s.keys().forEach((e=>{const i=t.get(e);if(null===i)return;let o=n.get(e)||ht.empty();o=s.applyToLocalView(i,o),n.set(e,o);const a=(r.get(s.batchId)||or()).add(e);r=r.insert(s.batchId,a)}))})).next((()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,u=r.value,c=nr();u.forEach((e=>{if(!s.has(e)){const r=Nr(t.get(e),n.get(e));null!==r&&c.set(e,r),s=s.add(e)}})),i.push(this.documentOverlayCache.saveOverlays(e,a,c))}return ae.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n,r){return function(e){return Q.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):Mn(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-s.size):ae.resolve(tr());let o=-1,a=s;return i.next((t=>ae.forEach(t,((t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(t)?ae.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{a=a.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,s))).next((()=>this.computeViews(e,a,t,or()))).next((e=>({batchId:o,changes:er(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new Q(t)).next((e=>{let t=Zn();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){const s=t.collectionGroup;let i=Zn();return this.indexManager.getCollectionParents(e,s).next((o=>ae.forEach(o,(o=>{const a=function(e,t){return new kn(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,o.child(s));return this.getDocumentsMatchingCollectionQuery(e,a,n,r).next((e=>{e.forEach(((e,t)=>{i=i.insert(e,t)}))}))})).next((()=>i))))}getDocumentsMatchingCollectionQuery(e,t,n,r){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((i=>(s=i,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,s,r)))).next((e=>{s.forEach(((t,n)=>{const r=n.getKey();null===e.get(r)&&(e=e.insert(r,Yt.newInvalidDocument(r)))}));let n=Zn();return e.forEach(((e,r)=>{const i=s.get(e);void 0!==i&&kr(i.mutation,r,ht.empty(),U.now()),$n(t,r)&&(n=n.insert(e,r))})),n}))}}class _o{constructor(e){this.serializer=e,this.hr=new Map,this.Pr=new Map}getBundleMetadata(e,t){return ae.resolve(this.hr.get(t))}saveBundleMetadata(e,t){return this.hr.set(t.id,function(e){return{id:e.id,version:e.version,createTime:_s(e.createTime)}}(t)),ae.resolve()}getNamedQuery(e,t){return ae.resolve(this.Pr.get(t))}saveNamedQuery(e,t){return this.Pr.set(t.name,function(e){return{name:e.name,query:ni(e.bundledQuery),readTime:_s(e.readTime)}}(t)),ae.resolve()}}class Io{constructor(){this.overlays=new it(Q.comparator),this.Ir=new Map}getOverlay(e,t){return ae.resolve(this.overlays.get(t))}getOverlays(e,t){const n=tr();return ae.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.ht(e,t,r)})),ae.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.Ir.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.Ir.delete(n)),ae.resolve()}getOverlaysForCollection(e,t,n){const r=tr(),s=t.length+1,i=new Q(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return ae.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let s=new it(((e,t)=>e-t));const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=s.get(e.largestBatchId);null===t&&(t=tr(),s=s.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=tr(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=r)););return ae.resolve(o)}ht(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.Ir.get(r.largestBatchId).delete(n.key);this.Ir.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Kr(t,n));let s=this.Ir.get(t);void 0===s&&(s=or(),this.Ir.set(t,s)),this.Ir.set(t,s.add(n.key))}}class bo{constructor(){this.sessionToken=mt.EMPTY_BYTE_STRING}getSessionToken(e){return ae.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,ae.resolve()}}class To{constructor(){this.Tr=new ut(Eo.Er),this.dr=new ut(Eo.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(e,t){const n=new Eo(e,t);this.Tr=this.Tr.add(n),this.dr=this.dr.add(n)}Rr(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.Vr(new Eo(e,t))}mr(e,t){e.forEach((e=>this.removeReference(e,t)))}gr(e){const t=new Q(new K([])),n=new Eo(t,e),r=new Eo(t,e+1),s=[];return this.dr.forEachInRange([n,r],(e=>{this.Vr(e),s.push(e.key)})),s}pr(){this.Tr.forEach((e=>this.Vr(e)))}Vr(e){this.Tr=this.Tr.delete(e),this.dr=this.dr.delete(e)}yr(e){const t=new Q(new K([])),n=new Eo(t,e),r=new Eo(t,e+1);let s=or();return this.dr.forEachInRange([n,r],(e=>{s=s.add(e.key)})),s}containsKey(e){const t=new Eo(e,0),n=this.Tr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class Eo{constructor(e,t){this.key=e,this.wr=t}static Er(e,t){return Q.comparator(e.key,t.key)||L(e.wr,t.wr)}static Ar(e,t){return L(e.wr,t.wr)||Q.comparator(e.key,t.key)}}class So{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Sr=1,this.br=new ut(Eo.Er)}checkEmpty(e){return ae.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const s=this.Sr;this.Sr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new Br(s,t,n,r);this.mutationQueue.push(i);for(const t of r)this.br=this.br.add(new Eo(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return ae.resolve(i)}lookupMutationBatch(e,t){return ae.resolve(this.Dr(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.vr(n),s=r<0?0:r;return ae.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return ae.resolve(0===this.mutationQueue.length?-1:this.Sr-1)}getAllMutationBatches(e){return ae.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Eo(t,0),r=new Eo(t,Number.POSITIVE_INFINITY),s=[];return this.br.forEachInRange([n,r],(e=>{const t=this.Dr(e.wr);s.push(t)})),ae.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new ut(L);return t.forEach((e=>{const t=new Eo(e,0),r=new Eo(e,Number.POSITIVE_INFINITY);this.br.forEachInRange([t,r],(e=>{n=n.add(e.wr)}))})),ae.resolve(this.Cr(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;Q.isDocumentKey(s)||(s=s.child(""));const i=new Eo(new Q(s),0);let o=new ut(L);return this.br.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e.wr)),!0)}),i),ae.resolve(this.Cr(o))}Cr(e){const t=[];return e.forEach((e=>{const n=this.Dr(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){_(0===this.Fr(t.batchId,"removed")),this.mutationQueue.shift();let n=this.br;return ae.forEach(t.mutations,(r=>{const s=new Eo(r.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.br=n}))}On(e){}containsKey(e,t){const n=new Eo(t,0),r=this.br.firstAfterOrEqual(n);return ae.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,ae.resolve()}Fr(e,t){return this.vr(e)}vr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Dr(e){const t=this.vr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class xo{constructor(e){this.Mr=e,this.docs=new it(Q.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.Mr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return ae.resolve(n?n.document.mutableCopy():Yt.newInvalidDocument(t))}getEntries(e,t){let n=Yn();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Yt.newInvalidDocument(e))})),ae.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let s=Yn();const i=t.path,o=new Q(i.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:e,value:{document:o}}=a.getNext();if(!i.isPrefixOf(e.path))break;e.path.length>i.length+1||re(te(o),n)<=0||(r.has(o.key)||$n(t,o))&&(s=s.insert(o.key,o.mutableCopy()))}return ae.resolve(s)}getAllFromCollectionGroup(e,t,n,r){v()}Or(e,t){return ae.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new Do(this)}getSize(e){return ae.resolve(this.size)}}class Do extends uo{constructor(e){super(),this.cr=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.cr.addEntry(e,r)):this.cr.removeEntry(n)})),ae.waitFor(t)}getFromCache(e,t){return this.cr.getEntry(e,t)}getAllFromCache(e,t){return this.cr.getEntries(e,t)}}class Co{constructor(e){this.persistence=e,this.Nr=new Jn((e=>Sn(e)),xn),this.lastRemoteSnapshotVersion=B.min(),this.highestTargetId=0,this.Lr=0,this.Br=new To,this.targetCount=0,this.kr=Hi.Bn()}forEachTarget(e,t){return this.Nr.forEach(((e,n)=>t(n))),ae.resolve()}getLastRemoteSnapshotVersion(e){return ae.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return ae.resolve(this.Lr)}allocateTargetId(e){return this.highestTargetId=this.kr.next(),ae.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Lr&&(this.Lr=t),ae.resolve()}Kn(e){this.Nr.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.kr=new Hi(t),this.highestTargetId=t),e.sequenceNumber>this.Lr&&(this.Lr=e.sequenceNumber)}addTargetData(e,t){return this.Kn(t),this.targetCount+=1,ae.resolve()}updateTargetData(e,t){return this.Kn(t),ae.resolve()}removeTargetData(e,t){return this.Nr.delete(t.target),this.Br.gr(t.targetId),this.targetCount-=1,ae.resolve()}removeTargets(e,t,n){let r=0;const s=[];return this.Nr.forEach(((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.Nr.delete(i),s.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)})),ae.waitFor(s).next((()=>r))}getTargetCount(e){return ae.resolve(this.targetCount)}getTargetData(e,t){const n=this.Nr.get(t)||null;return ae.resolve(n)}addMatchingKeys(e,t,n){return this.Br.Rr(t,n),ae.resolve()}removeMatchingKeys(e,t,n){this.Br.mr(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach((t=>{s.push(r.markPotentiallyOrphaned(e,t))})),ae.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Br.gr(t),ae.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Br.yr(t);return ae.resolve(n)}containsKey(e,t){return ae.resolve(this.Br.containsKey(t))}}class No{constructor(e,t){this.qr={},this.overlays={},this.Qr=new _e(0),this.Kr=!1,this.Kr=!0,this.$r=new bo,this.referenceDelegate=e(this),this.Ur=new Co(this),this.indexManager=new Ri,this.remoteDocumentCache=function(e){return new xo(e)}((e=>this.referenceDelegate.Wr(e))),this.serializer=new Ws(t),this.Gr=new _o(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Io,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.qr[e.toKey()];return n||(n=new So(t,this.referenceDelegate),this.qr[e.toKey()]=n),n}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(e,t,n){g("MemoryPersistence","Starting transaction:",e);const r=new Ao(this.Qr.next());return this.referenceDelegate.zr(),n(r).next((e=>this.referenceDelegate.jr(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Hr(e,t){return ae.or(Object.values(this.qr).map((n=>()=>n.containsKey(e,t))))}}class Ao extends ie{constructor(e){super(),this.currentSequenceNumber=e}}class ko{constructor(e){this.persistence=e,this.Jr=new To,this.Yr=null}static Zr(e){return new ko(e)}get Xr(){if(this.Yr)return this.Yr;throw v()}addReference(e,t,n){return this.Jr.addReference(n,t),this.Xr.delete(n.toString()),ae.resolve()}removeReference(e,t,n){return this.Jr.removeReference(n,t),this.Xr.add(n.toString()),ae.resolve()}markPotentiallyOrphaned(e,t){return this.Xr.add(t.toString()),ae.resolve()}removeTarget(e,t){this.Jr.gr(t.targetId).forEach((e=>this.Xr.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Xr.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}zr(){this.Yr=new Set}jr(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return ae.forEach(this.Xr,(n=>{const r=Q.fromPath(n);return this.ei(e,r).next((e=>{e||t.removeEntry(r,B.min())}))})).next((()=>(this.Yr=null,t.apply(e))))}updateLimboDocument(e,t){return this.ei(e,t).next((e=>{e?this.Xr.delete(t.toString()):this.Xr.add(t.toString())}))}Wr(e){return 0}ei(e,t){return ae.or([()=>ae.resolve(this.Jr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Hr(e,t)])}}class Ro{constructor(e,t){this.persistence=e,this.ti=new Jn((e=>Ee(e.path)),((e,t)=>e.isEqual(t))),this.garbageCollector=io(this,t)}static Zr(e,t){return new Ro(e,t)}zr(){}jr(e){return ae.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}Yn(e){const t=this.er(e);return this.persistence.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}er(e){let t=0;return this.Zn(e,(e=>{t++})).next((()=>t))}Zn(e,t){return ae.forEach(this.ti,((n,r)=>this.nr(e,n,r).next((e=>e?ae.resolve():t(r)))))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0;const r=this.persistence.getRemoteDocumentCache(),s=r.newChangeBuffer();return r.Or(e,(r=>this.nr(e,r,t).next((e=>{e||(n++,s.removeEntry(r,B.min()))})))).next((()=>s.apply(e))).next((()=>n))}markPotentiallyOrphaned(e,t){return this.ti.set(t,e.currentSequenceNumber),ae.resolve()}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.ti.set(n,e.currentSequenceNumber),ae.resolve()}removeReference(e,t,n){return this.ti.set(n,e.currentSequenceNumber),ae.resolve()}updateLimboDocument(e,t){return this.ti.set(t,e.currentSequenceNumber),ae.resolve()}Wr(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=Vt(e.data.value)),t}nr(e,t,n){return ae.or([()=>this.persistence.Hr(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{const e=this.ti.get(t);return ae.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class Fo{constructor(e){this.serializer=e}O(e,t,n,r){const s=new ue("createOrUpgrade",t);n<1&&r>=1&&(function(e){e.createObjectStore("owner")}(e),function(e){e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Ce,{unique:!0}),e.createObjectStore("documentMutations")}(e),Vo(e),function(e){e.createObjectStore("remoteDocuments")}(e));let i=ae.resolve();return n<3&&r>=3&&(0!==n&&(function(e){e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal")}(e),Vo(e)),i=i.next((()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:B.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(e,t){return t.store("mutations").U().next((n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Ce,{unique:!0});const r=t.store("mutations"),s=n.map((e=>r.put(e)));return ae.waitFor(s)}))}(e,s)))),i=i.next((()=>{!function(e){e.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)}))),n<5&&r>=5&&(i=i.next((()=>this.ni(s)))),n<6&&r>=6&&(i=i.next((()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(e),this.ri(s))))),n<7&&r>=7&&(i=i.next((()=>this.ii(s)))),n<8&&r>=8&&(i=i.next((()=>this.si(e,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)}))),n<10&&r>=10&&(i=i.next((()=>this.oi(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(e){e.createObjectStore("bundles",{keyPath:"bundleId"})}(e),function(e){e.createObjectStore("namedQueries",{keyPath:"name"})}(e)}))),n<12&&r>=12&&(i=i.next((()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:Ke});t.createIndex("collectionPathOverlayIndex",Ge,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",$e,{unique:!1})}(e)}))),n<13&&r>=13&&(i=i.next((()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:Re});t.createIndex("documentKeyIndex",Fe),t.createIndex("collectionGroupIndex",Ve)}(e))).next((()=>this._i(e,s))).next((()=>e.deleteObjectStore("remoteDocuments")))),n<14&&r>=14&&(i=i.next((()=>this.ai(e,s)))),n<15&&r>=15&&(i=i.next((()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:qe}).createIndex("sequenceNumberIndex",Ue,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Be}).createIndex("documentKeyIndex",ze,{unique:!1})}(e)))),n<16&&r>=16&&(i=i.next((()=>{t.objectStore("indexState").clear()})).next((()=>{t.objectStore("indexEntries").clear()}))),n<17&&r>=17&&(i=i.next((()=>{!function(e){e.createObjectStore("globals",{keyPath:"name"})}(e)}))),i}ri(e){let t=0;return e.store("remoteDocuments").J(((e,n)=>{t+=Gi(n)})).next((()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}ni(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.U().next((t=>ae.forEach(t,(t=>{const r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.U("userMutationsIndex",r).next((n=>ae.forEach(n,(n=>{_(n.userId===t.userId);const r=Zs(this.serializer,n);return Ki(e,t.userId,r).next((()=>{}))}))))}))))}ii(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next((e=>{const r=[];return n.J(((n,s)=>{const i=new K(n),o=function(e){return[0,Ee(e)]}(i);r.push(t.get(o).next((n=>n?ae.resolve():(n=>t.put({targetId:0,path:Ee(n),sequenceNumber:e.highestListenSequenceNumber}))(i))))})).next((()=>ae.waitFor(r)))}))}si(e,t){e.createObjectStore("collectionParents",{keyPath:Pe});const n=t.store("collectionParents"),r=new Fi,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Ee(r)})}};return t.store("remoteDocuments").J({H:!0},((e,t)=>{const n=new K(e);return s(n.popLast())})).next((()=>t.store("documentMutations").J({H:!0},(([e,t,n],r)=>{const i=De(t);return s(i.popLast())}))))}oi(e){const t=e.store("targets");return t.J(((e,n)=>{const r=ei(n),s=ti(this.serializer,r);return t.put(s)}))}_i(e,t){const n=t.store("remoteDocuments"),r=[];return n.J(((e,n)=>{const s=t.store("remoteDocumentsV14"),i=function(e){return e.document?new Q(K.fromString(e.document.name).popFirst(5)):e.noDocument?Q.fromSegments(e.noDocument.path):e.unknownDocument?Q.fromSegments(e.unknownDocument.path):v()}(n).path.toArray(),o={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(o))})).next((()=>ae.waitFor(r)))}ai(e,t){const n=t.store("mutations"),r=lo(this.serializer),s=new No(ko.Zr,this.serializer.ct);return n.U().next((e=>{const n=new Map;return e.forEach((e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:or();Zs(this.serializer,e).keys().forEach((e=>r=r.add(e))),n.set(e.userId,r)})),ae.forEach(n,((e,n)=>{const i=new l(n),o=ci.lt(this.serializer,i),a=s.getIndexManager(i),u=$i.lt(i,this.serializer,a,s.referenceDelegate);return new vo(r,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new Ze(t,_e.oe),e).next()}))}))}}function Vo(e){e.createObjectStore("targetDocuments",{keyPath:Oe}).createIndex("documentTargetsIndex",Le,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Me,{unique:!0}),e.createObjectStore("targetGlobal")}const Mo="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Oo{constructor(e,t,n,r,s,i,o,a,u,c,l=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.ui=s,this.window=i,this.document=o,this.ci=u,this.li=c,this.hi=l,this.Qr=null,this.Kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Pi=null,this.inForeground=!1,this.Ii=null,this.Ti=null,this.Ei=Number.NEGATIVE_INFINITY,this.di=e=>Promise.resolve(),!Oo.D())throw new E(T.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new oo(this,r),this.Ai=t+"main",this.serializer=new Ws(a),this.Ri=new ce(this.Ai,this.hi,new Fo(this.serializer)),this.$r=new hi,this.Ur=new Yi(this.referenceDelegate,this.serializer),this.remoteDocumentCache=lo(this.serializer),this.Gr=new oi,this.window&&this.window.localStorage?this.Vi=this.window.localStorage:(this.Vi=null,!1===c&&p("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new E(T.FAILED_PRECONDITION,Mo);return this.fi(),this.gi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.Ur.getHighestSequenceNumber(e)))})).then((e=>{this.Qr=new _e(e,this.ci)})).then((()=>{this.Kr=!0})).catch((e=>(this.Ri&&this.Ri.close(),Promise.reject(e))))}yi(e){return this.di=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ri.L((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ui.enqueueAndForget((async()=>{this.started&&await this.mi()})))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>Po(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.wi(e).next((e=>{e||(this.isPrimary=!1,this.ui.enqueueRetryable((()=>this.di(!1))))}))})).next((()=>this.Si(e))).next((t=>this.isPrimary&&!t?this.bi(e).next((()=>!1)):!!t&&this.Di(e).next((()=>!0)))))).catch((e=>{if(fe(e))return g("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return g("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.ui.enqueueRetryable((()=>this.di(e))),this.isPrimary=e}))}wi(e){return Lo(e).get("owner").next((e=>ae.resolve(this.vi(e))))}Ci(e){return Po(e).delete(this.clientId)}async Fi(){if(this.isPrimary&&!this.Mi(this.Ei,18e5)){this.Ei=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=et(e,"clientMetadata");return t.U().next((e=>{const n=this.xi(e,18e5),r=e.filter((e=>-1===n.indexOf(e)));return ae.forEach(r,(e=>t.delete(e.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.Vi)for(const t of e)this.Vi.removeItem(this.Oi(t.clientId))}}pi(){this.Ti=this.ui.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.mi().then((()=>this.Fi())).then((()=>this.pi()))))}vi(e){return!!e&&e.ownerId===this.clientId}Si(e){return this.li?ae.resolve(!0):Lo(e).get("owner").next((t=>{if(null!==t&&this.Mi(t.leaseTimestampMs,5e3)&&!this.Ni(t.ownerId)){if(this.vi(t)&&this.networkEnabled)return!0;if(!this.vi(t)){if(!t.allowTabSynchronization)throw new E(T.FAILED_PRECONDITION,Mo);return!1}}return!(!this.networkEnabled||!this.inForeground)||Po(e).U().next((e=>void 0===this.xi(e,5e3).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&g("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.Kr=!1,this.Li(),this.Ti&&(this.Ti.cancel(),this.Ti=null),this.Bi(),this.ki(),await this.Ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(e=>{const t=new Ze(e,_e.oe);return this.bi(t).next((()=>this.Ci(t)))})),this.Ri.close(),this.qi()}xi(e,t){return e.filter((e=>this.Mi(e.updateTimeMs,t)&&!this.Ni(e.clientId)))}Qi(){return this.runTransaction("getActiveClients","readonly",(e=>Po(e).U().next((e=>this.xi(e,18e5).map((e=>e.clientId))))))}get started(){return this.Kr}getGlobalsCache(){return this.$r}getMutationQueue(e,t){return $i.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Mi(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return ci.lt(this.serializer,e)}getBundleCache(){return this.Gr}runTransaction(e,t,n){g("IndexedDbPersistence","Starting transaction:",e);const r="readonly"===t?"readonly":"readwrite",s=function(e){return 17===e?Xe:16===e?Ye:15===e?He:14===e?Je:13===e?We:12===e?je:11===e?Qe:void v()}(this.hi);let i;return this.Ri.runTransaction(e,r,s,(r=>(i=new Ze(r,this.Qr?this.Qr.next():_e.oe),"readwrite-primary"===t?this.wi(i).next((e=>!!e||this.Si(i))).next((t=>{if(!t)throw p(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ui.enqueueRetryable((()=>this.di(!1))),new E(T.FAILED_PRECONDITION,se);return n(i)})).next((e=>this.Di(i).next((()=>e)))):this.Ki(i).next((()=>n(i)))))).then((e=>(i.raiseOnCommittedEvent(),e)))}Ki(e){return Lo(e).get("owner").next((e=>{if(null!==e&&this.Mi(e.leaseTimestampMs,5e3)&&!this.Ni(e.ownerId)&&!this.vi(e)&&!(this.li||this.allowTabSynchronization&&e.allowTabSynchronization))throw new E(T.FAILED_PRECONDITION,Mo)}))}Di(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Lo(e).put("owner",t)}static D(){return ce.D()}bi(e){const t=Lo(e);return t.get("owner").next((e=>this.vi(e)?(g("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):ae.resolve()))}Mi(e,t){const n=Date.now();return!(e<n-t||e>n&&(p(`Detected an update time that is in the future: ${e} > ${n}`),1))}fi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ii=()=>{this.ui.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.mi())))},this.document.addEventListener("visibilitychange",this.Ii),this.inForeground="visible"===this.document.visibilityState)}Bi(){this.Ii&&(this.document.removeEventListener("visibilitychange",this.Ii),this.Ii=null)}gi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Pi=()=>{this.Li();const e=/(?:Version|Mobile)\/1[456]/;(0,o.nr)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.ui.enterRestrictedMode(!0),this.ui.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.Pi))}ki(){this.Pi&&(this.window.removeEventListener("pagehide",this.Pi),this.Pi=null)}Ni(e){var t;try{const n=null!==(null===(t=this.Vi)||void 0===t?void 0:t.getItem(this.Oi(e)));return g("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return p("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Li(){if(this.Vi)try{this.Vi.setItem(this.Oi(this.clientId),String(Date.now()))}catch(e){p("Failed to set zombie client id.",e)}}qi(){if(this.Vi)try{this.Vi.removeItem(this.Oi(this.clientId))}catch(e){}}Oi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Lo(e){return et(e,"owner")}function Po(e){return et(e,"clientMetadata")}function qo(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Uo{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.$i=n,this.Ui=r}static Wi(e,t){let n=or(),r=or();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new Uo(e,t.fromCache,n,r)}}class Bo{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class zo{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=(0,o.nr)()?8:le((0,o.ZQ)())>0?6:4}initialize(e,t){this.Ji=e,this.indexManager=t,this.Gi=!0}getDocumentsMatchingQuery(e,t,n,r){const s={result:null};return this.Yi(e,t).next((e=>{s.result=e})).next((()=>{if(!s.result)return this.Zi(e,t,r,n).next((e=>{s.result=e}))})).next((()=>{if(s.result)return;const n=new Bo;return this.Xi(e,t,n).next((r=>{if(s.result=r,this.zi)return this.es(e,t,n,r.size)}))})).next((()=>s.result))}es(e,t,n,r){return n.documentReadCount<this.ji?(f()<=i.$b.DEBUG&&g("QueryEngine","SDK will not create cache indexes for query:",Gn(t),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),ae.resolve()):(f()<=i.$b.DEBUG&&g("QueryEngine","Query:",Gn(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Hi*r?(f()<=i.$b.DEBUG&&g("QueryEngine","The SDK decides to create cache indexes for query:",Gn(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,Ln(t))):ae.resolve())}Yi(e,t){if(Vn(t))return ae.resolve(null);let n=Ln(t);return this.indexManager.getIndexType(e,n).next((r=>0===r?null:(null!==t.limit&&1===r&&(t=Bn(t,null,"F"),n=Ln(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((r=>{const s=or(...r);return this.Ji.getDocuments(e,s).next((r=>this.indexManager.getMinOffset(e,n).next((n=>{const i=this.ts(t,r);return this.ns(t,i,s,n.readTime)?this.Yi(e,Bn(t,null,"F")):this.rs(e,i,t,n)}))))})))))}Zi(e,t,n,r){return Vn(t)||r.isEqual(B.min())?ae.resolve(null):this.Ji.getDocuments(e,n).next((s=>{const o=this.ts(t,s);return this.ns(t,o,n,r)?ae.resolve(null):(f()<=i.$b.DEBUG&&g("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),Gn(t)),this.rs(e,o,t,ee(r,-1)).next((e=>e)))}))}ts(e,t){let n=new ut(jn(e));return t.forEach(((t,r)=>{$n(e,r)&&(n=n.add(r))})),n}ns(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Xi(e,t,n){return f()<=i.$b.DEBUG&&g("QueryEngine","Using full collection scan to execute query:",Gn(t)),this.Ji.getDocumentsMatchingQuery(e,t,ne.min(),n)}rs(e,t,n,r){return this.Ji.getDocumentsMatchingQuery(e,n,r).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class Ko{constructor(e,t,n,r){this.persistence=e,this.ss=t,this.serializer=r,this.os=new it(L),this._s=new Jn((e=>Sn(e)),xn),this.us=new Map,this.cs=e.getRemoteDocumentCache(),this.Ur=e.getTargetCache(),this.Gr=e.getBundleCache(),this.ls(n)}ls(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new vo(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.os)))}}function Go(e,t,n,r){return new Ko(e,t,n,r)}async function $o(e,t){const n=b(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next((s=>(r=s,n.ls(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const s=[],i=[];let o=or();for(const e of r){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next((e=>({hs:e,removedBatchIds:s,addedBatchIds:i})))}))}))}function Qo(e){const t=b(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Ur.getLastRemoteSnapshotVersion(e)))}function jo(e,t,n){let r=or(),s=or();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=Yn();return n.forEach(((n,i)=>{const o=e.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(B.min())?(t.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(i),r=r.insert(n,i)):g("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{Ps:r,Is:s}}))}function Wo(e,t){const n=b(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}function Jo(e,t){const n=b(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.Ur.getTargetData(e,t).next((s=>s?(r=s,ae.resolve(r)):n.Ur.allocateTargetId(e).next((s=>(r=new js(t,s,"TargetPurposeListen",e.currentSequenceNumber),n.Ur.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.os.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.os=n.os.insert(e.targetId,e),n._s.set(t,e.targetId)),e}))}async function Ho(e,t,n){const r=b(e),s=r.os.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(e=>r.persistence.referenceDelegate.removeTarget(e,s)))}catch(e){if(!fe(e))throw e;g("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.os=r.os.remove(t),r._s.delete(s.target)}function Yo(e,t,n){const r=b(e);let s=B.min(),i=or();return r.persistence.runTransaction("Execute query","readwrite",(e=>function(e,t,n){const r=b(e),s=r._s.get(n);return void 0!==s?ae.resolve(r.os.get(s)):r.Ur.getTargetData(t,n)}(r,e,Ln(t)).next((t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,r.Ur.getMatchingKeysForTargetId(e,t.targetId).next((e=>{i=e}))})).next((()=>r.ss.getDocumentsMatchingQuery(e,t,n?s:B.min(),n?i:or()))).next((e=>(ea(r,Qn(t),e),{documents:e,Ts:i})))))}function Xo(e,t){const n=b(e),r=b(n.Ur),s=n.os.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(e=>r.ot(e,t).next((e=>e?e.target:null))))}function Zo(e,t){const n=b(e),r=n.us.get(t)||B.min();return n.persistence.runTransaction("Get new document changes","readonly",(e=>n.cs.getAllFromCollectionGroup(e,t,ee(r,-1),Number.MAX_SAFE_INTEGER))).then((e=>(ea(n,t,e),e)))}function ea(e,t,n){let r=e.us.get(t)||B.min();n.forEach(((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.us.set(t,r)}async function ta(e,t,n=or()){const r=await Jo(e,Ln(ni(t.bundledQuery))),s=b(e);return s.persistence.runTransaction("Save named query","readwrite",(e=>{const i=_s(t.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.Gr.saveNamedQuery(e,t);const o=r.withResumeToken(mt.EMPTY_BYTE_STRING,i);return s.os=s.os.insert(o.targetId,o),s.Ur.updateTargetData(e,o).next((()=>s.Ur.removeMatchingKeysForTargetId(e,r.targetId))).next((()=>s.Ur.addMatchingKeys(e,n,r.targetId))).next((()=>s.Gr.saveNamedQuery(e,t)))}))}function na(e,t){return`firestore_clients_${e}_${t}`}function ra(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function sa(e,t){return`firestore_targets_${e}_${t}`}class ia{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Rs(e,t,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new E(r.error.code,r.error.message))),i?new ia(e,t,r.state,s):(p("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Vs(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class oa{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Rs(e,t){const n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new E(n.error.code,n.error.message))),s?new oa(e,n.state,r):(p("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Vs(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class aa{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Rs(e,t){const n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=ur();for(let e=0;r&&e<n.activeTargetIds.length;++e)r=Te(n.activeTargetIds[e]),s=s.add(n.activeTargetIds[e]);return r?new aa(e,s):(p("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class ua{constructor(e,t){this.clientId=e,this.onlineState=t}static Rs(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new ua(t.clientId,t.onlineState):(p("SharedClientState",`Failed to parse online state: ${e}`),null)}}class ca{constructor(){this.activeTargetIds=ur()}fs(e){this.activeTargetIds=this.activeTargetIds.add(e)}gs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Vs(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class la{constructor(e,t,n,r,s){this.window=e,this.ui=t,this.persistenceKey=n,this.ps=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ys=this.ws.bind(this),this.Ss=new it(L),this.started=!1,this.bs=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Ds=na(this.persistenceKey,this.ps),this.vs=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.Ss=this.Ss.insert(this.ps,new ca),this.Cs=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Fs=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.Ms=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.xs=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.Os=function(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this.ys)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Qi();for(const t of e){if(t===this.ps)continue;const e=this.getItem(na(this.persistenceKey,t));if(e){const n=aa.Rs(t,e);n&&(this.Ss=this.Ss.insert(n.clientId,n))}}this.Ns();const t=this.storage.getItem(this.xs);if(t){const e=this.Ls(t);e&&this.Bs(e)}for(const e of this.bs)this.ws(e);this.bs=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.vs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.ks(this.Ss)}isActiveQueryTarget(e){let t=!1;return this.Ss.forEach(((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.qs(e,"pending")}updateMutationState(e,t,n){this.qs(e,t,n),this.Qs(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){const t=this.storage.getItem(sa(this.persistenceKey,e));if(t){const r=oa.Rs(e,t);r&&(n=r.state)}}return t&&this.Ks.fs(e),this.Ns(),n}removeLocalQueryTarget(e){this.Ks.gs(e),this.Ns()}isLocalQueryTarget(e){return this.Ks.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(sa(this.persistenceKey,e))}updateQueryState(e,t,n){this.$s(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.Qs(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.Us(e)}notifyBundleLoaded(e){this.Ws(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ys),this.removeItem(this.Ds),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return g("SharedClientState","READ",e,t),t}setItem(e,t){g("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){g("SharedClientState","REMOVE",e),this.storage.removeItem(e)}ws(e){const t=e;if(t.storageArea===this.storage){if(g("SharedClientState","EVENT",t.key,t.newValue),t.key===this.Ds)return void p("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ui.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.Cs.test(t.key)){if(null==t.newValue){const e=this.Gs(t.key);return this.zs(e,null)}{const e=this.js(t.key,t.newValue);if(e)return this.zs(e.clientId,e)}}else if(this.Fs.test(t.key)){if(null!==t.newValue){const e=this.Hs(t.key,t.newValue);if(e)return this.Js(e)}}else if(this.Ms.test(t.key)){if(null!==t.newValue){const e=this.Ys(t.key,t.newValue);if(e)return this.Zs(e)}}else if(t.key===this.xs){if(null!==t.newValue){const e=this.Ls(t.newValue);if(e)return this.Bs(e)}}else if(t.key===this.vs){const e=function(e){let t=_e.oe;if(null!=e)try{const n=JSON.parse(e);_("number"==typeof n),t=n}catch(e){p("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==_e.oe&&this.sequenceNumberHandler(e)}else if(t.key===this.Os){const e=this.Xs(t.newValue);await Promise.all(e.map((e=>this.syncEngine.eo(e))))}}else this.bs.push(t)}))}}get Ks(){return this.Ss.get(this.ps)}Ns(){this.setItem(this.Ds,this.Ks.Vs())}qs(e,t,n){const r=new ia(this.currentUser,e,t,n),s=ra(this.persistenceKey,this.currentUser,e);this.setItem(s,r.Vs())}Qs(e){const t=ra(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Us(e){const t={clientId:this.ps,onlineState:e};this.storage.setItem(this.xs,JSON.stringify(t))}$s(e,t,n){const r=sa(this.persistenceKey,e),s=new oa(e,t,n);this.setItem(r,s.Vs())}Ws(e){const t=JSON.stringify(Array.from(e));this.setItem(this.Os,t)}Gs(e){const t=this.Cs.exec(e);return t?t[1]:null}js(e,t){const n=this.Gs(e);return aa.Rs(n,t)}Hs(e,t){const n=this.Fs.exec(e),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return ia.Rs(new l(s),r,t)}Ys(e,t){const n=this.Ms.exec(e),r=Number(n[1]);return oa.Rs(r,t)}Ls(e){return ua.Rs(e)}Xs(e){return JSON.parse(e)}async Js(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.no(e.batchId,e.state,e.error);g("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Zs(e){return this.syncEngine.ro(e.targetId,e.state,e.error)}zs(e,t){const n=t?this.Ss.insert(e,t):this.Ss.remove(e),r=this.ks(this.Ss),s=this.ks(n),i=[],o=[];return s.forEach((e=>{r.has(e)||i.push(e)})),r.forEach((e=>{s.has(e)||o.push(e)})),this.syncEngine.io(i,o).then((()=>{this.Ss=n}))}Bs(e){this.Ss.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}ks(e){let t=ur();return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class ha{constructor(){this.so=new ca,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.so.fs(e),this.oo[e]||"not-current"}updateQueryState(e,t,n){this.oo[e]=t}removeLocalQueryTarget(e){this.so.gs(e)}isLocalQueryTarget(e){return this.so.activeTargetIds.has(e)}clearQueryState(e){delete this.oo[e]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(e){return this.so.activeTargetIds.has(e)}start(){return this.so=new ca,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class da{_o(e){}shutdown(){}}class fa{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(e){this.ho.push(e)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){g("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.ho)e(0)}lo(){g("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.ho)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let ma=null;function ga(){return null===ma?ma=268435456+Math.round(2147483648*Math.random()):ma++,"0x"+ma.toString(16)}const pa={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class ya{constructor(e){this.Io=e.Io,this.To=e.To}Eo(e){this.Ao=e}Ro(e){this.Vo=e}mo(e){this.fo=e}onMessage(e){this.po=e}close(){this.To()}send(e){this.Io(e)}yo(){this.Ao()}wo(){this.Vo()}So(e){this.fo(e)}bo(e){this.po(e)}}const wa="WebChannelConnection";class va extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.Do=t+"://"+e.host,this.vo=`projects/${n}/databases/${r}`,this.Co="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get Fo(){return!1}Mo(e,t,n,r,s){const i=ga(),o=this.xo(e,t.toUriEncodedString());g("RestConnection",`Sending RPC '${e}' ${i}:`,o,n);const a={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(a,r,s),this.No(e,o,a,n).then((t=>(g("RestConnection",`Received RPC '${e}' ${i}: `,t),t)),(t=>{throw y("RestConnection",`RPC '${e}' ${i} failed with error: `,t,"url: ",o,"request:",n),t}))}Lo(e,t,n,r,s,i){return this.Mo(e,t,n,r,s)}Oo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+h,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}xo(e,t){const n=pa[e];return`${this.Do}/v1/${t}:${n}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}No(e,t,n,r){const s=ga();return new Promise(((i,o)=>{const a=new u.ZS;a.setWithCredentials(!0),a.listenOnce(u.Bx.COMPLETE,(()=>{try{switch(a.getLastErrorCode()){case u.O4.NO_ERROR:const t=a.getResponseJson();g(wa,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(t)),i(t);break;case u.O4.TIMEOUT:g(wa,`RPC '${e}' ${s} timed out`),o(new E(T.DEADLINE_EXCEEDED,"Request time out"));break;case u.O4.HTTP_ERROR:const n=a.getStatus();if(g(wa,`RPC '${e}' ${s} failed with status:`,n,"response text:",a.getResponseText()),n>0){let e=a.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(T).indexOf(t)>=0?t:T.UNKNOWN}(t.status);o(new E(e,t.message))}else o(new E(T.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new E(T.UNAVAILABLE,"Connection failed."));break;default:v()}}finally{g(wa,`RPC '${e}' ${s} completed.`)}}));const c=JSON.stringify(r);g(wa,`RPC '${e}' ${s} sending request:`,r),a.send(t,"POST",c,n,15)}))}Bo(e,t,n){const r=ga(),s=[this.Do,"/","google.firestore.v1.Firestore","/",e,"/channel"],i=(0,u.fF)(),o=(0,u.Ao)(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;void 0!==c&&(a.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(a.useFetchStreams=!0),this.Oo(a.initMessageHeaders,t,n),a.encodeInitMessageHeaders=!0;const l=s.join("");g(wa,`Creating RPC '${e}' stream ${r}: ${l}`,a);const h=i.createWebChannel(l,a);let d=!1,f=!1;const m=new ya({Io:t=>{f?g(wa,`Not sending because RPC '${e}' stream ${r} is closed:`,t):(d||(g(wa,`Opening RPC '${e}' stream ${r} transport.`),h.open(),d=!0),g(wa,`RPC '${e}' stream ${r} sending:`,t),h.send(t))},To:()=>h.close()}),p=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return p(h,u.iO.EventType.OPEN,(()=>{f||(g(wa,`RPC '${e}' stream ${r} transport opened.`),m.yo())})),p(h,u.iO.EventType.CLOSE,(()=>{f||(f=!0,g(wa,`RPC '${e}' stream ${r} transport closed`),m.So())})),p(h,u.iO.EventType.ERROR,(t=>{f||(f=!0,y(wa,`RPC '${e}' stream ${r} transport errored:`,t),m.So(new E(T.UNAVAILABLE,"The operation could not be completed")))})),p(h,u.iO.EventType.MESSAGE,(t=>{var n;if(!f){const s=t.data[0];_(!!s);const i=s,o=i.error||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){g(wa,`RPC '${e}' stream ${r} received error:`,o);const t=o.status;let n=function(e){const t=Qr[e];if(void 0!==t)return Jr(t)}(t),s=o.message;void 0===n&&(n=T.INTERNAL,s="Unknown error status: "+t+" with message "+o.message),f=!0,m.So(new E(n,s)),h.close()}else g(wa,`RPC '${e}' stream ${r} received:`,s),m.bo(s)}})),p(o,u.Jh.STAT_EVENT,(t=>{t.stat===u.ro.PROXY?g(wa,`RPC '${e}' stream ${r} detected buffering proxy`):t.stat===u.ro.NOPROXY&&g(wa,`RPC '${e}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{m.wo()}),0),m}}function _a(){return"undefined"!=typeof window?window:null}function Ia(){return"undefined"!=typeof document?document:null}function ba(e){return new gs(e,!0)}class Ta{constructor(e,t,n=1e3,r=1.5,s=6e4){this.ui=e,this.timerId=t,this.ko=n,this.qo=r,this.Qo=s,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(e){this.cancel();const t=Math.floor(this.Ko+this.zo()),n=Math.max(0,Date.now()-this.Uo),r=Math.max(0,t-n);r>0&&g("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Ko} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,r,(()=>(this.Uo=Date.now(),e()))),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){null!==this.$o&&(this.$o.skipDelay(),this.$o=null)}cancel(){null!==this.$o&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}}class Ea{constructor(e,t,n,r,s,i,o,a){this.ui=e,this.Ho=n,this.Jo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new Ta(e,t)}n_(){return 1===this.state||5===this.state||this.r_()}r_(){return 2===this.state||3===this.state}start(){this.e_=0,4!==this.state?this.auth():this.i_()}async stop(){this.n_()&&await this.close(0)}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&null===this.Zo&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,(()=>this.__())))}a_(e){this.u_(),this.stream.send(e)}async __(){if(this.r_())return this.close(0)}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}async close(e,t){this.u_(),this.c_(),this.t_.cancel(),this.Yo++,4!==e?this.t_.reset():t&&t.code===T.RESOURCE_EXHAUSTED?(p(t.toString()),p("Using maximum backoff delay to prevent overloading the backend."),this.t_.Wo()):t&&t.code===T.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.l_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.mo(t)}l_(){}auth(){this.state=1;const e=this.h_(this.Yo),t=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.Yo===t&&this.P_(e,n)}),(t=>{e((()=>{const e=new E(T.UNKNOWN,"Fetching auth token failed: "+t.message);return this.I_(e)}))}))}P_(e,t){const n=this.h_(this.Yo);this.stream=this.T_(e,t),this.stream.Eo((()=>{n((()=>this.listener.Eo()))})),this.stream.Ro((()=>{n((()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,(()=>(this.r_()&&(this.state=3),Promise.resolve()))),this.listener.Ro())))})),this.stream.mo((e=>{n((()=>this.I_(e)))})),this.stream.onMessage((e=>{n((()=>1==++this.e_?this.E_(e):this.onNext(e)))}))}i_(){this.state=5,this.t_.Go((async()=>{this.state=0,this.start()}))}I_(e){return g("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}h_(e){return t=>{this.ui.enqueueAndForget((()=>this.Yo===e?t():(g("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Sa extends Ea{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}T_(e,t){return this.connection.Bo("Listen",e,t)}E_(e){return this.onNext(e)}onNext(e){this.t_.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:v()}(t.targetChange.targetChangeType||"NO_CHANGE"),s=t.targetChange.targetIds||[],i=function(e,t){return e.useProto3Json?(_(void 0===t||"string"==typeof t),mt.fromBase64String(t||"")):(_(void 0===t||t instanceof Buffer||t instanceof Uint8Array),mt.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?T.UNKNOWN:Jr(e.code);return new E(t,e.message||"")}(o);n=new as(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const s=Ss(e,r.document.name),i=_s(r.document.updateTime),o=r.document.createTime?_s(r.document.createTime):B.min(),a=new Jt({mapValue:{fields:r.document.fields}}),u=Yt.newFoundDocument(s,i,o,a),c=r.targetIds||[],l=r.removedTargetIds||[];n=new is(c,l,u.key,u)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const s=Ss(e,r.document),i=r.readTime?_s(r.readTime):B.min(),o=Yt.newNoDocument(s,i),a=r.removedTargetIds||[];n=new is([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const s=Ss(e,r.document),i=r.removedTargetIds||[];n=new is([],i,s,null)}else{if(!("filter"in t))return v();{t.filter;const e=t.filter;e.targetId;const{count:r=0,unchangedNames:s}=e,i=new $r(r,s),o=e.targetId;n=new os(o,i)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return B.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?B.min():t.readTime?_s(t.readTime):B.min()}(e);return this.listener.d_(t,n)}A_(e){const t={};t.database=Cs(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=Dn(r)?{documents:Vs(e,r)}:{query:Ms(e,r)._t},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=ws(e,t.resumeToken);const r=ps(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(B.min())>0){n.readTime=ys(e,t.snapshotVersion.toTimestamp());const r=ps(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);const n=function(e,t){const n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return v()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.a_(t)}R_(e){const t={};t.database=Cs(this.serializer),t.removeTarget=e,this.a_(t)}}class xa extends Ea{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}get V_(){return this.e_>0}start(){this.lastStreamToken=void 0,super.start()}l_(){this.V_&&this.m_([])}T_(e,t){return this.connection.Bo("Write",e,t)}E_(e){return _(!!e.streamToken),this.lastStreamToken=e.streamToken,_(!e.writeResults||0===e.writeResults.length),this.listener.f_()}onNext(e){_(!!e.streamToken),this.lastStreamToken=e.streamToken,this.t_.reset();const t=function(e,t){return e&&e.length>0?(_(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?_s(e.updateTime):_s(t);return n.isEqual(B.min())&&(n=_s(t)),new Sr(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=_s(e.commitTime);return this.listener.g_(n,t)}p_(){const e={};e.database=Cs(this.serializer),this.a_(e)}m_(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>Rs(this.serializer,e)))};this.a_(t)}}class Da extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.y_=!1}w_(){if(this.y_)throw new E(T.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(e,t,n,r){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.connection.Mo(e,bs(t,n),r,s,i))).catch((e=>{throw"FirebaseError"===e.name?(e.code===T.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new E(T.UNKNOWN,e.toString())}))}Lo(e,t,n,r,s){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,o])=>this.connection.Lo(e,bs(t,n),r,i,o,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===T.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new E(T.UNKNOWN,e.toString())}))}terminate(){this.y_=!0,this.connection.terminate()}}class Ca{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){0===this.S_&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve()))))}M_(e){"Online"===this.state?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.C_("Offline")))}set(e){this.x_(),this.S_=0,"Online"===e&&(this.D_=!1),this.C_(e)}C_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}F_(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?(p(t),this.D_=!1):g("OnlineStateTracker",t)}x_(){null!==this.b_&&(this.b_.cancel(),this.b_=null)}}class Na{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=s,this.k_._o((e=>{n.enqueueAndForget((async()=>{Pa(this)&&(g("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=b(e);t.L_.add(4),await ka(t),t.q_.set("Unknown"),t.L_.delete(4),await Aa(t)}(this))}))})),this.q_=new Ca(n,r)}}async function Aa(e){if(Pa(e))for(const t of e.B_)await t(!0)}async function ka(e){for(const t of e.B_)await t(!1)}function Ra(e,t){const n=b(e);n.N_.has(t.targetId)||(n.N_.set(t.targetId,t),La(n)?Oa(n):ru(n).r_()&&Va(n,t))}function Fa(e,t){const n=b(e),r=ru(n);n.N_.delete(t),r.r_()&&Ma(n,t),0===n.N_.size&&(r.r_()?r.o_():Pa(n)&&n.q_.set("Unknown"))}function Va(e,t){if(e.Q_.xe(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(B.min())>0){const n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}ru(e).A_(t)}function Ma(e,t){e.Q_.xe(t),ru(e).R_(t)}function Oa(e){e.Q_=new cs({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),ot:t=>e.N_.get(t)||null,tt:()=>e.datastore.serializer.databaseId}),ru(e).start(),e.q_.v_()}function La(e){return Pa(e)&&!ru(e).n_()&&e.N_.size>0}function Pa(e){return 0===b(e).L_.size}function qa(e){e.Q_=void 0}async function Ua(e){e.q_.set("Online")}async function Ba(e){e.N_.forEach(((t,n)=>{Va(e,t)}))}async function za(e,t){qa(e),La(e)?(e.q_.M_(t),Oa(e)):e.q_.set("Unknown")}async function Ka(e,t,n){if(e.q_.set("Online"),t instanceof as&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.N_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.N_.delete(r),e.Q_.removeTarget(r))}(e,t)}catch(n){g("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await Ga(e,n)}else if(t instanceof is?e.Q_.Ke(t):t instanceof os?e.Q_.He(t):e.Q_.We(t),!n.isEqual(B.min()))try{const t=await Qo(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.Q_.rt(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=e.N_.get(r);s&&e.N_.set(r,s.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach(((t,n)=>{const r=e.N_.get(t);if(!r)return;e.N_.set(t,r.withResumeToken(mt.EMPTY_BYTE_STRING,r.snapshotVersion)),Ma(e,t);const s=new js(r.target,t,n,r.sequenceNumber);Va(e,s)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){g("RemoteStore","Failed to raise snapshot:",t),await Ga(e,t)}}async function Ga(e,t,n){if(!fe(t))throw t;e.L_.add(1),await ka(e),e.q_.set("Offline"),n||(n=()=>Qo(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{g("RemoteStore","Retrying IndexedDB access"),await n(),e.L_.delete(1),await Aa(e)}))}function $a(e,t){return t().catch((n=>Ga(e,n,t)))}async function Qa(e){const t=b(e),n=su(t);let r=t.O_.length>0?t.O_[t.O_.length-1].batchId:-1;for(;ja(t);)try{const e=await Wo(t.localStore,r);if(null===e){0===t.O_.length&&n.o_();break}r=e.batchId,Wa(t,e)}catch(e){await Ga(t,e)}Ja(t)&&Ha(t)}function ja(e){return Pa(e)&&e.O_.length<10}function Wa(e,t){e.O_.push(t);const n=su(e);n.r_()&&n.V_&&n.m_(t.mutations)}function Ja(e){return Pa(e)&&!su(e).n_()&&e.O_.length>0}function Ha(e){su(e).start()}async function Ya(e){su(e).p_()}async function Xa(e){const t=su(e);for(const n of e.O_)t.m_(n.mutations)}async function Za(e,t,n){const r=e.O_.shift(),s=zr.from(r,t,n);await $a(e,(()=>e.remoteSyncer.applySuccessfulWrite(s))),await Qa(e)}async function eu(e,t){t&&su(e).V_&&await async function(e,t){if(function(e){return Wr(e)&&e!==T.ABORTED}(t.code)){const n=e.O_.shift();su(e).s_(),await $a(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await Qa(e)}}(e,t),Ja(e)&&Ha(e)}async function tu(e,t){const n=b(e);n.asyncQueue.verifyOperationInProgress(),g("RemoteStore","RemoteStore received new credentials");const r=Pa(n);n.L_.add(3),await ka(n),r&&n.q_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.L_.delete(3),await Aa(n)}async function nu(e,t){const n=b(e);t?(n.L_.delete(2),await Aa(n)):t||(n.L_.add(2),await ka(n),n.q_.set("Unknown"))}function ru(e){return e.K_||(e.K_=function(e,t,n){const r=b(e);return r.w_(),new Sa(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Eo:Ua.bind(null,e),Ro:Ba.bind(null,e),mo:za.bind(null,e),d_:Ka.bind(null,e)}),e.B_.push((async t=>{t?(e.K_.s_(),La(e)?Oa(e):e.q_.set("Unknown")):(await e.K_.stop(),qa(e))}))),e.K_}function su(e){return e.U_||(e.U_=function(e,t,n){const r=b(e);return r.w_(),new xa(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Eo:()=>Promise.resolve(),Ro:Ya.bind(null,e),mo:eu.bind(null,e),f_:Xa.bind(null,e),g_:Za.bind(null,e)}),e.B_.push((async t=>{t?(e.U_.s_(),await Qa(e)):(await e.U_.stop(),e.O_.length>0&&(g("RemoteStore",`Stopping write stream with ${e.O_.length} pending writes`),e.O_=[]))}))),e.U_}class iu{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new S,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new iu(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new E(T.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function ou(e,t){if(p("AsyncQueue",`${t}: ${e}`),fe(e))return new E(T.UNAVAILABLE,`${t}: ${e}`);throw e}class au{constructor(e){this.comparator=e?(t,n)=>e(t,n)||Q.comparator(t.key,n.key):(e,t)=>Q.comparator(e.key,t.key),this.keyedMap=Zn(),this.sortedSet=new it(this.comparator)}static emptySet(e){return new au(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof au))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new au;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class uu{constructor(){this.W_=new it(Q.comparator)}track(e){const t=e.doc.key,n=this.W_.get(t);n?0!==e.type&&3===n.type?this.W_=this.W_.insert(t,e):3===e.type&&1!==n.type?this.W_=this.W_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.W_=this.W_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.W_=this.W_.remove(t):1===e.type&&2===n.type?this.W_=this.W_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):v():this.W_=this.W_.insert(t,e)}G_(){const e=[];return this.W_.inorderTraversal(((t,n)=>{e.push(n)})),e}}class cu{constructor(e,t,n,r,s,i,o,a,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach((e=>{i.push({type:0,doc:e})})),new cu(e,t,au.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&zn(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class lu{constructor(){this.z_=void 0,this.j_=[]}H_(){return this.j_.some((e=>e.J_()))}}class hu{constructor(){this.queries=du(),this.onlineState="Unknown",this.Y_=new Set}terminate(){!function(e,t){const n=b(e),r=n.queries;n.queries=du(),r.forEach(((e,n)=>{for(const e of n.j_)e.onError(t)}))}(this,new E(T.ABORTED,"Firestore shutting down"))}}function du(){return new Jn((e=>Kn(e)),zn)}async function fu(e,t){const n=b(e);let r=3;const s=t.query;let i=n.queries.get(s);i?!i.H_()&&t.J_()&&(r=2):(i=new lu,r=t.J_()?0:1);try{switch(r){case 0:i.z_=await n.onListen(s,!0);break;case 1:i.z_=await n.onListen(s,!1);break;case 2:await n.onFirstRemoteStoreListen(s)}}catch(e){const n=ou(e,`Initialization of query '${Gn(t.query)}' failed`);return void t.onError(n)}n.queries.set(s,i),i.j_.push(t),t.Z_(n.onlineState),i.z_&&t.X_(i.z_)&&yu(n)}async function mu(e,t){const n=b(e),r=t.query;let s=3;const i=n.queries.get(r);if(i){const e=i.j_.indexOf(t);e>=0&&(i.j_.splice(e,1),0===i.j_.length?s=t.J_()?0:1:!i.H_()&&t.J_()&&(s=2))}switch(s){case 0:return n.queries.delete(r),n.onUnlisten(r,!0);case 1:return n.queries.delete(r),n.onUnlisten(r,!1);case 2:return n.onLastRemoteStoreUnlisten(r);default:return}}function gu(e,t){const n=b(e);let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.j_)t.X_(e)&&(r=!0);s.z_=e}}r&&yu(n)}function pu(e,t,n){const r=b(e),s=r.queries.get(t);if(s)for(const e of s.j_)e.onError(n);r.queries.delete(t)}function yu(e){e.Y_.forEach((e=>{e.next()}))}var wu,vu;(vu=wu||(wu={})).ea="default",vu.Cache="cache";class _u{constructor(e,t,n){this.query=e,this.ta=t,this.na=!1,this.ra=null,this.onlineState="Unknown",this.options=n||{}}X_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new cu(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.na?this.ia(e)&&(this.ta.next(e),t=!0):this.sa(e,this.onlineState)&&(this.oa(e),t=!0),this.ra=e,t}onError(e){this.ta.error(e)}Z_(e){this.onlineState=e;let t=!1;return this.ra&&!this.na&&this.sa(this.ra,e)&&(this.oa(this.ra),t=!0),t}sa(e,t){if(!e.fromCache)return!0;if(!this.J_())return!0;const n="Offline"!==t;return(!this.options._a||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}ia(e){if(e.docChanges.length>0)return!0;const t=this.ra&&this.ra.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}oa(e){e=cu.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.na=!0,this.ta.next(e)}J_(){return this.options.source!==wu.Cache}}class Iu{constructor(e,t){this.aa=e,this.byteLength=t}ua(){return"metadata"in this.aa}}class bu{constructor(e){this.serializer=e}Es(e){return Ss(this.serializer,e)}ds(e){return e.metadata.exists?ks(this.serializer,e.document,!1):Yt.newNoDocument(this.Es(e.metadata.name),this.As(e.metadata.readTime))}As(e){return _s(e)}}class Tu{constructor(e,t,n){this.ca=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Eu(e)}la(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.aa.namedQuery)this.queries.push(e.aa.namedQuery);else if(e.aa.documentMetadata){this.documents.push({metadata:e.aa.documentMetadata}),e.aa.documentMetadata.exists||++t;const n=K.fromString(e.aa.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.aa.document&&(this.documents[this.documents.length-1].document=e.aa.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ha(e){const t=new Map,n=new bu(this.serializer);for(const r of e)if(r.metadata.queries){const e=n.Es(r.metadata.name);for(const n of r.metadata.queries){const r=(t.get(n)||or()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=b(e);let i=or(),o=Yn();for(const e of n){const n=t.Es(e.metadata.name);e.document&&(i=i.add(n));const r=t.ds(e);r.setReadTime(t.As(e.metadata.readTime)),o=o.insert(n,r)}const a=s.cs.newChangeBuffer({trackRemovals:!0}),u=await Jo(s,function(e){return Ln(Fn(K.fromString(`__bundle__/docs/${e}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(e=>jo(e,a,o).next((t=>(a.apply(e),t))).next((t=>s.Ur.removeMatchingKeysForTargetId(e,u.targetId).next((()=>s.Ur.addMatchingKeys(e,i,u.targetId))).next((()=>s.localDocuments.getLocalViewOfDocuments(e,t.Ps,t.Is))).next((()=>t.Ps))))))}(this.localStore,new bu(this.serializer),this.documents,this.ca.id),t=this.ha(this.documents);for(const e of this.queries)await ta(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,Pa:this.collectionGroups,Ia:e}}}function Eu(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Su{constructor(e){this.key=e}}class xu{constructor(e){this.key=e}}class Du{constructor(e,t){this.query=e,this.Ta=t,this.Ea=null,this.hasCachedResults=!1,this.current=!1,this.da=or(),this.mutatedKeys=or(),this.Aa=jn(e),this.Ra=new au(this.Aa)}get Va(){return this.Ta}ma(e,t){const n=t?t.fa:new uu,r=t?t.Ra:this.Ra;let s=t?t.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,u="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const c=r.get(e),l=$n(this.query,t)?t:null,h=!!c&&this.mutatedKeys.has(c.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;c&&l?c.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.ga(c,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.Aa(l,a)>0||u&&this.Aa(l,u)<0)&&(o=!0)):!c&&l?(n.track({type:0,doc:l}),f=!0):c&&!l&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(e):s.delete(e)):(i=i.delete(e),s=s.delete(e)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const e="F"===this.query.limitType?i.last():i.first();i=i.delete(e.key),s=s.delete(e.key),n.track({type:1,doc:e})}return{Ra:i,fa:n,ns:o,mutatedKeys:s}}ga(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){const s=this.Ra;this.Ra=e.Ra,this.mutatedKeys=e.mutatedKeys;const i=e.fa.G_();i.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return v()}};return n(e)-n(t)}(e.type,t.type)||this.Aa(e.doc,t.doc))),this.pa(n),r=null!=r&&r;const o=t&&!r?this.ya():[],a=0===this.da.size&&this.current&&!r?1:0,u=a!==this.Ea;return this.Ea=a,0!==i.length||u?{snapshot:new cu(this.query,e.Ra,s,i,e.mutatedKeys,0===a,u,!1,!!n&&n.resumeToken.approximateByteSize()>0),wa:o}:{wa:o}}Z_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ra:this.Ra,fa:new uu,mutatedKeys:this.mutatedKeys,ns:!1},!1)):{wa:[]}}Sa(e){return!this.Ta.has(e)&&!!this.Ra.has(e)&&!this.Ra.get(e).hasLocalMutations}pa(e){e&&(e.addedDocuments.forEach((e=>this.Ta=this.Ta.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.Ta=this.Ta.delete(e))),this.current=e.current)}ya(){if(!this.current)return[];const e=this.da;this.da=or(),this.Ra.forEach((e=>{this.Sa(e.key)&&(this.da=this.da.add(e.key))}));const t=[];return e.forEach((e=>{this.da.has(e)||t.push(new xu(e))})),this.da.forEach((n=>{e.has(n)||t.push(new Su(n))})),t}ba(e){this.Ta=e.Ts,this.da=or();const t=this.ma(e.documents);return this.applyChanges(t,!0)}Da(){return cu.fromInitialDocuments(this.query,this.Ra,this.mutatedKeys,0===this.Ea,this.hasCachedResults)}}class Cu{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Nu{constructor(e){this.key=e,this.va=!1}}class Au{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.Ca={},this.Fa=new Jn((e=>Kn(e)),zn),this.Ma=new Map,this.xa=new Set,this.Oa=new it(Q.comparator),this.Na=new Map,this.La=new To,this.Ba={},this.ka=new Map,this.qa=Hi.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return!0===this.Qa}}async function ku(e,t,n=!0){const r=oc(e);let s;const i=r.Fa.get(t);return i?(r.sharedClientState.addLocalQueryTarget(i.targetId),s=i.view.Da()):s=await Fu(r,t,n,!0),s}async function Ru(e,t){const n=oc(e);await Fu(n,t,!0,!1)}async function Fu(e,t,n,r){const s=await Jo(e.localStore,Ln(t)),i=s.targetId,o=e.sharedClientState.addLocalQueryTarget(i,n);let a;return r&&(a=await Vu(e,t,i,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&Ra(e.remoteStore,s),a}async function Vu(e,t,n,r,s){e.Ka=(t,n,r)=>async function(e,t,n,r){let s=t.view.ma(n);s.ns&&(s=await Yo(e.localStore,t.query,!1).then((({documents:e})=>t.view.ma(e,s))));const i=r&&r.targetChanges.get(t.targetId),o=r&&null!=r.targetMismatches.get(t.targetId),a=t.view.applyChanges(s,e.isPrimaryClient,i,o);return Qu(e,t.targetId,a.wa),a.snapshot}(e,t,n,r);const i=await Yo(e.localStore,t,!0),o=new Du(t,i.Ts),a=o.ma(i.documents),u=ss.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,s),c=o.applyChanges(a,e.isPrimaryClient,u);Qu(e,n,c.wa);const l=new Cu(t,n,o);return e.Fa.set(t,l),e.Ma.has(n)?e.Ma.get(n).push(t):e.Ma.set(n,[t]),c.snapshot}async function Mu(e,t,n){const r=b(e),s=r.Fa.get(t),i=r.Ma.get(s.targetId);if(i.length>1)return r.Ma.set(s.targetId,i.filter((e=>!zn(e,t)))),void r.Fa.delete(t);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(s.targetId),r.sharedClientState.isActiveQueryTarget(s.targetId)||await Ho(r.localStore,s.targetId,!1).then((()=>{r.sharedClientState.clearQueryState(s.targetId),n&&Fa(r.remoteStore,s.targetId),Gu(r,s.targetId)})).catch(oe)):(Gu(r,s.targetId),await Ho(r.localStore,s.targetId,!0))}async function Ou(e,t){const n=b(e),r=n.Fa.get(t),s=n.Ma.get(r.targetId);n.isPrimaryClient&&1===s.length&&(n.sharedClientState.removeLocalQueryTarget(r.targetId),Fa(n.remoteStore,r.targetId))}async function Lu(e,t){const n=b(e);try{const e=await function(e,t){const n=b(e),r=t.snapshotVersion;let s=n.os;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const i=n.cs.newChangeBuffer({trackRemovals:!0});s=n.os;const o=[];t.targetChanges.forEach(((i,a)=>{const u=s.get(a);if(!u)return;o.push(n.Ur.removeMatchingKeys(e,i.removedDocuments,a).next((()=>n.Ur.addMatchingKeys(e,i.addedDocuments,a))));let c=u.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(a)?c=c.withResumeToken(mt.EMPTY_BYTE_STRING,B.min()).withLastLimboFreeSnapshotVersion(B.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,r)),s=s.insert(a,c),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(u,c,i)&&o.push(n.Ur.updateTargetData(e,c))}));let a=Yn(),u=or();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),o.push(jo(e,i,t.documentUpdates).next((e=>{a=e.Ps,u=e.Is}))),!r.isEqual(B.min())){const t=n.Ur.getLastRemoteSnapshotVersion(e).next((t=>n.Ur.setTargetsMetadata(e,e.currentSequenceNumber,r)));o.push(t)}return ae.waitFor(o).next((()=>i.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,a,u))).next((()=>a))})).then((e=>(n.os=s,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.Na.get(t);r&&(_(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.va=!0:e.modifiedDocuments.size>0?_(r.va):e.removedDocuments.size>0&&(_(r.va),r.va=!1))})),await Ju(n,e,t)}catch(e){await oe(e)}}function Pu(e,t,n){const r=b(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.Fa.forEach(((n,r)=>{const s=r.view.Z_(t);s.snapshot&&e.push(s.snapshot)})),function(e,t){const n=b(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const e of n.j_)e.Z_(t)&&(r=!0)})),r&&yu(n)}(r.eventManager,t),e.length&&r.Ca.d_(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function qu(e,t,n){const r=b(e);r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.Na.get(t),i=s&&s.key;if(i){let e=new it(Q.comparator);e=e.insert(i,Yt.newNoDocument(i,B.min()));const n=or().add(i),s=new rs(B.min(),new Map,new it(L),e,n);await Lu(r,s),r.Oa=r.Oa.remove(i),r.Na.delete(t),Wu(r)}else await Ho(r.localStore,t,!1).then((()=>Gu(r,t,n))).catch(oe)}async function Uu(e,t){const n=b(e),r=t.batch.batchId;try{const e=await function(e,t){const n=b(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),s=n.cs.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const s=n.batch,i=s.keys();let o=ae.resolve();return i.forEach((e=>{o=o.next((()=>r.getEntry(t,e))).next((t=>{const i=n.docVersions.get(e);_(null!==i),t.version.compareTo(i)<0&&(s.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),o.next((()=>e.mutationQueue.removeMutationBatch(t,s)))}(n,e,t,s).next((()=>s.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=or();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(n.localStore,t);Ku(n,r,null),zu(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Ju(n,e)}catch(e){await oe(e)}}async function Bu(e,t,n){const r=b(e);try{const e=await function(e,t){const n=b(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(_(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(r.localStore,t);Ku(r,t,n),zu(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Ju(r,e)}catch(n){await oe(n)}}function zu(e,t){(e.ka.get(t)||[]).forEach((e=>{e.resolve()})),e.ka.delete(t)}function Ku(e,t,n){const r=b(e);let s=r.Ba[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.Ba[r.currentUser.toKey()]=s}}function Gu(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.Ma.get(t))e.Fa.delete(r),n&&e.Ca.$a(r,n);e.Ma.delete(t),e.isPrimaryClient&&e.La.gr(t).forEach((t=>{e.La.containsKey(t)||$u(e,t)}))}function $u(e,t){e.xa.delete(t.path.canonicalString());const n=e.Oa.get(t);null!==n&&(Fa(e.remoteStore,n),e.Oa=e.Oa.remove(t),e.Na.delete(n),Wu(e))}function Qu(e,t,n){for(const r of n)r instanceof Su?(e.La.addReference(r.key,t),ju(e,r)):r instanceof xu?(g("SyncEngine","Document no longer in limbo: "+r.key),e.La.removeReference(r.key,t),e.La.containsKey(r.key)||$u(e,r.key)):v()}function ju(e,t){const n=t.key,r=n.path.canonicalString();e.Oa.get(n)||e.xa.has(r)||(g("SyncEngine","New document in limbo: "+n),e.xa.add(r),Wu(e))}function Wu(e){for(;e.xa.size>0&&e.Oa.size<e.maxConcurrentLimboResolutions;){const t=e.xa.values().next().value;e.xa.delete(t);const n=new Q(K.fromString(t)),r=e.qa.next();e.Na.set(r,new Nu(n)),e.Oa=e.Oa.insert(n,r),Ra(e.remoteStore,new js(Ln(Fn(n.path)),r,"TargetPurposeLimboResolution",_e.oe))}}async function Ju(e,t,n){const r=b(e),s=[],i=[],o=[];r.Fa.isEmpty()||(r.Fa.forEach(((e,a)=>{o.push(r.Ka(a,t,n).then((e=>{var t;if((e||n)&&r.isPrimaryClient){const s=e?!e.fromCache:null===(t=null==n?void 0:n.targetChanges.get(a.targetId))||void 0===t?void 0:t.current;r.sharedClientState.updateQueryState(a.targetId,s?"current":"not-current")}if(e){s.push(e);const t=Uo.Wi(a.targetId,e);i.push(t)}})))})),await Promise.all(o),r.Ca.d_(s),await async function(e,t){const n=b(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>ae.forEach(t,(t=>ae.forEach(t.$i,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>ae.forEach(t.Ui,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!fe(e))throw e;g("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=n.os.get(t),r=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(r);n.os=n.os.insert(t,s)}}}(r.localStore,i))}async function Hu(e,t){const n=b(e);if(!n.currentUser.isEqual(t)){g("SyncEngine","User change. New user:",t.toKey());const e=await $o(n.localStore,t);n.currentUser=t,function(e){e.ka.forEach((e=>{e.forEach((e=>{e.reject(new E(T.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.ka.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await Ju(n,e.hs)}}function Yu(e,t){const n=b(e),r=n.Na.get(t);if(r&&r.va)return or().add(r.key);{let e=or();const r=n.Ma.get(t);if(!r)return e;for(const t of r){const r=n.Fa.get(t);e=e.unionWith(r.view.Va)}return e}}async function Xu(e,t){const n=b(e),r=await Yo(n.localStore,t.query,!0),s=t.view.ba(r);return n.isPrimaryClient&&Qu(n,t.targetId,s.wa),s}async function Zu(e,t){const n=b(e);return Zo(n.localStore,t).then((e=>Ju(n,e)))}async function ec(e,t,n,r){const s=b(e),i=await function(e,t){const n=b(e),r=b(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>r.Mn(e,t).next((t=>t?n.localDocuments.getDocuments(e,t):ae.resolve(null)))))}(s.localStore,t);null!==i?("pending"===n?await Qa(s.remoteStore):"acknowledged"===n||"rejected"===n?(Ku(s,t,r||null),zu(s,t),function(e,t){b(b(e).mutationQueue).On(t)}(s.localStore,t)):v(),await Ju(s,i)):g("SyncEngine","Cannot apply mutation batch with id: "+t)}async function tc(e,t,n){const r=b(e),s=[],i=[];for(const e of t){let t;const n=r.Ma.get(e);if(n&&0!==n.length){t=await Jo(r.localStore,Ln(n[0]));for(const e of n){const t=r.Fa.get(e),n=await Xu(r,t);n.snapshot&&i.push(n.snapshot)}}else{const n=await Xo(r.localStore,e);t=await Jo(r.localStore,n),await Vu(r,nc(n),e,!1,t.resumeToken)}s.push(t)}return r.Ca.d_(i),s}function nc(e){return Rn(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function rc(e){return function(e){return b(b(e).persistence).Qi()}(b(e).localStore)}async function sc(e,t,n,r){const s=b(e);if(s.Qa)return void g("SyncEngine","Ignoring unexpected query state notification.");const i=s.Ma.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{const e=await Zo(s.localStore,Qn(i[0])),r=rs.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,mt.EMPTY_BYTE_STRING);await Ju(s,e,r);break}case"rejected":await Ho(s.localStore,t,!0),Gu(s,t,r);break;default:v()}}async function ic(e,t,n){const r=oc(e);if(r.Qa){for(const e of t){if(r.Ma.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){g("SyncEngine","Adding an already active target "+e);continue}const t=await Xo(r.localStore,e),n=await Jo(r.localStore,t);await Vu(r,nc(t),n.targetId,!1,n.resumeToken),Ra(r.remoteStore,n)}for(const e of n)r.Ma.has(e)&&await Ho(r.localStore,e,!1).then((()=>{Fa(r.remoteStore,e),Gu(r,e)})).catch(oe)}}function oc(e){const t=b(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=Lu.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Yu.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=qu.bind(null,t),t.Ca.d_=gu.bind(null,t.eventManager),t.Ca.$a=pu.bind(null,t.eventManager),t}function ac(e){const t=b(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Uu.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Bu.bind(null,t),t}class uc{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=ba(e.databaseInfo.databaseId),this.sharedClientState=this.Wa(e),this.persistence=this.Ga(e),await this.persistence.start(),this.localStore=this.za(e),this.gcScheduler=this.ja(e,this.localStore),this.indexBackfillerScheduler=this.Ha(e,this.localStore)}ja(e,t){return null}Ha(e,t){return null}za(e){return Go(this.persistence,new zo,e.initialUser,this.serializer)}Ga(e){return new No(ko.Zr,this.serializer)}Wa(e){return new ha}async terminate(){var e,t;null===(e=this.gcScheduler)||void 0===e||e.stop(),null===(t=this.indexBackfillerScheduler)||void 0===t||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}uc.provider={build:()=>new uc};class cc extends uc{constructor(e){super(),this.cacheSizeBytes=e}ja(e,t){_(this.persistence.referenceDelegate instanceof Ro);const n=this.persistence.referenceDelegate.garbageCollector;return new ro(n,e.asyncQueue,t)}Ga(e){const t=void 0!==this.cacheSizeBytes?zi.withCacheSize(this.cacheSizeBytes):zi.DEFAULT;return new No((e=>Ro.Zr(e,t)),this.serializer)}}class lc extends uc{constructor(e,t,n){super(),this.Ja=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Ja.initialize(this,e),await ac(this.Ja.syncEngine),await Qa(this.Ja.remoteStore),await this.persistence.yi((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}za(e){return Go(this.persistence,new zo,e.initialUser,this.serializer)}ja(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new ro(n,e.asyncQueue,t)}Ha(e,t){const n=new ve(t,this.persistence);return new we(e.asyncQueue,n)}Ga(e){const t=qo(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?zi.withCacheSize(this.cacheSizeBytes):zi.DEFAULT;return new Oo(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,_a(),Ia(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Wa(e){return new ha}}class hc extends lc{constructor(e,t){super(e,t,!1),this.Ja=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.Ja.syncEngine;this.sharedClientState instanceof la&&(this.sharedClientState.syncEngine={no:ec.bind(null,t),ro:sc.bind(null,t),io:ic.bind(null,t),Qi:rc.bind(null,t),eo:Zu.bind(null,t)},await this.sharedClientState.start()),await this.persistence.yi((async e=>{await async function(e,t){const n=b(e);if(oc(n),ac(n),!0===t&&!0!==n.Qa){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await tc(n,e.toArray());n.Qa=!0,await nu(n.remoteStore,!0);for(const e of t)Ra(n.remoteStore,e)}else if(!1===t&&!1!==n.Qa){const e=[];let t=Promise.resolve();n.Ma.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?e.push(s):t=t.then((()=>(Gu(n,s),Ho(n.localStore,s,!0)))),Fa(n.remoteStore,s)})),await t,await tc(n,e),function(e){const t=b(e);t.Na.forEach(((e,n)=>{Fa(t.remoteStore,n)})),t.La.pr(),t.Na=new Map,t.Oa=new it(Q.comparator)}(n),n.Qa=!1,await nu(n.remoteStore,!1)}}(this.Ja.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())}))}Wa(e){const t=_a();if(!la.D(t))throw new E(T.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=qo(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new la(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class dc{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Pu(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=Hu.bind(null,this.syncEngine),await nu(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new hu}createDatastore(e){const t=ba(e.databaseInfo.databaseId),n=function(e){return new va(e)}(e.databaseInfo);return function(e,t,n,r){return new Da(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return function(e,t,n,r,s){return new Na(e,t,n,r,s)}(this.localStore,this.datastore,e.asyncQueue,(e=>Pu(this.syncEngine,e,0)),fa.D()?new fa:new da)}createSyncEngine(e,t){return function(e,t,n,r,s,i,o){const a=new Au(e,t,n,r,s,i);return o&&(a.Qa=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e,t;await async function(e){const t=b(e);g("RemoteStore","RemoteStore shutting down."),t.L_.add(5),await ka(t),t.k_.shutdown(),t.q_.set("Unknown")}(this.remoteStore),null===(e=this.datastore)||void 0===e||e.terminate(),null===(t=this.eventManager)||void 0===t||t.terminate()}}function fc(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}dc.provider={build:()=>new dc};class mc{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ya(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ya(this.observer.error,e):p("Uncaught Error in snapshot listener:",e.toString()))}Za(){this.muted=!0}Ya(e,t){setTimeout((()=>{this.muted||e(t)}),0)}}class gc{constructor(e,t){this.Xa=e,this.serializer=t,this.metadata=new S,this.buffer=new Uint8Array,this.eu=new TextDecoder("utf-8"),this.tu().then((e=>{e&&e.ua()?this.metadata.resolve(e.aa.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.aa)}`))}),(e=>this.metadata.reject(e)))}close(){return this.Xa.cancel()}async getMetadata(){return this.metadata.promise}async Ua(){return await this.getMetadata(),this.tu()}async tu(){const e=await this.nu();if(null===e)return null;const t=this.eu.decode(e),n=Number(t);isNaN(n)&&this.ru(`length string (${t}) is not valid number`);const r=await this.iu(n);return new Iu(JSON.parse(r),e.length+n)}su(){return this.buffer.findIndex((e=>e==="{".charCodeAt(0)))}async nu(){for(;this.su()<0&&!await this.ou(););if(0===this.buffer.length)return null;const e=this.su();e<0&&this.ru("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async iu(e){for(;this.buffer.length<e;)await this.ou()&&this.ru("Reached the end of bundle when more is expected.");const t=this.eu.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}ru(e){throw this.Xa.cancel(),new Error(`Invalid bundle format: ${e}`)}async ou(){const e=await this.Xa.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class pc{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new E(T.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;const t=await async function(e,t){const n=b(e),r={documents:t.map((e=>Es(n.serializer,e)))},s=await n.Lo("BatchGetDocuments",n.serializer.databaseId,K.emptyPath(),r,t.length),i=new Map;s.forEach((e=>{const t=function(e,t){return"found"in t?function(e,t){_(!!t.found),t.found.name,t.found.updateTime;const n=Ss(e,t.found.name),r=_s(t.found.updateTime),s=t.found.createTime?_s(t.found.createTime):B.min(),i=new Jt({mapValue:{fields:t.found.fields}});return Yt.newFoundDocument(n,r,s,i)}(e,t):"missing"in t?function(e,t){_(!!t.missing),_(!!t.readTime);const n=Ss(e,t.missing),r=_s(t.readTime);return Yt.newNoDocument(n,r)}(e,t):v()}(n.serializer,e);i.set(t.key.toString(),t)}));const o=[];return t.forEach((e=>{const t=i.get(e.toString());_(!!t),o.push(t)})),o}(this.datastore,e);return t.forEach((e=>this.recordVersion(e))),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new qr(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;const e=this.readVersions;this.mutations.forEach((t=>{e.delete(t.key.toString())})),e.forEach(((e,t)=>{const n=Q.fromPath(t);this.mutations.push(new Ur(n,this.precondition(n)))})),await async function(e,t){const n=b(e),r={writes:t.map((e=>Rs(n.serializer,e)))};await n.Mo("Commit",n.serializer.databaseId,K.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw v();t=B.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new E(T.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(B.min())?xr.exists(!1):xr.updateTime(t):xr.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(B.min()))throw new E(T.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return xr.updateTime(t)}return xr.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class yc{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this._u=n.maxAttempts,this.t_=new Ta(this.asyncQueue,"transaction_retry")}au(){this._u-=1,this.uu()}uu(){this.t_.Go((async()=>{const e=new pc(this.datastore),t=this.cu(e);t&&t.then((t=>{this.asyncQueue.enqueueAndForget((()=>e.commit().then((()=>{this.deferred.resolve(t)})).catch((e=>{this.lu(e)}))))})).catch((e=>{this.lu(e)}))}))}cu(e){try{const t=this.updateFunction(e);return!Ie(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}lu(e){this._u>0&&this.hu(e)?(this._u-=1,this.asyncQueue.enqueueAndForget((()=>(this.uu(),Promise.resolve())))):this.deferred.reject(e)}hu(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!Wr(t)}return!1}}class wc{constructor(e,t,n,r,s){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=l.UNAUTHENTICATED,this.clientId=O.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=s,this.authCredentials.start(n,(async e=>{g("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(g("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();const e=new S;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=ou(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function vc(e,t){e.asyncQueue.verifyOperationInProgress(),g("FirestoreClient","Initializing OfflineComponentProvider");const n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await $o(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e._offlineComponents=t}async function _c(e,t){e.asyncQueue.verifyOperationInProgress();const n=await Ic(e);g("FirestoreClient","Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener((e=>tu(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>tu(t.remoteStore,n))),e._onlineComponents=t}async function Ic(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){g("FirestoreClient","Using user provided OfflineComponentProvider");try{await vc(e,e._uninitializedComponentsProvider._offline)}catch(t){const n=t;if(!function(e){return"FirebaseError"===e.name?e.code===T.FAILED_PRECONDITION||e.code===T.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}(n))throw n;y("Error using user provided cache. Falling back to memory cache: "+n),await vc(e,new uc)}}else g("FirestoreClient","Using default OfflineComponentProvider"),await vc(e,new uc);return e._offlineComponents}async function bc(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(g("FirestoreClient","Using user provided OnlineComponentProvider"),await _c(e,e._uninitializedComponentsProvider._online)):(g("FirestoreClient","Using default OnlineComponentProvider"),await _c(e,new dc))),e._onlineComponents}function Tc(e){return Ic(e).then((e=>e.persistence))}function Ec(e){return Ic(e).then((e=>e.localStore))}function Sc(e){return bc(e).then((e=>e.remoteStore))}function xc(e){return bc(e).then((e=>e.syncEngine))}function Dc(e){return bc(e).then((e=>e.datastore))}async function Cc(e){const t=await bc(e),n=t.eventManager;return n.onListen=ku.bind(null,t.syncEngine),n.onUnlisten=Mu.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=Ru.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=Ou.bind(null,t.syncEngine),n}function Nc(e,t,n={}){const r=new S;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new mc({next:a=>{i.Za(),t.enqueueAndForget((()=>mu(e,o)));const u=a.docs.has(n);!u&&a.fromCache?s.reject(new E(T.UNAVAILABLE,"Failed to get document because the client is offline.")):u&&a.fromCache&&r&&"server"===r.source?s.reject(new E(T.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(a)},error:e=>s.reject(e)}),o=new _u(Fn(n.path),i,{includeMetadataChanges:!0,_a:!0});return fu(e,o)}(await Cc(e),e.asyncQueue,t,n,r))),r.promise}function Ac(e,t,n={}){const r=new S;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new mc({next:n=>{i.Za(),t.enqueueAndForget((()=>mu(e,o))),n.fromCache&&"server"===r.source?s.reject(new E(T.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:e=>s.reject(e)}),o=new _u(n,i,{includeMetadataChanges:!0,_a:!0});return fu(e,o)}(await Cc(e),e.asyncQueue,t,n,r))),r.promise}function kc(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const Rc=new Map;function Fc(e,t,n){if(!n)throw new E(T.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Vc(e,t,n,r){if(!0===t&&!0===r)throw new E(T.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function Mc(e){if(!Q.isDocumentKey(e))throw new E(T.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Oc(e){if(Q.isDocumentKey(e))throw new E(T.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Lc(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":v()}function Pc(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new E(T.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Lc(e);throw new E(T.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function qc(e,t){if(t<=0)throw new E(T.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class Uc{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new E(T.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new E(T.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}Vc("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=kc(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new E(T.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new E(T.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new E(T.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(e,t){return e.timeoutSeconds===t.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Bc{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Uc({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new E(T.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new E(T.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Uc(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new D;switch(e.type){case"firstParty":return new k(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new E(T.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Rc.get(e);t&&(g("ComponentProvider","Removing Datastore"),Rc.delete(e),t.terminate())}(this),Promise.resolve()}}function zc(e,t,n,r={}){var s;const i=(e=Pc(e,Bc))._getSettings(),a=`${t}:${n}`;if("firestore.googleapis.com"!==i.host&&i.host!==a&&y("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},i),{host:a,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=l.MOCK_USER;else{t=(0,o.Fy)(r.mockUserToken,null===(s=e._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new E(T.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new l(i)}e._authCredentials=new C(new x(t,n))}}class Kc{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Kc(this.firestore,e,this._query)}}class Gc{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new $c(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Gc(this.firestore,e,this._key)}}class $c extends Kc{constructor(e,t,n){super(e,t,Fn(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Gc(this.firestore,null,new Q(e))}withConverter(e){return new $c(this.firestore,e,this._path)}}function Qc(e,t,...n){if(e=(0,o.Ku)(e),Fc("collection","path",t),e instanceof Bc){const r=K.fromString(t,...n);return Oc(r),new $c(e,null,r)}{if(!(e instanceof Gc||e instanceof $c))throw new E(T.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(K.fromString(t,...n));return Oc(r),new $c(e.firestore,null,r)}}function jc(e,t){if(e=Pc(e,Bc),Fc("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new E(T.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Kc(e,null,function(e){return new kn(K.emptyPath(),e)}(t))}function Wc(e,t,...n){if(e=(0,o.Ku)(e),1===arguments.length&&(t=O.newId()),Fc("doc","path",t),e instanceof Bc){const r=K.fromString(t,...n);return Mc(r),new Gc(e,null,new Q(r))}{if(!(e instanceof Gc||e instanceof $c))throw new E(T.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(K.fromString(t,...n));return Mc(r),new Gc(e.firestore,e instanceof $c?e.converter:null,new Q(r))}}function Jc(e,t){return e=(0,o.Ku)(e),t=(0,o.Ku)(t),(e instanceof Gc||e instanceof $c)&&(t instanceof Gc||t instanceof $c)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Hc(e,t){return e=(0,o.Ku)(e),t=(0,o.Ku)(t),e instanceof Kc&&t instanceof Kc&&e.firestore===t.firestore&&zn(e._query,t._query)&&e.converter===t.converter}class Yc{constructor(e=Promise.resolve()){this.Pu=[],this.Iu=!1,this.Tu=[],this.Eu=null,this.du=!1,this.Au=!1,this.Ru=[],this.t_=new Ta(this,"async_queue_retry"),this.Vu=()=>{const e=Ia();e&&g("AsyncQueue","Visibility state changed to "+e.visibilityState),this.t_.jo()},this.mu=e;const t=Ia();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Vu)}get isShuttingDown(){return this.Iu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.fu(),this.gu(e)}enterRestrictedMode(e){if(!this.Iu){this.Iu=!0,this.Au=e||!1;const t=Ia();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Vu)}}enqueue(e){if(this.fu(),this.Iu)return new Promise((()=>{}));const t=new S;return this.gu((()=>this.Iu&&this.Au?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.Pu.push(e),this.pu())))}async pu(){if(0!==this.Pu.length){try{await this.Pu[0](),this.Pu.shift(),this.t_.reset()}catch(e){if(!fe(e))throw e;g("AsyncQueue","Operation failed with retryable error: "+e)}this.Pu.length>0&&this.t_.Go((()=>this.pu()))}}gu(e){const t=this.mu.then((()=>(this.du=!0,e().catch((e=>{this.Eu=e,this.du=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw p("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.du=!1,e))))));return this.mu=t,t}enqueueAfterDelay(e,t,n){this.fu(),this.Ru.indexOf(e)>-1&&(t=0);const r=iu.createAndSchedule(this,e,t,n,(e=>this.yu(e)));return this.Tu.push(r),r}fu(){this.Eu&&v()}verifyOperationInProgress(){}async wu(){let e;do{e=this.mu,await e}while(e!==this.mu)}Su(e){for(const t of this.Tu)if(t.timerId===e)return!0;return!1}bu(e){return this.wu().then((()=>{this.Tu.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.Tu)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.wu()}))}Du(e){this.Ru.push(e)}yu(e){const t=this.Tu.indexOf(e);this.Tu.splice(t,1)}}function Xc(e){return function(e){if("object"!=typeof e||null===e)return!1;const t=e;for(const e of["next","error","complete"])if(e in t&&"function"==typeof t[e])return!0;return!1}(e)}class Zc{constructor(){this._progressObserver={},this._taskCompletionResolver=new S,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}const el=-1;class tl extends Bc{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Yc,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const e=this._firestoreClient.terminate();this._queue=new Yc(e),this._firestoreClient=void 0,await e}}}function nl(e,t,n){n||(n="(default)");const s=(0,r.j6)(e,"firestore");if(s.isInitialized(n)){const e=s.getImmediate({identifier:n}),r=s.getOptions(n);if((0,o.bD)(r,t))return e;throw new E(T.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==t.cacheSizeBytes&&void 0!==t.localCache)throw new E(T.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==t.cacheSizeBytes&&-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new E(T.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return s.initialize({options:t,instanceIdentifier:n})}function rl(e,t){const n="object"==typeof e?e:(0,r.Sx)(),s="string"==typeof e?e:t||"(default)",i=(0,r.j6)(n,"firestore").getImmediate({identifier:s});if(!i._initialized){const e=(0,o.yU)("firestore");e&&zc(i,...e)}return i}function sl(e){if(e._terminated)throw new E(T.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||il(e),e._firestoreClient}function il(e){var t,n,r;const s=e._freezeSettings(),i=function(e,t,n,r){return new bt(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,kc(r.experimentalLongPollingOptions),r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,s);e._componentsProvider||(null===(n=s.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=s.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(e._componentsProvider={_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider}),e._firestoreClient=new wc(e._authCredentials,e._appCheckCredentials,e._queue,i,e._componentsProvider&&function(e){const t=null==e?void 0:e._online.build();return{_offline:null==e?void 0:e._offline.build(t),_online:t}}(e._componentsProvider))}function ol(e,t){y("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=e._freezeSettings();return ul(e,dc.provider,{build:e=>new lc(e,n.cacheSizeBytes,null==t?void 0:t.forceOwnership)}),Promise.resolve()}async function al(e){y("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const t=e._freezeSettings();ul(e,dc.provider,{build:e=>new hc(e,t.cacheSizeBytes)})}function ul(e,t,n){if((e=Pc(e,tl))._firestoreClient||e._terminated)throw new E(T.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(e._componentsProvider||e._getSettings().localCache)throw new E(T.FAILED_PRECONDITION,"SDK cache is already specified.");e._componentsProvider={_online:t,_offline:n},il(e)}function cl(e){if(e._initialized&&!e._terminated)throw new E(T.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new S;return e._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(e){if(!ce.D())return Promise.resolve();const t=e+"main";await ce.delete(t)}(qo(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function ll(e){return function(e){const t=new S;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=b(e);Pa(n.remoteStore)||g("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=b(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e)))}(n.localStore);if(-1===e)return void t.resolve();const r=n.ka.get(e)||[];r.push(t),n.ka.set(e,r)}catch(e){const n=ou(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await xc(e),t))),t.promise}(sl(e=Pc(e,tl)))}function hl(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await Tc(e),n=await Sc(e);return t.setNetworkEnabled(!0),function(e){const t=b(e);return t.L_.delete(0),Aa(t)}(n)}))}(sl(e=Pc(e,tl)))}function dl(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await Tc(e),n=await Sc(e);return t.setNetworkEnabled(!1),async function(e){const t=b(e);t.L_.add(0),await ka(t),t.q_.set("Offline")}(n)}))}(sl(e=Pc(e,tl)))}function fl(e){return(0,r.Us)(e.app,"firestore",e._databaseId.database),e._delete()}function ml(e,t){const n=sl(e=Pc(e,tl)),r=new Zc;return function(e,t,n,r){const s=function(e,t){let n;return n="string"==typeof e?Yr().encode(e):e,function(e,t){return new gc(e,t)}(function(e,t){if(e instanceof Uint8Array)return fc(e,t);if(e instanceof ArrayBuffer)return fc(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,ba(t));e.asyncQueue.enqueueAndForget((async()=>{!function(e,t,n){const r=b(e);(async function(e,t,n){try{const r=await t.getMetadata();if(await function(e,t){const n=b(e),r=_s(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(e=>n.Gr.getBundleMetadata(e,t.id))).then((e=>!!e&&e.createTime.compareTo(r)>=0))}(e.localStore,r))return await t.close(),n._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(Eu(r));const s=new Tu(r,e.localStore,t.serializer);let i=await t.Ua();for(;i;){const e=await s.la(i);e&&n._updateProgress(e),i=await t.Ua()}const o=await s.complete();return await Ju(e,o.Ia,void 0),await function(e,t){const n=b(e);return n.persistence.runTransaction("Save bundle","readwrite",(e=>n.Gr.saveBundleMetadata(e,t)))}(e.localStore,r),n._completeWith(o.progress),Promise.resolve(o.Pa)}catch(e){return y("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then((e=>{r.sharedClientState.notifyBundleLoaded(e)}))}(await xc(e),s,r)}))}(n,e._databaseId,t,r),r}function gl(e,t){return function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){const n=b(e);return n.persistence.runTransaction("Get named query","readonly",(e=>n.Gr.getNamedQuery(e,t)))}(await Ec(e),t)))}(sl(e=Pc(e,tl)),t).then((t=>t?new Kc(e,null,t.query):null))}class pl{constructor(e="count",t){this._internalFieldPath=t,this.type="AggregateField",this.aggregateType=e}}class yl{constructor(e,t,n){this._userDataWriter=t,this._data=n,this.type="AggregateQuerySnapshot",this.query=e}data(){return this._userDataWriter.convertObjectMap(this._data)}}class wl{constructor(e){this._byteString=e}static fromBase64String(e){try{return new wl(mt.fromBase64String(e))}catch(e){throw new E(T.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new wl(mt.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class vl{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new E(T.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new $(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}function _l(){return new vl("__name__")}class Il{constructor(e){this._methodName=e}}class bl{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new E(T.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new E(T.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return L(this._lat,e._lat)||L(this._long,e._long)}}class Tl{constructor(e){this._values=(e||[]).map((e=>e))}toArray(){return this._values.map((e=>e))}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}}const El=/^__.*__$/;class Sl{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new Mr(e,this.data,this.fieldMask,t,this.fieldTransforms):new Vr(e,this.data,t,this.fieldTransforms)}}class xl{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new Mr(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Dl(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw v()}}class Cl{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.vu(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Cu(){return this.settings.Cu}Fu(e){return new Cl(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Mu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Fu({path:n,xu:!1});return r.Ou(e),r}Nu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Fu({path:n,xu:!1});return r.vu(),r}Lu(e){return this.Fu({path:void 0,xu:!0})}Bu(e){return Wl(e,this.settings.methodName,this.settings.ku||!1,this.path,this.settings.qu)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}vu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Ou(this.path.get(e))}Ou(e){if(0===e.length)throw this.Bu("Document fields must not be empty");if(Dl(this.Cu)&&El.test(e))throw this.Bu('Document fields cannot begin and end with "__"')}}class Nl{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||ba(e)}Qu(e,t,n,r=!1){return new Cl({Cu:e,methodName:t,qu:n,path:$.emptyPath(),xu:!1,ku:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Al(e){const t=e._freezeSettings(),n=ba(e._databaseId);return new Nl(e._databaseId,!!t.ignoreUndefinedProperties,n)}function kl(e,t,n,r,s,i={}){const o=e.Qu(i.merge||i.mergeFields?2:0,t,n,s);Gl("Data must be an object, but it was:",o,r);const a=zl(r,o);let u,c;if(i.merge)u=new ht(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=$l(t,r,n);if(!o.contains(s))throw new E(T.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Jl(e,s)||e.push(s)}u=new ht(e),c=o.fieldTransforms.filter((e=>u.covers(e.field)))}else u=null,c=o.fieldTransforms;return new Sl(new Jt(a),u,c)}class Rl extends Il{_toFieldTransform(e){if(2!==e.Cu)throw 1===e.Cu?e.Bu(`${this._methodName}() can only appear at the top level of your update data`):e.Bu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof Rl}}function Fl(e,t,n){return new Cl({Cu:3,qu:t.settings.qu,methodName:e._methodName,xu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class Vl extends Il{_toFieldTransform(e){return new Er(e.path,new pr)}isEqual(e){return e instanceof Vl}}class Ml extends Il{constructor(e,t){super(e),this.Ku=t}_toFieldTransform(e){const t=Fl(this,e,!0),n=this.Ku.map((e=>Bl(e,t))),r=new yr(n);return new Er(e.path,r)}isEqual(e){return e instanceof Ml&&(0,o.bD)(this.Ku,e.Ku)}}class Ol extends Il{constructor(e,t){super(e),this.Ku=t}_toFieldTransform(e){const t=Fl(this,e,!0),n=this.Ku.map((e=>Bl(e,t))),r=new vr(n);return new Er(e.path,r)}isEqual(e){return e instanceof Ol&&(0,o.bD)(this.Ku,e.Ku)}}class Ll extends Il{constructor(e,t){super(e),this.$u=t}_toFieldTransform(e){const t=new Ir(e.serializer,hr(e.serializer,this.$u));return new Er(e.path,t)}isEqual(e){return e instanceof Ll&&this.$u===e.$u}}function Pl(e,t,n,r){const s=e.Qu(1,t,n);Gl("Data must be an object, but it was:",s,r);const i=[],a=Jt.empty();nt(r,((e,r)=>{const u=jl(t,e,n);r=(0,o.Ku)(r);const c=s.Nu(u);if(r instanceof Rl)i.push(u);else{const e=Bl(r,c);null!=e&&(i.push(u),a.set(u,e))}}));const u=new ht(i);return new xl(a,u,s.fieldTransforms)}function ql(e,t,n,r,s,i){const a=e.Qu(1,t,n),u=[$l(t,r,n)],c=[s];if(i.length%2!=0)throw new E(T.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<i.length;e+=2)u.push($l(t,i[e])),c.push(i[e+1]);const l=[],h=Jt.empty();for(let e=u.length-1;e>=0;--e)if(!Jl(l,u[e])){const t=u[e];let n=c[e];n=(0,o.Ku)(n);const r=a.Nu(t);if(n instanceof Rl)l.push(t);else{const e=Bl(n,r);null!=e&&(l.push(t),h.set(t,e))}}const d=new ht(l);return new xl(h,d,a.fieldTransforms)}function Ul(e,t,n,r=!1){return Bl(n,e.Qu(r?4:3,t))}function Bl(e,t){if(Kl(e=(0,o.Ku)(e)))return Gl("Unsupported field value:",t,e),zl(e,t);if(e instanceof Il)return function(e,t){if(!Dl(t.Cu))throw t.Bu(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Bu(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.xu&&4!==t.Cu)throw t.Bu("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const s of e){let e=Bl(s,t.Lu(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=(0,o.Ku)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return hr(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=U.fromDate(e);return{timestampValue:ys(t.serializer,n)}}if(e instanceof U){const n=new U(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:ys(t.serializer,n)}}if(e instanceof bl)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof wl)return{bytesValue:ws(t.serializer,e._byteString)};if(e instanceof Gc){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Bu(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:Is(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof Tl)return function(e,t){return{mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{values:e.toArray().map((e=>{if("number"!=typeof e)throw t.Bu("VectorValues must only contain numeric values.");return cr(t.serializer,e)}))}}}}}}(e,t);throw t.Bu(`Unsupported field value: ${Lc(e)}`)}(e,t)}function zl(e,t){const n={};return st(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):nt(e,((e,r)=>{const s=Bl(r,t.Mu(e));null!=s&&(n[e]=s)})),{mapValue:{fields:n}}}function Kl(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof U||e instanceof bl||e instanceof wl||e instanceof Gc||e instanceof Il||e instanceof Tl)}function Gl(e,t,n){if(!Kl(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=Lc(n);throw"an object"===r?t.Bu(e+" a custom object"):t.Bu(e+" "+r)}}function $l(e,t,n){if((t=(0,o.Ku)(t))instanceof vl)return t._internalPath;if("string"==typeof t)return jl(e,t);throw Wl("Field path arguments must be of type string or ",e,!1,void 0,n)}const Ql=new RegExp("[~\\*/\\[\\]]");function jl(e,t,n){if(t.search(Ql)>=0)throw Wl(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new vl(...t.split("."))._internalPath}catch(r){throw Wl(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function Wl(e,t,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${r}`),o&&(u+=` in document ${s}`),u+=")"),new E(T.INVALID_ARGUMENT,a+e+u)}function Jl(e,t){return e.some((e=>e.isEqual(t)))}class Hl{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Gc(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new Yl(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(Xl("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Yl extends Hl{data(){return super.data()}}function Xl(e,t){return"string"==typeof t?jl(e,t):t instanceof vl?t._internalPath:t._delegate._internalPath}function Zl(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new E(T.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class eh{}class th extends eh{}function nh(e,t,...n){let r=[];t instanceof eh&&r.push(t),r=r.concat(n),function(e){const t=e.filter((e=>e instanceof ih)).length,n=e.filter((e=>e instanceof rh)).length;if(t>1||t>0&&n>0)throw new E(T.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e}class rh extends th{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new rh(e,t,n)}_apply(e){const t=this._parse(e);return bh(e._query,t),new Kc(e.firestore,e.converter,Un(e._query,t))}_parse(e){const t=Al(e.firestore),n=function(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new E(T.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Ih(o,i);const t=[];for(const n of o)t.push(_h(r,e,n));a={arrayValue:{values:t}}}else a=_h(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Ih(o,i),a=Ul(n,"where",o,"in"===i||"not-in"===i);return sn.create(s,i,a)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value);return n}}function sh(e,t,n){const r=t,s=Xl("where",e);return rh._create(s,r,n)}class ih extends eh{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new ih(e,t)}_parse(e){const t=this._queryConstraints.map((t=>t._parse(e))).filter((e=>e.getFilters().length>0));return 1===t.length?t[0]:on.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;const r=t.getFlattenedFilters();for(const e of r)bh(n,e),n=Un(n,e)}(e._query,t),new Kc(e.firestore,e.converter,Un(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}function oh(...e){return e.forEach((e=>Th("or",e))),ih._create("or",e)}function ah(...e){return e.forEach((e=>Th("and",e))),ih._create("and",e)}class uh extends th{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new uh(e,t)}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new E(T.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new E(T.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new tn(t,n)}(e._query,this._field,this._direction);return new Kc(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new kn(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function ch(e,t="asc"){const n=t,r=Xl("orderBy",e);return uh._create(r,n)}class lh extends th{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new lh(e,t,n)}_apply(e){return new Kc(e.firestore,e.converter,Bn(e._query,this._limit,this._limitType))}}function hh(e){return qc("limit",e),lh._create("limit",e,"F")}function dh(e){return qc("limitToLast",e),lh._create("limitToLast",e,"L")}class fh extends th{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new fh(e,t,n)}_apply(e){const t=vh(e,this.type,this._docOrFields,this._inclusive);return new Kc(e.firestore,e.converter,function(e,t){return new kn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}function mh(...e){return fh._create("startAt",e,!0)}function gh(...e){return fh._create("startAfter",e,!1)}class ph extends th{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new ph(e,t,n)}_apply(e){const t=vh(e,this.type,this._docOrFields,this._inclusive);return new Kc(e.firestore,e.converter,function(e,t){return new kn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function yh(...e){return ph._create("endBefore",e,!1)}function wh(...e){return ph._create("endAt",e,!0)}function vh(e,t,n,r){if(n[0]=(0,o.Ku)(n[0]),n[0]instanceof Hl)return function(e,t,n,r,s){if(!r)throw new E(T.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of On(e))if(n.field.isKeyField())i.push(Mt(t,r.key));else{const e=r.data.field(n.field);if(vt(e))throw new E(T.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new E(T.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new Xt(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{const s=Al(e.firestore);return function(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new E(T.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<s.length;i++){const u=s[i];if(o[i].field.isKeyField()){if("string"!=typeof u)throw new E(T.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof u}`);if(!Mn(e)&&-1!==u.indexOf("/"))throw new E(T.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${u}' contains a slash.`);const n=e.path.child(K.fromString(u));if(!Q.isDocumentKey(n))throw new E(T.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new Q(n);a.push(Mt(t,s))}else{const e=Ul(n,r,u);a.push(e)}}return new Xt(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}}function _h(e,t,n){if("string"==typeof(n=(0,o.Ku)(n))){if(""===n)throw new E(T.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Mn(t)&&-1!==n.indexOf("/"))throw new E(T.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(K.fromString(n));if(!Q.isDocumentKey(r))throw new E(T.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Mt(e,new Q(r))}if(n instanceof Gc)return Mt(e,n._key);throw new E(T.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Lc(n)}.`)}function Ih(e,t){if(!Array.isArray(e)||0===e.length)throw new E(T.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function bh(e,t){const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new E(T.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new E(T.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function Th(e,t){if(!(t instanceof rh||t instanceof ih))throw new E(T.INVALID_ARGUMENT,`Function ${e}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class Eh{convertValue(e,t="none"){switch(xt(e)){case 0:return null;case 1:return e.booleanValue;case 2:return yt(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(wt(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw v()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return nt(e,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertVectorValue(e){var t,n,r;const s=null===(r=null===(n=null===(t=e.fields)||void 0===t?void 0:t.value.arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.map((e=>yt(e.doubleValue)));return new Tl(s)}convertGeoPoint(e){return new bl(yt(e.latitude),yt(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=_t(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(It(e));default:return null}}convertTimestamp(e){const t=pt(e);return new U(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=K.fromString(e);_(Qs(n));const r=new Tt(n.get(1),n.get(3)),s=new Q(n.popFirst(5));return r.isEqual(t)||p(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function Sh(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class xh extends Eh{constructor(e){super(),this.firestore=e}convertBytes(e){return new wl(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Gc(this.firestore,null,t)}}function Dh(e){return new pl("sum",$l("sum",e))}function Ch(e){return new pl("avg",$l("average",e))}function Nh(){return new pl("count")}function Ah(e,t){var n,r;return e instanceof pl&&t instanceof pl&&e.aggregateType===t.aggregateType&&(null===(n=e._internalFieldPath)||void 0===n?void 0:n.canonicalString())===(null===(r=t._internalFieldPath)||void 0===r?void 0:r.canonicalString())}function kh(e,t){return Hc(e.query,t.query)&&(0,o.bD)(e.data(),t.data())}class Rh{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Fh extends Hl{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new Vh(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(Xl("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Vh extends Fh{data(e={}){return super.data(e)}}class Mh{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Rh(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new Vh(this._firestore,this._userDataWriter,n.key,n,new Rh(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new E(T.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>{const r=new Vh(e._firestore,e._userDataWriter,n.doc.key,n.doc,new Rh(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}}))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const r=new Vh(e._firestore,e._userDataWriter,t.doc.key,t.doc,new Rh(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let s=-1,i=-1;return 0!==t.type&&(s=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:Oh(t.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Oh(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return v()}}function Lh(e,t){return e instanceof Fh&&t instanceof Fh?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Mh&&t instanceof Mh&&e._firestore===t._firestore&&Hc(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function Ph(e){e=Pc(e,Gc);const t=Pc(e.firestore,tl);return Nc(sl(t),e._key).then((n=>Xh(t,e,n)))}class qh extends Eh{constructor(e){super(),this.firestore=e}convertBytes(e){return new wl(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Gc(this.firestore,null,t)}}function Uh(e){e=Pc(e,Gc);const t=Pc(e.firestore,tl),n=sl(t),r=new qh(t);return function(e,t){const n=new S;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await function(e,t){const n=b(e);return n.persistence.runTransaction("read document","readonly",(e=>n.localDocuments.getDocument(e,t)))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new E(T.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){const r=ou(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await Ec(e),t,n))),n.promise}(n,e._key).then((n=>new Fh(t,r,e._key,n,new Rh(null!==n&&n.hasLocalMutations,!0),e.converter)))}function Bh(e){e=Pc(e,Gc);const t=Pc(e.firestore,tl);return Nc(sl(t),e._key,{source:"server"}).then((n=>Xh(t,e,n)))}function zh(e){e=Pc(e,Kc);const t=Pc(e.firestore,tl),n=sl(t),r=new qh(t);return Zl(e._query),Ac(n,e._query).then((n=>new Mh(t,r,e,n)))}function Kh(e){e=Pc(e,Kc);const t=Pc(e.firestore,tl),n=sl(t),r=new qh(t);return function(e,t){const n=new S;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await Yo(e,t,!0),s=new Du(t,r.Ts),i=s.ma(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){const r=ou(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await Ec(e),t,n))),n.promise}(n,e._query).then((n=>new Mh(t,r,e,n)))}function Gh(e){e=Pc(e,Kc);const t=Pc(e.firestore,tl),n=sl(t),r=new qh(t);return Ac(n,e._query,{source:"server"}).then((n=>new Mh(t,r,e,n)))}function $h(e,t,n){e=Pc(e,Gc);const r=Pc(e.firestore,tl),s=Sh(e.converter,t,n);return Yh(r,[kl(Al(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,xr.none())])}function Qh(e,t,n,...r){e=Pc(e,Gc);const s=Pc(e.firestore,tl),i=Al(s);let a;return a="string"==typeof(t=(0,o.Ku)(t))||t instanceof vl?ql(i,"updateDoc",e._key,t,n,r):Pl(i,"updateDoc",e._key,t),Yh(s,[a.toMutation(e._key,xr.exists(!0))])}function jh(e){return Yh(Pc(e.firestore,tl),[new qr(e._key,xr.none())])}function Wh(e,t){const n=Pc(e.firestore,tl),r=Wc(e),s=Sh(e.converter,t);return Yh(n,[kl(Al(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,xr.exists(!1))]).then((()=>r))}function Jh(e,...t){var n,r,s;e=(0,o.Ku)(e);let i={includeMetadataChanges:!1,source:"default"},a=0;"object"!=typeof t[a]||Xc(t[a])||(i=t[a],a++);const u={includeMetadataChanges:i.includeMetadataChanges,source:i.source};if(Xc(t[a])){const e=t[a];t[a]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[a+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[a+2]=null===(s=e.complete)||void 0===s?void 0:s.bind(e)}let c,l,h;if(e instanceof Gc)l=Pc(e.firestore,tl),h=Fn(e._key.path),c={next:n=>{t[a]&&t[a](Xh(l,e,n))},error:t[a+1],complete:t[a+2]};else{const n=Pc(e,Kc);l=Pc(n.firestore,tl),h=n._query;const r=new qh(l);c={next:e=>{t[a]&&t[a](new Mh(l,r,n,e))},error:t[a+1],complete:t[a+2]},Zl(e._query)}return function(e,t,n,r){const s=new mc(r),i=new _u(t,s,n);return e.asyncQueue.enqueueAndForget((async()=>fu(await Cc(e),i))),()=>{s.Za(),e.asyncQueue.enqueueAndForget((async()=>mu(await Cc(e),i)))}}(sl(l),h,u,c)}function Hh(e,t){return function(e,t){const n=new mc(t);return e.asyncQueue.enqueueAndForget((async()=>function(e,t){b(e).Y_.add(t),t.next()}(await Cc(e),n))),()=>{n.Za(),e.asyncQueue.enqueueAndForget((async()=>function(e,t){b(e).Y_.delete(t)}(await Cc(e),n)))}}(sl(e=Pc(e,tl)),Xc(t)?t:{next:t})}function Yh(e,t){return function(e,t){const n=new S;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=ac(e);try{const e=await function(e,t){const n=b(e),r=U.now(),s=t.reduce(((e,t)=>e.add(t.key)),or());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let a=Yn(),u=or();return n.cs.getEntries(e,s).next((e=>{a=e,a.forEach(((e,t)=>{t.isValidDocument()||(u=u.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,a))).next((s=>{i=s;const o=[];for(const e of t){const t=Rr(e,i.get(e.key).overlayedDocument);null!=t&&o.push(new Mr(e.key,t,Ht(t.value.mapValue),xr.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)})).next((t=>{o=t;const r=t.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:er(i)})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.Ba[e.currentUser.toKey()];r||(r=new it(L)),r=r.insert(t,n),e.Ba[e.currentUser.toKey()]=r}(r,e.batchId,n),await Ju(r,e.changes),await Qa(r.remoteStore)}catch(e){const t=ou(e,"Failed to persist write");n.reject(t)}}(await xc(e),t,n))),n.promise}(sl(e),t)}function Xh(e,t,n){const r=n.docs.get(t._key),s=new qh(e);return new Fh(e,s,t._key,r,new Rh(n.hasPendingWrites,n.fromCache),t.converter)}function Zh(e){return ed(e,{count:Nh()})}function ed(e,t){const n=Pc(e.firestore,tl),r=sl(n),s=rt(t,((e,t)=>new Gr(t,e.aggregateType,e._internalFieldPath)));return function(e,t,n){const r=new S;return e.asyncQueue.enqueueAndForget((async()=>{try{const s=await Dc(e);r.resolve(async function(e,t,n){var r;const s=b(e),{request:i,ut:o,parent:a}=Os(s.serializer,Pn(t),n);s.connection.Fo||delete i.parent;const u=(await s.Lo("RunAggregationQuery",s.serializer.databaseId,a,i,1)).filter((e=>!!e.result));_(1===u.length);const c=null===(r=u[0].result)||void 0===r?void 0:r.aggregateFields;return Object.keys(c).reduce(((e,t)=>(e[o[t]]=c[t],e)),{})}(s,t,n))}catch(e){r.reject(e)}})),r.promise}(r,e._query,s).then((t=>function(e,t,n){const r=new qh(e);return new yl(t,r,n)}(n,e,t)))}class td{constructor(e){this.kind="memory",this._onlineComponentProvider=dc.provider,(null==e?void 0:e.garbageCollector)?this._offlineComponentProvider=e.garbageCollector._offlineComponentProvider:this._offlineComponentProvider=uc.provider}toJSON(){return{kind:this.kind}}}class nd{constructor(e){let t;this.kind="persistent",(null==e?void 0:e.tabManager)?(e.tabManager._initialize(e),t=e.tabManager):(t=hd(void 0),t._initialize(e)),this._onlineComponentProvider=t._onlineComponentProvider,this._offlineComponentProvider=t._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class rd{constructor(){this.kind="memoryEager",this._offlineComponentProvider=uc.provider}toJSON(){return{kind:this.kind}}}class sd{constructor(e){this.kind="memoryLru",this._offlineComponentProvider={build:()=>new cc(e)}}toJSON(){return{kind:this.kind}}}function id(){return new rd}function od(e){return new sd(null==e?void 0:e.cacheSizeBytes)}function ad(e){return new td(e)}function ud(e){return new nd(e)}class cd{constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=dc.provider,this._offlineComponentProvider={build:t=>new lc(t,null==e?void 0:e.cacheSizeBytes,this.forceOwnership)}}}class ld{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=dc.provider,this._offlineComponentProvider={build:t=>new hc(t,null==e?void 0:e.cacheSizeBytes)}}}function hd(e){return new cd(null==e?void 0:e.forceOwnership)}function dd(){return new ld}const fd={maxAttempts:5};class md{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Al(e)}set(e,t,n){this._verifyNotCommitted();const r=gd(e,this._firestore),s=Sh(r.converter,t,n),i=kl(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,xr.none())),this}update(e,t,n,...r){this._verifyNotCommitted();const s=gd(e,this._firestore);let i;return i="string"==typeof(t=(0,o.Ku)(t))||t instanceof vl?ql(this._dataReader,"WriteBatch.update",s._key,t,n,r):Pl(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,xr.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=gd(e,this._firestore);return this._mutations=this._mutations.concat(new qr(t._key,xr.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new E(T.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function gd(e,t){if((e=(0,o.Ku)(e)).firestore!==t)throw new E(T.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class pd extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=Al(e)}get(e){const t=gd(e,this._firestore),n=new xh(this._firestore);return this._transaction.lookup([t._key]).then((e=>{if(!e||1!==e.length)return v();const r=e[0];if(r.isFoundDocument())return new Hl(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new Hl(this._firestore,n,t._key,null,t.converter);throw v()}))}set(e,t,n){const r=gd(e,this._firestore),s=Sh(r.converter,t,n),i=kl(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){const s=gd(e,this._firestore);let i;return i="string"==typeof(t=(0,o.Ku)(t))||t instanceof vl?ql(this._dataReader,"Transaction.update",s._key,t,n,r):Pl(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){const t=gd(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=gd(e,this._firestore),n=new qh(this._firestore);return super.get(e).then((e=>new Fh(this._firestore,n,t._key,e._document,new Rh(!1,!1),t.converter)))}}function yd(e,t,n){e=Pc(e,tl);const r=Object.assign(Object.assign({},fd),n);return function(e){if(e.maxAttempts<1)throw new E(T.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(e,t,n){const r=new S;return e.asyncQueue.enqueueAndForget((async()=>{const s=await Dc(e);new yc(e.asyncQueue,s,n,t,r).au()})),r.promise}(sl(e),(n=>t(new pd(e,n))),r)}function wd(){return new Rl("deleteField")}function vd(){return new Vl("serverTimestamp")}function _d(...e){return new Ml("arrayUnion",e)}function Id(...e){return new Ol("arrayRemove",e)}function bd(e){return new Ll("increment",e)}function Td(e){return new Tl(e)}function Ed(e){return sl(e=Pc(e,tl)),new md(e,(t=>Yh(e,t)))}function Sd(e,t){const n=sl(e=Pc(e,tl));if(!n._uninitializedComponentsProvider||"memory"===n._uninitializedComponentsProvider._offline.kind)return y("Cannot enable indexes when persistence is disabled"),Promise.resolve();const r=function(e){const t="string"==typeof e?function(e){try{return JSON.parse(e)}catch(e){throw new E(T.INVALID_ARGUMENT,"Failed to parse JSON: "+(null==e?void 0:e.message))}}(e):e,n=[];if(Array.isArray(t.indexes))for(const e of t.indexes){const t=xd(e,"collectionGroup"),r=[];if(Array.isArray(e.fields))for(const t of e.fields){const e=jl("setIndexConfiguration",xd(t,"fieldPath"));"CONTAINS"===t.arrayConfig?r.push(new Y(e,2)):"ASCENDING"===t.order?r.push(new Y(e,0)):"DESCENDING"===t.order&&r.push(new Y(e,1))}n.push(new j(j.UNKNOWN_ID,t,r,Z.empty()))}return n}(t);return function(e,t){return e.asyncQueue.enqueue((async()=>async function(e,t){const n=b(e),r=n.indexManager,s=[];return n.persistence.runTransaction("Configure indexes","readwrite",(e=>r.getFieldIndexes(e).next((n=>function(e,t,n,r,s){e=[...e],t=[...t],e.sort(n),t.sort(n);const i=e.length,o=t.length;let a=0,u=0;for(;a<o&&u<i;){const i=n(e[u],t[a]);i<0?s(e[u++]):i>0?r(t[a++]):(a++,u++)}for(;a<o;)r(t[a++]);for(;u<i;)s(e[u++])}(n,t,H,(t=>{s.push(r.addFieldIndex(e,t))}),(t=>{s.push(r.deleteFieldIndex(e,t))})))).next((()=>ae.waitFor(s)))))}(await Ec(e),t)))}(n,r)}function xd(e,t){if("string"!=typeof e[t])throw new E(T.INVALID_ARGUMENT,"Missing string value for: "+t);return e[t]}class Dd{constructor(e){this._firestore=e,this.type="PersistentCacheIndexManager"}}function Cd(e){var t;e=Pc(e,tl);const n=Fd.get(e);if(n)return n;if("persistent"!==(null===(t=sl(e)._uninitializedComponentsProvider)||void 0===t?void 0:t._offline.kind))return null;const r=new Dd(e);return Fd.set(e,r),r}function Nd(e){Rd(e,!0)}function Ad(e){Rd(e,!1)}function kd(e){(function(e){return e.asyncQueue.enqueue((async()=>function(e){const t=b(e),n=t.indexManager;return t.persistence.runTransaction("Delete All Indexes","readwrite",(e=>n.deleteAllFieldIndexes(e)))}(await Ec(e))))})(sl(e._firestore)).then((e=>g("deleting all persistent cache indexes succeeded"))).catch((e=>y("deleting all persistent cache indexes failed",e)))}function Rd(e,t){(function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){b(e).ss.zi=t}(await Ec(e),t)))})(sl(e._firestore),t).then((e=>g(`setting persistent cache index auto creation isEnabled=${t} succeeded`))).catch((e=>y(`setting persistent cache index auto creation isEnabled=${t} failed`,e)))}const Fd=new WeakMap;function Vd(e){var t;const n=null===(t=sl(Pc(e.firestore,tl))._onlineComponents)||void 0===t?void 0:t.datastore.serializer;return void 0===n?null:Ms(n,Ln(e._query))._t}function Md(e,t){var n;const r=rt(t,((e,t)=>new Gr(t,e.aggregateType,e._internalFieldPath))),s=null===(n=sl(Pc(e.firestore,tl))._onlineComponents)||void 0===n?void 0:n.datastore.serializer;return void 0===s?null:Os(s,Pn(e._query),r,!0).request}class Od{constructor(){throw new Error("instances of this class should not be created")}static onExistenceFilterMismatch(e){return Ld.instance.onExistenceFilterMismatch(e)}}class Ld{constructor(){this.Uu=new Map}static get instance(){return Pd||(Pd=new Ld,function(e){if(Hr)throw new Error("a TestingHooksSpi instance is already set");Hr=e}(Pd)),Pd}et(e){this.Uu.forEach((t=>t(e)))}onExistenceFilterMismatch(e){const t=Symbol(),n=this.Uu;return n.set(t,e),()=>n.delete(t)}}let Pd=null;!function(e,t=!0){!function(e){h=e}(r.MF),(0,r.om)(new s.uA("firestore",((e,{instanceIdentifier:n,options:r})=>{const s=e.getProvider("app").getImmediate(),i=new tl(new N(e.getProvider("auth-internal")),new F(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new E(T.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Tt(e.options.projectId,t)}(s,n),s);return r=Object.assign({useFetchStreams:t},r),i._setSettings(r),i}),"PUBLIC").setMultipleInstances(!0)),(0,r.KO)(c,"4.7.3",e),(0,r.KO)(c,"4.7.3","esm2017")}()}}]);