(()=>{document.getElementById("kills"),document.getElementById("deaths"),document.getElementById("matches"),document.getElementById("matches-list");const e=document.getElementById("statsBtn"),t=document.getElementById("hudBtn"),a=document.getElementById("statsSection"),s=document.getElementById("hudSection");a.classList.add("active"),e.addEventListener("click",(()=>{e.classList.add("selected"),t.classList.remove("selected"),a.style.display="block",s.style.display="none"})),t.addEventListener("click",(()=>{t.classList.add("selected"),e.classList.remove("selected"),a.style.display="none",s.style.display="block"})),document.getElementById("playerCardBtn").addEventListener("click",(()=>{chrome.tabs.create({url:"player-card.html"})})),document.getElementById("statsNumbersBtn").addEventListener("click",(()=>{chrome.tabs.create({url:"stats-numbers.html"})}));const n=document.getElementById("toggleDeathsHud"),o=document.getElementById("toggleKillStreakHud"),l=document.getElementById("toggleKdrHud");function i(e){return e?new Date(e).toLocaleString(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit",year:"2-digit",month:"2-digit",day:"2-digit"}):"-"}function r(e,t){return 0===t?e>0?e.toFixed(2):"0.00":(e/t).toFixed(2)}function c(e){const t=Math.floor(e/1e3),a=Math.floor(t/3600),s=Math.floor(t%3600/60),n=t%60;return a>0?`${a}h ${s}m ${n}s`:s>0?`${s}m ${n}s`:`${n}s`}n.addEventListener("change",(function(){const e=this.checked;chrome.storage.sync.set({deathsHudEnabled:e}),chrome.tabs.query({active:!0,currentWindow:!0},(t=>{chrome.tabs.sendMessage(t[0].id,{type:"toggle-deaths-hud",enabled:e})}))})),o.addEventListener("change",(function(){const e=this.checked;chrome.storage.sync.set({killStreakHudEnabled:e}),chrome.tabs.query({active:!0,currentWindow:!0},(t=>{chrome.tabs.sendMessage(t[0].id,{type:"toggle-killstreak-hud",enabled:e})}))})),l.addEventListener("change",(function(){const e=this.checked;chrome.storage.sync.set({kdrHudEnabled:e}),chrome.tabs.query({active:!0,currentWindow:!0},(t=>{chrome.tabs.sendMessage(t[0].id,{type:"toggle-kdr-hud",enabled:e})}))})),chrome.storage.sync.get(["deathsHudEnabled","killStreakHudEnabled","kdrHudEnabled"],(e=>{n.checked=!1!==e.deathsHudEnabled,o.checked=!1!==e.killStreakHudEnabled,l.checked=!1!==e.kdrHudEnabled,chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{type:"toggle-deaths-hud",enabled:n.checked}),chrome.tabs.sendMessage(e[0].id,{type:"toggle-killstreak-hud",enabled:o.checked}),chrome.tabs.sendMessage(e[0].id,{type:"toggle-kdr-hud",enabled:l.checked})}))}));let m="Default",d="normal",h="all",u={primaryStats:!1,secondaryStats:!1,averageStats:!1,streaks:!1,quickKills:!1};const p=document.getElementById("modeGraphicsBtn");function g(e,t,a){const s=a||d;return"all"===s?null:`${e}_${t}_${s}`}function y(){document.getElementById("normalModeBtn").classList.toggle("selected","normal"===d),document.getElementById("specialModeBtn").classList.toggle("selected","special"===d),document.getElementById("customModeBtn").classList.toggle("selected","custom"===d),document.getElementById("allStatsBtn").classList.toggle("selected","all"===d),document.getElementById("primaryStatsHeader").textContent="all"===d?"All Modes Primary Stats":"Primary Stats",document.getElementById("secondaryStatsHeader").textContent="all"===d?"All Modes Secondary Stats":"Secondary Stats",function(){let e="",t="";switch(d){case"normal":e="3 Minute Mode Graphics",t="3min-mode.html";break;case"special":e="Special Mode Graphics",t="special-mode.html";break;case"custom":e="Custom Match Graphics",t="custom-mode.html";break;case"all":e="All Stats Graphics",t="visualizers.html";break;default:e="Graphics",t=""}p.textContent=e,p.dataset.targetUrl=t}()}function S(){chrome.storage.sync.get(["currentSkid"],(e=>{m=e.currentSkid||"Default",document.getElementById("skidValue").textContent=m;const t=["currentSkid"],a=["normal","special","custom"];t.push(`favoriteMatches_${m}`),"all"===d?a.forEach((e=>{t.push(g("matchHistory",m,e)),t.push(g("gamesJoined",m,e)),t.push(g("gamesStarted",m,e)),t.push(g("gamesQuit",m,e)),t.push(g("matchesCompleted",m,e))})):(t.push(g("matchHistory",m,d)),t.push(g("gamesJoined",m,d)),t.push(g("gamesStarted",m,d)),t.push(g("gamesQuit",m,d)),t.push(g("matchesCompleted",m,d))),console.log("[SKMT][LOAD] Loading stats for SKID:",m,"Mode:",d,"Keys:",t),chrome.storage.sync.get(t,(e=>{console.log("[SKMT][LOAD] Data returned from chrome.storage.sync:",e),L=e[`favoriteMatches_${m}`]||{},console.log("[SKMT][POPUP] Loaded favorite matches:",L),("all"===d?a:[d]).forEach((t=>{const a=g("matchHistory",m,t);e[a]&&e[a].forEach((e=>{e.favorite=!0===L[e.matchStartTime]}))})),document.querySelector(".match-history").style.display="block",function(e,t){let a=[],s=new Map;"all"===t?["normal","special","custom"].forEach((t=>{const n=e[g("matchHistory",m,t)]||[];a=a.concat(n),n.forEach((e=>{if(e.map){const t=s.get(e.map)||0;s.set(e.map,t+1)}}))})):(a=e[g("matchHistory",m,t)]||[],a.forEach((e=>{if(e.map){const t=s.get(e.map)||0;s.set(e.map,t+1)}})));const n=document.getElementById("mapFilter"),o=n.value||"all";n.innerHTML='<option value="all">All Maps</option>',Array.from(s.entries()).sort(((e,t)=>t[1]-e[1])).forEach((([e,t])=>{const a=document.createElement("option");a.value=e,a.textContent=e,n.appendChild(a)})),[...n.options].some((e=>e.value===o))?(n.value=o,h=o):(n.value="all",h="all");const l="all"===h?a:a.filter((e=>e.map===h));let d=0,u=0,p=0;l.forEach((e=>{d+=e.kills||0,u+=e.deaths||0,p+=e.duration||(e.matchEndTime&&e.matchStartTime?e.matchEndTime-e.matchStartTime:0)}));let y=0;"all"===t?["normal","special","custom"].forEach((t=>{y+=e[g("gamesQuit",m,t)]||0})):y=e[g("gamesQuit",m,t)]||0,console.log("[SKMT][DISPLAY] Current gamesQuit value:",y,"Mode:",t),document.getElementById("gamesQuit").textContent=y;const k=document.getElementById("mapsList");k.innerHTML="";const E=Array.from(s.entries()).sort(((e,t)=>t[1]-e[1]));if(E.forEach((([e,t])=>{const a=document.createElement("div");a.className="stat-card",a.innerHTML=`\n            <span class="stat-label">${e}</span>\n            <span class="stat-value">${t}</span>\n        `,k.appendChild(a)})),0===E.length){const e=document.createElement("div");e.className="no-maps",e.textContent="No maps played yet in this mode",k.appendChild(e)}let f=0,v=0,M=0,T=0,B=0,I=0,b=0,C=0,x=0,w=0,$=0,P=0,K=0,D=0,U=0,H=0,A=0,z=0,F=0,O=0,R=0,q=0;l.forEach((e=>{e.kills>T&&(T=e.kills),e.deaths>B&&(B=e.deaths);const t=e.deaths>0?e.kills/e.deaths:e.kills;t>b&&(b=t);const a=e.duration||(e.matchEndTime&&e.matchStartTime?e.matchEndTime-e.matchStartTime:0);if(a>C&&(C=a),e.killTimestamps&&e.killTimestamps.length>0){let t=0,a=0;const s=[];e.killTimestamps&&e.killTimestamps.forEach((e=>s.push({type:"kill",time:e}))),e.deathTimestamps&&e.deathTimestamps.forEach((e=>s.push({type:"death",time:e}))),s.sort(((e,t)=>e.time-t.time)),s.forEach((e=>{"death"===e.type?(t>a&&(a=t),t=0):"kill"===e.type&&(t++,t>a&&(a=t))})),a>I&&(I=a)}let s=0,n=null,o=0,l={};const i=[];e.killTimestamps&&e.killTimestamps.forEach((e=>i.push({type:"kill",time:e}))),e.deathTimestamps&&e.deathTimestamps.forEach((e=>i.push({type:"death",time:e}))),i.sort(((e,t)=>e.time-t.time)),i.forEach((e=>{"death"===e.type?(s=0,l={},o=0,n=null):"kill"===e.type&&(s++,s>=3&&!l[3]&&(x++,l[3]=!0),s>=5&&!l[5]&&(w++,l[5]=!0),s>=7&&!l[7]&&($++,l[7]=!0),s>=10&&!l[10]&&(P++,l[10]=!0),s>=15&&!l[15]&&(K++,l[15]=!0),s>=20&&!l[20]&&(D++,l[20]=!0),s>=25&&!l[25]&&(U++,l[25]=!0),s>=30&&!l[30]&&(H++,l[30]=!0),null===n?(o=1,n=e.time):(e.time-n<=4e3?(o++,2===o&&A++,3===o&&z++,4===o&&F++,5===o&&O++,6===o&&R++,7===o&&q++):o=1,n=e.time))})),e.joined&&f++,e.started&&v++,e.quit&&y++,e.quit||M++})),document.getElementById("highestKillsRecord").textContent=T,document.getElementById("highestDeathsRecord").textContent=B,document.getElementById("highestKillStreakRecord").textContent=I,document.getElementById("highestKDRRecord").textContent=b.toFixed(2),document.getElementById("longestTimePlayedRecord").textContent=c(C),document.getElementById("smashStreak").textContent=x,document.getElementById("smashtacularStreak").textContent=w,document.getElementById("smashosaurusStreak").textContent=$,document.getElementById("smashlvaniaStreak").textContent=P,document.getElementById("monsterSmashStreak").textContent=K,document.getElementById("potatoStreak").textContent=D,document.getElementById("smashSmashStreak").textContent=U,document.getElementById("potoatachioStreak").textContent=H,document.getElementById("doubleSmash").textContent=A,document.getElementById("multiSmash").textContent=z,document.getElementById("multiMegaSmash").textContent=F,document.getElementById("multiMegaUltraSmash").textContent=O,document.getElementById("gooseySmash").textContent=R,document.getElementById("crazyMultiMegaUltraSmash").textContent=q,document.getElementById("streaksHeader").textContent="all"===t?"All Modes Streaks (Without Dying)":"Streaks (Without Dying)",document.getElementById("quickKillsHeader").textContent="all"===t?"All Modes Streaks (Quick Kills)":"Streaks (Quick Kills)";const _=(M||0)+(y||0);document.getElementById("killsLabel").textContent="all"===t?"Total Kills":"Kills",document.getElementById("deathsLabel").textContent="all"===t?"Total Deaths":"Deaths",document.getElementById("kdrLabel").textContent="all"===t?"Overall KDR":"KDR",document.getElementById("matchesCompletedLabel").textContent="all"===t?"Total Matches Completed":"Matches Completed",document.getElementById("totalTimeSpentLabel").textContent="all"===t?"Total Time Played":"Time Played",document.getElementById("gamesJoinedLabel").textContent="all"===t?"Total Matches Joined":"Matches Joined",document.getElementById("totalMatchesLabel").textContent="Total Matches (Completed + Quit)",console.log("[SKMT][POPUP][DISPLAY] Updating gamesQuit display. Value:",y,"Element:",document.getElementById("gamesQuit")),document.getElementById("kills").textContent=d,document.getElementById("deaths").textContent=u,document.getElementById("kdr").textContent=r(d,u),document.getElementById("totalTimeSpent").textContent=c(p),document.getElementById("gamesJoined").textContent=f,document.getElementById("gamesStarted").textContent=v,document.getElementById("gamesQuit").textContent=y,document.getElementById("matchesCompleted").textContent=M,document.getElementById("totalMatches").textContent=_;const N=_>0?(M||0)/_*100:0,Q=_>0?(y||0)/_*100:0;document.getElementById("matchesCompletedRate").textContent=`${N.toFixed(2)}%`,document.getElementById("matchesQuitRate").textContent=`${Q.toFixed(2)}%`;const j=l.filter((e=>!e.quit)).length,J=j>0?d/j:0,G=j>0?u/j:0,V=j>0?p/j:0;document.getElementById("avgKills").textContent=J.toFixed(2),document.getElementById("avgDeaths").textContent=G.toFixed(2),document.getElementById("avgTimeSpent").textContent=c(V),document.getElementById("averageStatsHeader").textContent="all"===t?"All Modes Average Stats":"Average Stats",document.getElementById("matches-list").innerHTML="";let W=[];if("all"===t){const t=[];["normal","special","custom"].forEach((a=>{(e[g("matchHistory",m,a)]||[]).forEach((e=>{t.push({...e,mode:a})}))})),W=t}else W=a.slice().reverse();const Y=document.getElementById("matchSortSelect")?document.getElementById("matchSortSelect").value:"recent";"recent"===Y?W.sort(((e,t)=>(t.matchStartTime||0)-(e.matchStartTime||0))):"oldest"===Y?W.sort(((e,t)=>(e.matchStartTime||0)-(t.matchStartTime||0))):"kills"===Y?W.sort(((e,t)=>(t.kills||0)-(e.kills||0))):"favorites"===Y&&(W=W.filter((e=>L[e.matchStartTime])),W.sort(((e,t)=>(t.matchStartTime||0)-(e.matchStartTime||0)))),function(e){const t=document.getElementById("matches-list");t.innerHTML="",e.forEach(((a,s)=>{const n=document.createElement("div");n.className="match-card";const o=document.createElement("div");o.className="match-card-content";const l=document.createElement("div");if(l.className="match-meta",l.textContent=`#${e.length-s} | ${i(a.matchStartTime)} - ${i(a.matchEndTime)}`,o.appendChild(l),a.map){const e=document.createElement("div");e.className="match-map",e.textContent=a.map,o.appendChild(e)}const d=document.createElement("div");d.className="match-stats",d.innerHTML="",d.innerHTML+=`<span>Kills:</span><b>${a.kills}</b>`,d.innerHTML+=`<span>Deaths:</span><b>${a.deaths}</b>`,d.innerHTML+=`<span>KDR:</span><b>${r(a.kills,a.deaths)}</b>`;const h=a.duration||(a.matchEndTime&&a.matchStartTime?a.matchEndTime-a.matchStartTime:0),u=Math.floor(h/36e5),p=Math.floor(h%36e5/6e4),g=Math.floor(h%6e4/1e3);let y;y=u>0?`${u}h ${p}m ${g}s`:`${p}m ${g}s`,d.innerHTML+=`<span>Duration:</span><b>${y}</b>`,o.appendChild(d);const k=document.createElement("div");k.className="match-flags";let E=[];a.joined&&E.push("Joined"),a.started&&E.push("Started"),a.quit?E.push("Quit"):E.push("Completed"),a.isSpecialMode&&E.push("Special Mode"),a.isCustomMode&&E.push("Custom Match"),a.mode&&E.push(`${a.mode.charAt(0).toUpperCase()+a.mode.slice(1)} Mode`),E.length>0&&(k.textContent=E.join(" | ")),o.appendChild(k);const f=document.createElement("button");f.className="star-btn",f.title="Favorite this match",f.innerHTML='<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="10,2 12.59,7.36 18.51,8.09 14,12.26 15.18,18.09 10,15.27 4.82,18.09 6,12.26 1.49,8.09 7.41,7.36" stroke="#FFD700" stroke-width="1.5" fill="'+(a.favorite?"#FFD700":"white")+'"/></svg>',f.style.background="none",f.style.border="none",f.style.cursor="pointer",f.style.marginRight="4px",f.onclick=async()=>{a.favorite=!a.favorite,f.querySelector("polygon").setAttribute("fill",a.favorite?"#FFD700":"white"),a.favorite?L[a.matchStartTime]=!0:delete L[a.matchStartTime],await async function(){const e=`favoriteMatches_${m||"Default"}`;await new Promise((t=>chrome.storage.sync.set({[e]:L},t))),console.log("[SKMT][POPUP] Saved favorite matches to storage.",L)}(),"favorites"===(document.getElementById("matchSortSelect")?document.getElementById("matchSortSelect").value:"recent")&&S()};const v=document.createElement("button");v.className="share-btn",v.title="Share match link",v.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" stroke="#4a90e2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',v.style.background="none",v.style.border="none",v.style.cursor="pointer",v.style.marginRight="4px",v.onclick=()=>{const e=[];a.joined&&e.push("Joined"),a.started&&e.push("Started"),a.quit?e.push("Quit"):e.push("Completed"),a.isSpecialMode&&e.push("Special Mode"),a.isCustomMode&&e.push("Custom Match"),a.mode&&e.push(`${a.mode.charAt(0).toUpperCase()+a.mode.slice(1)} Mode`);const t=a.highestKillStreak||0,s={smashStreak:a.smashStreak||0,smashtacularStreak:a.smashtacularStreak||0,smashosaurusStreak:a.smashosaurusStreak||0,smashlvaniaStreak:a.smashlvaniaStreak||0,monsterSmashStreak:a.monsterSmashStreak||0,potatoStreak:a.potatoStreak||0,smashSmashStreak:a.smashSmashStreak||0,potoatachioStreak:a.potoatachioStreak||0},n={quickKillStreak:a.quickKillStreak||0,quickKillStreak2:a.quickKillStreak2||0,quickKillStreak3:a.quickKillStreak3||0,quickKillStreak4:a.quickKillStreak4||0,quickKillStreak5:a.quickKillStreak5||0},o={id:a.id,timestamp:a.matchStartTime,map:a.map,mode:a.isSpecialMode?"special":a.isCustomMode?"custom":"normal",kills:a.kills,deaths:a.deaths,duration:a.duration,players:a.players,indicators:e,highestKillStreak:t,streaksWithoutDying:s,quickKillsStreaks:n,startTime:a.matchStartTime||a.startTime,endTime:a.matchEndTime||a.endTime,statusIndicators:e},l=`https://leafbolt8.github.io/Kart-Companion/match-viewer.html?match=${btoa(JSON.stringify(o))}`;navigator.clipboard.writeText(l).then((()=>{const e=document.createElement("div");e.textContent="Link copied!",e.style.position="fixed",e.style.backgroundColor="#4a90e2",e.style.color="white",e.style.padding="8px 12px",e.style.borderRadius="4px",e.style.fontSize="14px",e.style.zIndex="10000",e.style.top="10px",e.style.left="50%",e.style.transform="translateX(-50%)",document.body.appendChild(e),setTimeout((()=>{document.body.removeChild(e)}),2e3)}))};const M=document.createElement("button");M.className="info-btn",M.title="View match information",M.innerHTML='<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="9" stroke="#3498db" stroke-width="2" fill="white"/><rect x="9" y="8" width="2" height="6" rx="1" fill="#3498db"/><rect x="9" y="5" width="2" height="2" rx="1" fill="#3498db"/></svg>',M.onclick=()=>function(e){const t=document.getElementById("matchInfoModal"),a=document.getElementById("match-info-modal-body");let s=[];e.joined&&s.push("Joined"),e.started&&s.push("Started"),e.quit?s.push("Quit"):s.push("Completed"),e.isSpecialMode&&s.push("Special Mode"),e.isCustomMode&&s.push("Custom Match"),e.mode&&s.push(`${e.mode.charAt(0).toUpperCase()+e.mode.slice(1)} Mode`);const n=e.duration||(e.matchEndTime&&e.matchStartTime?e.matchEndTime-e.matchStartTime:0);let o=0,l={smashStreak:0,smashtacularStreak:0,smashosaurusStreak:0,smashlvaniaStreak:0,monsterSmashStreak:0,potatoStreak:0,smashSmashStreak:0,potoatachioStreak:0},m={doubleSmash:0,multiSmash:0,multiMegaSmash:0,multiMegaUltraSmash:0,gooseySmash:0,crazyMultiMegaUltraSmash:0};if(e.killTimestamps&&e.killTimestamps.length>0){let t=0,a=0,s=0,n=null,i={};const r=[];e.killTimestamps&&e.killTimestamps.forEach((e=>r.push({type:"kill",time:e}))),e.deathTimestamps&&e.deathTimestamps.forEach((e=>r.push({type:"death",time:e}))),r.sort(((e,t)=>e.time-t.time)),r.forEach((e=>{"death"===e.type?(t>a&&(a=t),t=0,i={},s=0,n=null):"kill"===e.type&&(t++,t>a&&(a=t),t>=3&&!i[3]&&(l.smashStreak++,i[3]=!0),t>=5&&!i[5]&&(l.smashtacularStreak++,i[5]=!0),t>=7&&!i[7]&&(l.smashosaurusStreak++,i[7]=!0),t>=10&&!i[10]&&(l.smashlvaniaStreak++,i[10]=!0),t>=15&&!i[15]&&(l.monsterSmashStreak++,i[15]=!0),t>=20&&!i[20]&&(l.potatoStreak++,i[20]=!0),t>=25&&!i[25]&&(l.smashSmashStreak++,i[25]=!0),t>=30&&!i[30]&&(l.potoatachioStreak++,i[30]=!0),null===n?(s=1,n=e.time):(e.time-n<=4e3?(s++,2===s&&m.doubleSmash++,3===s&&m.multiSmash++,4===s&&m.multiMegaSmash++,5===s&&m.multiMegaUltraSmash++,6===s&&m.gooseySmash++,7===s&&m.crazyMultiMegaUltraSmash++):s=1,n=e.time))})),o=a}let d=[];Array.isArray(e.players)&&(d=[...new Set(e.players)]),a.innerHTML=`\n        <div class="match-info-title">Match Information</div>\n        ${e.map?`<div class="match-info-section"><span class="match-info-label">Map:</span><span class="match-info-value">${e.map}</span></div>`:""}\n        <div class="match-info-section"><span class="match-info-label">Start:</span><span class="match-info-value">${i(e.matchStartTime)}</span></div>\n        <div class="match-info-section"><span class="match-info-label">End:</span><span class="match-info-value">${i(e.matchEndTime)}</span></div>\n        <div class="match-info-section"><span class="match-info-label">Kills:</span><span class="match-info-value">${e.kills}</span></div>\n        <div class="match-info-section"><span class="match-info-label">Deaths:</span><span class="match-info-value">${e.deaths}</span></div>\n        <div class="match-info-section"><span class="match-info-label">KDR:</span><span class="match-info-value">${r(e.kills,e.deaths)}</span></div>\n        <div class="match-info-section"><span class="match-info-label">Duration:</span><span class="match-info-value">${c(n)}</span></div>\n        <div class="match-info-section"><span class="match-info-label">Highest Kill Streak:</span><span class="match-info-value">${o}</span></div>\n        \n        ${Object.values(l).some((e=>e>0))?`\n        <div class="match-info-section">\n            <span class="match-info-label" style="display:block;margin-bottom:6px;">Streaks (Without Dying):</span>\n            <ul style="margin:0 0 0 12px;padding:0;list-style:disc;">\n                ${l.smashStreak>0?`<li style='font-size:16px;'>Smash Streak (3): ${l.smashStreak}</li>`:""}\n                ${l.smashtacularStreak>0?`<li style='font-size:16px;'>Smashtacular Streak (5): ${l.smashtacularStreak}</li>`:""}\n                ${l.smashosaurusStreak>0?`<li style='font-size:16px;'>Smashosaurus Streak (7): ${l.smashosaurusStreak}</li>`:""}\n                ${l.smashlvaniaStreak>0?`<li style='font-size:16px;'>Smashlvania Streak (10): ${l.smashlvaniaStreak}</li>`:""}\n                ${l.monsterSmashStreak>0?`<li style='font-size:16px;'>Monster Smash Streak (15): ${l.monsterSmashStreak}</li>`:""}\n                ${l.potatoStreak>0?`<li style='font-size:16px;'>Potato Streak (20): ${l.potatoStreak}</li>`:""}\n                ${l.smashSmashStreak>0?`<li style='font-size:16px;'>Smash Smash Streak (25): ${l.smashSmashStreak}</li>`:""}\n                ${l.potoatachioStreak>0?`<li style='font-size:16px;'>Potoatachio Streak (30): ${l.potoatachioStreak}</li>`:""}\n            </ul>\n        </div>\n        `:""}\n\n        ${Object.values(m).some((e=>e>0))?`\n        <div class="match-info-section">\n            <span class="match-info-label" style="display:block;margin-bottom:6px;">Streaks (Quick Kills):</span>\n            <ul style="margin:0 0 0 12px;padding:0;list-style:disc;">\n                ${m.doubleSmash>0?`<li style='font-size:16px;'>Double Smash (2): ${m.doubleSmash}</li>`:""}\n                ${m.multiSmash>0?`<li style='font-size:16px;'>Multi Smash (3): ${m.multiSmash}</li>`:""}\n                ${m.multiMegaSmash>0?`<li style='font-size:16px;'>Multi Mega Smash (4): ${m.multiMegaSmash}</li>`:""}\n                ${m.multiMegaUltraSmash>0?`<li style='font-size:16px;'>Multi Mega Ultra Smash (5): ${m.multiMegaUltraSmash}</li>`:""}\n                ${m.gooseySmash>0?`<li style='font-size:16px;'>Goosey Smash (6): ${m.gooseySmash}</li>`:""}\n                ${m.crazyMultiMegaUltraSmash>0?`<li style='font-size:16px;'>Crazy Multi Mega Ultra Smash (7): ${m.crazyMultiMegaUltraSmash}</li>`:""}\n            </ul>\n        </div>\n        `:""}\n\n        <div class="match-info-section">\n            <span class="match-info-label" style="display:block;margin-bottom:6px;">Detected Players In Room:</span>\n            <ul style="margin:0 0 0 12px;padding:0;list-style:disc;">\n                ${d.length>0?d.map((e=>`<li style='font-size:16px;'>${e}</li>`)).join(""):'<li style="color:#aaa;font-size:16px;">No players detected</li>'}\n            </ul>\n        </div>\n        <div class="match-info-indicators">${s.join(" | ")}</div>\n    `,t.style.display="flex"}(a),n.appendChild(o),n.appendChild(f),n.appendChild(v),n.appendChild(M),t.appendChild(n)}))}(W)}(e,d)}))}))}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("skidValue"),t=document.getElementById("toggleSkidBtn"),a=document.getElementById("copySkidBtn");chrome.storage.sync.get(["skidBlurred"],(a=>{if(a.skidBlurred){e.classList.add("skid-blurred");const a=t.querySelector("i");a.classList.remove("fa-eye"),a.classList.add("fa-eye-slash")}})),t.addEventListener("click",(()=>{e.classList.toggle("skid-blurred");const a=t.querySelector("i");e.classList.contains("skid-blurred")?(a.classList.remove("fa-eye"),a.classList.add("fa-eye-slash"),chrome.storage.sync.set({skidBlurred:!0})):(a.classList.remove("fa-eye-slash"),a.classList.add("fa-eye"),chrome.storage.sync.set({skidBlurred:!1}))})),a.addEventListener("click",(()=>{const t=e.textContent;t&&"-"!==t&&navigator.clipboard.writeText(t).then((()=>{const e=a.getAttribute("title");a.setAttribute("title","Copied!");const t=a.querySelector("i");t.classList.remove("fa-copy"),t.classList.add("fa-check"),setTimeout((()=>{a.setAttribute("title",e),t.classList.remove("fa-check"),t.classList.add("fa-copy")}),2e3)}))})),document.getElementById("normalModeBtn").addEventListener("click",(()=>{d="normal",y(),S()})),document.getElementById("specialModeBtn").addEventListener("click",(()=>{d="special",y(),S()})),document.getElementById("customModeBtn").addEventListener("click",(()=>{d="custom",y(),S()})),document.getElementById("allStatsBtn").addEventListener("click",(()=>{d="all",y(),S()})),p&&p.addEventListener("click",(()=>{const e=p.dataset.targetUrl;e&&chrome.tabs.create({url:e})})),document.querySelectorAll(".stats-details").forEach((e=>{e.addEventListener("toggle",(()=>{document.querySelectorAll(".stats-details").forEach((e=>{const t=e.querySelector(".stats-section-label").id;u[t]=e.hasAttribute("open")})),chrome.storage.local.set({openSections:u})}))})),document.getElementById("exportStatsBtn").addEventListener("click",I),document.getElementById("importStatsBtn").addEventListener("click",(()=>{document.getElementById("importStatsInput").click()})),document.getElementById("importStatsInput").addEventListener("change",(e=>{e.target.files.length>0&&(async function(e){try{const t=new FileReader;t.onload=async function(e){try{const t=(new TextDecoder).decode(e.target.result),a=await async function(e){try{await B();const t=e.match(/^SKMT_ENCRYPTED_v(\d+\.\d+)_(.+)$/);if(!t)throw new Error("Invalid encrypted data format");if(t[1]!==M)throw new Error("Incompatible encryption version");const a=t[2],s=new Uint8Array(atob(a).split("").map((e=>e.charCodeAt(0)))),n=s.slice(0,12),o=s.slice(12),l=await crypto.subtle.decrypt({name:"AES-GCM",iv:n},T,o),i=new TextDecoder;return JSON.parse(i.decode(l))}catch(e){throw console.error("Decryption error:",e),new Error("Failed to decrypt data")}}(t);if(a.skid!==m)throw new Error("Stats file SKID does not match current SKID");const s=31536e6;if(Date.now()-a.timestamp>s)throw new Error("Stats file is too old");if(!confirm("Are you sure you want to import these stats? This will overwrite your current stats."))return;if(await new Promise((e=>{chrome.storage.sync.set(a.data,e)})),a.data.uiState){const e=a.data.uiState;e.currentMode&&(d=e.currentMode,document.querySelectorAll(".mode-btn").forEach((e=>{e.classList.toggle("active",e.dataset.mode===d)}))),e.openSections&&await new Promise((t=>{chrome.storage.local.set({openSections:e.openSections},t)}))}S(),alert("Stats imported successfully!")}catch(e){console.error("Error processing imported stats:",e),alert(e.message||"Failed to import stats. The file may be corrupted or invalid.")}},t.onerror=function(){alert("Error reading file. Please try again.")},t.readAsArrayBuffer(e)}catch(e){console.error("Error importing stats:",e),alert("Failed to import stats. Please try again.")}}(e.target.files[0]),e.target.value="")})),document.getElementById("visualizeStatsBtn").addEventListener("click",(()=>{console.log("[SKMT] Visualize Stats button clicked");const e=document.getElementById("visualizeStatsBtn");e.disabled=!0;try{chrome.runtime.sendMessage({type:"OPEN_VISUALIZERS"},(t=>(e.disabled=!1,chrome.runtime.lastError?(console.error("[SKMT] Error opening visualizers:",chrome.runtime.lastError),void alert("Failed to open visualizers: "+chrome.runtime.lastError.message)):t?t.success?void console.log("[SKMT] Successfully opened visualizers in tab:",t.tabId):(console.error("[SKMT] Failed to open visualizers:",t.error),void alert("Failed to open visualizers: "+(t.error||"Unknown error"))):(console.error("[SKMT] No response received from background script"),void alert("Failed to open visualizers: No response received")))))}catch(t){e.disabled=!1,console.error("[SKMT] Error sending message:",t),alert("Failed to open visualizers: "+t.message)}})),document.getElementById("resetStatsBtn").addEventListener("click",(function(){if(!m)return;const e=[],t="all"===d?["normal","special","custom"]:[d];if(confirm(`Are you sure you want to reset all stats and match history for ${"all"===d?"all modes":"this mode"} and SKID?`)){t.forEach((t=>{e.push(g("matchHistory",m,t)),e.push(g("gamesJoined",m,t)),e.push(g("gamesStarted",m,t)),e.push(g("gamesQuit",m,t)),e.push(g("matchesCompleted",m,t))}));const a={};e.forEach((e=>a[e]=e.includes("matchHistory")?[]:0)),chrome.storage.sync.set(a,(()=>{console.log("[SKMT][RESET] Stats reset for",t,"mode(s)."),S()}))}})),y(),S(),chrome.storage.local.get(["openSections"],(e=>{e.openSections&&(u=e.openSections,Object.entries(u).forEach((([e,t])=>{const a=document.querySelector(`.stats-details:has(#${e})`);a&&(t?a.setAttribute("open",""):a.removeAttribute("open"))})))}));const s=document.getElementById("moreDetailsBtn");s&&s.addEventListener("click",(()=>{chrome.tabs.create({url:"match-history.html"})}))})),chrome.storage.onChanged.addListener(((e,t)=>{"sync"===t&&(e[`favoriteMatches_${m||"Default"}`]?(console.log("[SKMT][POPUP] Favorite matches changed in storage, reloading stats."),S()):m&&Object.keys(e).some((e=>e.includes(`_${m}_`)))&&S())}));const k=1e3;async function E(e,t){return new Promise((a=>{chrome.storage.sync.get([g("matchHistory",m,e)],(s=>{const n=s[g("matchHistory",m,e)]||[],o=n[n.length-1],l=o&&o.matchEndTime===t.matchEndTime&&o.kills===t.kills&&o.deaths===t.deaths;a(l)}))}))}async function f(){console.log("[SKMT][POPUP] Forcing stats refresh"),await S()}async function v(e,t=0){return new Promise(((a,s)=>{const n=setTimeout((()=>{t<3?(console.log(`[SKMT][POPUP] Message port timeout, retrying (${t+1}/3)...`),setTimeout((()=>{v(e,t+1).then(a).catch(s)}),1e3)):s(new Error("Message port timeout after all retries"))}),5e3);chrome.runtime.sendMessage(e,(o=>{clearTimeout(n),chrome.runtime.lastError?(console.error("[SKMT][POPUP] Message port error:",chrome.runtime.lastError),t<3?(console.log(`[SKMT][POPUP] Retrying message (${t+1}/3)...`),setTimeout((()=>{v(e,t+1).then(a).catch(s)}),1e3)):s(chrome.runtime.lastError)):a(o)}))}))}chrome.runtime.onMessage.addListener((function(e,t,a){if("SKMT_SKID_UPDATED"===e.type)return S(),a({success:!0}),!0;if("SKMT_MATCH_COMPLETE"===e.type){console.log("[SKMT][POPUP] Received MATCH_COMPLETE message:",e.data);const t=e.data,a=t.isSpecialMode?"special":t.isCustomMode?"custom":"normal",s=m||"Default",n=g("gamesQuit",s,a);if(t.quit){const e=t.matchEndTime-t.matchStartTime;if(e>=1e4){let e=0;const s=async()=>{try{let o=(await new Promise((e=>{chrome.storage.sync.get([n],e)})))[n]||0;o++;const l={};l[n]=o,await new Promise((e=>{chrome.storage.sync.set(l,e)}));const i=await E(a,t);if(!i&&e<3)return e++,console.log(`[SKMT][POPUP] Retry ${e} for quit stats update`),void setTimeout(s,k);i?S():(console.log("[SKMT][POPUP] Stats update verification failed, forcing refresh"),await f());try{await v({success:!0})}catch(e){console.error("[SKMT][POPUP] Error sending response:",e)}}catch(t){if(console.error("[SKMT][POPUP] Error updating quit stats:",t),e<3)e++,setTimeout(s,k);else{await f();try{await v({success:!1,error:t.message})}catch(e){console.error("[SKMT][POPUP] Error sending error response:",e)}}}};s()}else{console.log("[SKMT][POPUP] Not incrementing gamesQuit - time spent less than 10 seconds:",e),S();try{v({success:!0})}catch(e){console.error("[SKMT][POPUP] Error sending response:",e)}}}else{let e=0;const n=async()=>{try{const o=g("matchHistory",s,a),l=g("gamesJoined",s,a),i=g("gamesStarted",s,a),r=g("matchesCompleted",s,a),c=await new Promise((e=>{chrome.storage.sync.get([o,l,i,r],e)}));let m=c[o]||[];m.push(t);let d=c[l]||0,h=c[i]||0,u=c[r]||0;t.joined&&d++,t.started&&h++,u++;const p={[o]:m,[l]:d,[i]:h,[r]:u};await new Promise((e=>{chrome.storage.sync.set(p,e)}));const y=await E(a,t);if(!y&&e<3)return e++,console.log(`[SKMT][POPUP] Retry ${e} for match stats update`),void setTimeout(n,k);y?S():(console.log("[SKMT][POPUP] Stats update verification failed, forcing refresh"),await f());try{await v({success:!0})}catch(e){console.error("[SKMT][POPUP] Error sending response:",e)}}catch(t){if(console.error("[SKMT][POPUP] Error updating match stats:",t),e<3)e++,setTimeout(n,k);else{await f();try{await v({success:!1,error:t.message})}catch(e){console.error("[SKMT][POPUP] Error sending error response:",e)}}}};n()}return!0}if("SKMT_DEATHS_UPDATE"===e.type){document.getElementById("deaths").textContent=e.deaths;const t=parseInt(document.getElementById("kills").textContent)||0;return document.getElementById("kdr").textContent=r(t,e.deaths),a({success:!0}),!0}return"SKMT_KILLSTREAK_UPDATE"===e.type?(document.getElementById("killStreak").textContent=e.killStreak,a({success:!0}),!0):void 0}));const M="1.4";let T=null;async function B(){return T||(T=await async function(){const e=(new TextEncoder).encode("SKMT_SECURE_SALT_v1.4"),t=await crypto.subtle.digest("SHA-256",e);return await crypto.subtle.importKey("raw",t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}()),T}async function I(){try{const e=["normal","special","custom"],t=["currentSkid"];e.forEach((e=>{t.push(g("matchHistory",m,e)),t.push(g("gamesJoined",m,e)),t.push(g("gamesStarted",m,e)),t.push(g("gamesQuit",m,e)),t.push(g("matchesCompleted",m,e))}));const a=await new Promise((e=>{chrome.storage.sync.get(t,e)})),s=await new Promise((e=>{chrome.storage.local.get(["openSections"],e)})),n={};e.forEach((e=>{const t=a[g("matchHistory",m,e)]||[];let s=0,o=0,l=0,i=0,r=0,c=0,d=0,h=0,u=0,p=0,y=0,S=0,k=0,E=0,f=0,v=0,M=0,T=0;t.forEach((e=>{e.kills>=3&&s++,e.kills>=5&&o++,e.kills>=7&&l++,e.kills>=10&&i++,e.kills>=15&&r++,e.kills>=20&&c++,e.kills>=25&&d++,e.kills>=30&&h++,e.kills>f&&(f=e.kills),e.deaths>v&&(v=e.deaths);const t=e.deaths>0?e.kills/e.deaths:e.kills;if(t>T&&(T=t),e.killTimestamps&&e.killTimestamps.length>0){let t=0,a=0;const s=[];e.killTimestamps&&e.killTimestamps.forEach((e=>s.push({type:"kill",time:e}))),e.deathTimestamps&&e.deathTimestamps.forEach((e=>s.push({type:"death",time:e}))),s.sort(((e,t)=>e.time-t.time)),s.forEach((e=>{"death"===e.type?(t>a&&(a=t),t=0):"kill"===e.type&&(t++,t>a&&(a=t))})),a>M&&(M=a)}if(e.killTimestamps&&e.killTimestamps.length>0){let t=0,a=e.killTimestamps[0];for(let s=1;s<e.killTimestamps.length;s++){const n=e.killTimestamps[s];n-a<=4e3?(t++,2===t&&u++,3===t&&p++,4===t&&y++,5===t&&S++,6===t&&k++,7===t&&E++):t=1,a=n}}})),n[e]={smashStreak:s,smashtacularStreak:o,smashosaurusStreak:l,smashlvaniaStreak:i,monsterSmashStreak:r,potatoStreak:c,smashSmashStreak:d,potoatachioStreak:h,doubleSmash:u,multiSmash:p,multiMegaSmash:y,multiMegaUltraSmash:S,gooseySmash:k,crazyMultiMegaUltraSmash:E,highestKillsRecord:f,highestDeathsRecord:v,highestKillStreakRecord:M,highestKDRRecord:T}})),a.stats=n,a.uiState={currentMode:d,openSections:s.openSections||{},skid:m};const o={version:M,timestamp:Date.now(),skid:m,data:a},l=await async function(e){try{await B();const t=crypto.getRandomValues(new Uint8Array(12)),a=(new TextEncoder).encode(JSON.stringify(e)),s=await crypto.subtle.encrypt({name:"AES-GCM",iv:t},T,a),n=new Uint8Array(t.length+s.byteLength);n.set(t),n.set(new Uint8Array(s),t.length);const o=btoa(String.fromCharCode.apply(null,n));return`SKMT_ENCRYPTED_v${M}_${o}`}catch(e){throw console.error("Encryption error:",e),new Error("Failed to encrypt data")}}(o),i=new Blob([l],{type:"application/octet-stream"}),r=URL.createObjectURL(i),c=document.createElement("a");c.href=r,c.download=`smash_karts_stats_${m}_${(new Date).toISOString().split("T")[0]}.skmt`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r)}catch(e){console.error("Error exporting stats:",e),alert("Failed to export stats. Please try again.")}}document.getElementById("closeMatchInfoModal")&&(document.getElementById("closeMatchInfoModal").onclick=function(){document.getElementById("matchInfoModal").style.display="none"}),document.getElementById("matchInfoModal")&&(document.getElementById("matchInfoModal").onclick=function(e){e.target===this&&(this.style.display="none")});let b=null;function C(){const e=document.getElementById("hudSettingsModal"),t=document.getElementById("hudSettingsTitle");let a="";switch(b){case"deaths":a="Deaths";break;case"killstreak":a="Kill Streak";break;case"kdr":a="KDR"}t.textContent=`${a} HUD Settings`;const s=`${b}HudSettings`;chrome.storage.sync.get([s],(e=>{const t=e[s]||{fontSize:32,fontColor:"#ffffff",fontFamily:"Arial, sans-serif",backgroundColor:"rgba(0, 0, 0, 0.5)"};document.getElementById("hudFontSize").value=t.fontSize,document.getElementById("fontSizeValue").textContent=`${t.fontSize}px`,document.getElementById("hudFontColor").value=t.fontColor,document.getElementById("hudFontFamily").value=t.fontFamily,document.getElementById("hudBackgroundColor").value=t.backgroundColor?function(e){const t=e.substring(e.indexOf("(")+1,e.indexOf(")")).split(",");return`#${((1<<24)+(parseInt(t[0].trim())<<16)+(parseInt(t[1].trim())<<8)+parseInt(t[2].trim())).toString(16).slice(1).toUpperCase()}`}(t.backgroundColor):"#000000"})),e.style.display="flex"}function x(){const e={fontSize:document.getElementById("hudFontSize").value,fontColor:document.getElementById("hudFontColor").value,fontFamily:document.getElementById("hudFontFamily").value,backgroundColor:w(document.getElementById("hudBackgroundColor").value,.5)},t=`${b}HudSettings`;chrome.storage.sync.set({[t]:e}),chrome.tabs.query({active:!0,currentWindow:!0},(t=>{let a;switch(b){case"deaths":a="update-deaths-hud-style";break;case"killstreak":a="update-killstreak-hud-style";break;case"kdr":a="update-kdr-hud-style"}chrome.tabs.sendMessage(t[0].id,{type:a,settings:e})}))}function w(e,t){const a=parseInt(e.slice(1),16);return`rgba(${a>>16&255}, ${a>>8&255}, ${255&a}, ${t})`}document.getElementById("deathsHudSettings").addEventListener("click",(()=>{b="deaths",C()})),document.getElementById("killStreakHudSettings").addEventListener("click",(()=>{b="killstreak",C()})),document.getElementById("kdrHudSettings").addEventListener("click",(()=>{b="kdr",C()})),document.getElementById("closeHudSettingsModal").addEventListener("click",(()=>{document.getElementById("hudSettingsModal").style.display="none"})),document.getElementById("hudSettingsModal").addEventListener("click",(e=>{e.target===document.getElementById("hudSettingsModal")&&(document.getElementById("hudSettingsModal").style.display="none")})),document.getElementById("hudFontSize").addEventListener("input",(e=>{const t=e.target.value;document.getElementById("fontSizeValue").textContent=`${t}px`,x()})),document.getElementById("hudFontColor").addEventListener("change",x),document.getElementById("hudFontFamily").addEventListener("change",x),document.getElementById("hudBackgroundColor").addEventListener("input",x);let L={};document.getElementById("matchSortSelect")&&document.getElementById("matchSortSelect").addEventListener("change",(function(e){S()}))})();